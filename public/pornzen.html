<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PornZen Player Clean Proxy</title>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        body {
            margin: 0;
            background: #0b0b0b;
            color: #fff;
            font-family: Arial, sans-serif;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 8px;
        }

        @media (min-width:768px) {
            .grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        .card {
            background: #1a1a1a;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
        }

        .card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .card h3 {
            font-size: 13px;
            margin: 6px;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            padding: 10px;
        }

        button {
            background: #e50914;
            border: none;
            color: #fff;
            padding: 8px 14px;
            border-radius: 4px;
            cursor: pointer;
        }

    .nav .search-input {
        width: 160px;
        padding: 6px 10px;
        margin: 3px;
        border: none;
        border-radius: 4px;
    }

    .search-url {
        font-size: 12px;
        opacity: .8;
        margin: 6px 10px;
        word-break: break-all;
        display: none;
    }

    .nav span {
        font-size: 12px;
        opacity: 0.85;
        margin-left: 8px;
    }

        #player {
            padding: 10px;
        }

        video {
            width: 100%;
            background: #000;
        }
    </style>
</head>

<body>
    <div class="nav">
       
        <button id="prevBtn" onclick="prevPage()">Prev</button>
        <input id="pageInput" type="number" min="1" placeholder="Page">
        <button onclick="goPage()">Go</button>
        <button id="nextBtn" onclick="nextPage()">Next</button>
        <span id="pageInfo"></span>
    </div>
    <div class="nav">
        <input id="searchInput" class="search-input" type="text" placeholder="Search title">
        <button onclick="searchGo()">Search</button>
         <button onclick="goBack()">Back</button>
    </div>
    <div id="searchUrl" class="search-url"></div>
    <pre id="searchResponse" class="search-url" style="white-space: pre-wrap; max-height: 220px; overflow: auto;"></pre>

    <div id="player"></div>
    <div id="posts" class="grid"></div>


    <script>
        let page = 1;
        let searchTerm = "";
        let totalPages = 1;
        const postsEl = document.getElementById("posts");
        const playerEl = document.getElementById("player");
        const searchInput = document.getElementById("searchInput");
        const pageInfo = document.getElementById("pageInfo");
        const searchUrl = document.getElementById("searchUrl");
        const searchResponse = document.getElementById("searchResponse");
        const pageInput = document.getElementById("pageInput");
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");

        // Worker proxy
        const PROXY = "https://pornzen.httpsfree-tvsdjjnworkersdev.workers.dev/?url=";

        // Load posts from PornZen
        function extractTotalPages(res, data) {
            const headerVal =
                res.headers.get("X-WP-TotalPages") ||
                res.headers.get("x-wp-totalpages") ||
                res.headers.get("X-WP-Totalpages") ||
                res.headers.get("x-wp-total-pages");

            let fromHeaders = Number(headerVal || "0") || 0;
            if (fromHeaders > 0) return fromHeaders;

            // Some proxies wrap headers in JSON payload
            const hdrs = data?.headers || data?._headers || data?.response?.headers;
            if (hdrs) {
                const keys = Object.keys(hdrs);
                const matchKey = keys.find(k => k.toLowerCase() === "x-wp-totalpages" || k.toLowerCase() === "x-wp-total-pages");
                if (matchKey) {
                    const val = Number(hdrs[matchKey] || "0") || 0;
                    if (val > 0) return val;
                }
            }
            return 1;
        }

        async function loadPosts() {
            postsEl.innerHTML = "Loading posts...";
            pageInfo.textContent = `Page ${page} / ${totalPages}`;
            try {
                const q = searchTerm ? `&search=${encodeURIComponent(searchTerm)}` : "";
                const cat = searchTerm ? "" : "&categories=7";
                const apiUrl = `https://pornzen.com/wp-json/wp/v2/posts?per_page=30&page=${page}&_embed${cat}${q}`;
                const res = await fetch(PROXY + encodeURIComponent(apiUrl), {
                    headers: { "Referer": "https://pornzen.com" }
                });
                let posts = await res.json();
                if (posts && typeof posts === "object" && posts.contents) {
                    try { posts = JSON.parse(posts.contents); } catch {}
                }
                totalPages = extractTotalPages(res, posts);
                postsEl.innerHTML = "";
                if (searchTerm) {
                    try { searchResponse.textContent = JSON.stringify(posts, null, 2); } catch { searchResponse.textContent = String(posts); }
                } else {
                    searchResponse.textContent = "";
                }
                if (!Array.isArray(posts) || !posts.length) {
                    postsEl.innerHTML = "No posts found.";
                    updatePageInfo();
                    return;
                }
                posts.forEach(post => {
                    const thumb = getThumb(post);
                    const card = document.createElement("div");
                    card.className = "card";
                    card.innerHTML = `<img src="${thumb || ''}"><h3>${decodeHTML(post.title?.rendered || '')}</h3>`;
                    card.onclick = () => extractStream(post.link, post.title.rendered);
                    postsEl.appendChild(card);
                });
                if (!searchTerm) applyFilter();
                updatePageInfo();
            } catch (e) {
                postsEl.innerHTML = "❌ Failed to load posts";
                console.error(e);
            }
        }

        function applyFilter() {
            const term = (searchInput?.value || "").toLowerCase().trim();
            if (!term) return;
            const cards = postsEl.querySelectorAll(".card");
            cards.forEach(card => {
                const text = (card.textContent || "").toLowerCase();
                card.style.display = text.includes(term) ? "" : "none";
            });
        }

        function updatePageInfo() {
            pageInfo.textContent = `Page ${page} / ${totalPages}`;
            pageInput.value = String(page);
            prevBtn.disabled = page <= 1;
            nextBtn.disabled = page >= totalPages;
        }

        function updateSearchUrl() {
            const term = (searchInput?.value || "").trim();
            if (!term) {
                searchUrl.textContent = "";
                searchResponse.textContent = "";
                return;
            }
            searchUrl.textContent = `Search URL: https://pornzen.com/wp-json/wp/v2/posts?search=${encodeURIComponent(term)}`;
        }

        function searchGo() {
            const term = (searchInput?.value || "").trim();
            searchTerm = term;
            page = 1;
            updateSearchUrl();
            loadPosts();
        }

        function getThumb(post) {
            const embedded = post?._embedded?.["wp:featuredmedia"]?.[0]?.source_url;
            if (embedded) return embedded;
            const og = post?.yoast_head_json?.og_image?.[0]?.url;
            if (og) return og;
            const schema = post?.yoast_head_json?.schema?.["@graph"] || [];
            for (const node of schema) {
                if (node?.thumbnailUrl) return node.thumbnailUrl;
                if (node?.contentUrl && /\\.(jpg|jpeg|png|webp)$/i.test(node.contentUrl)) return node.contentUrl;
            }
            return "";
        }

        function decodeHTML(s) {
            if (!s) return "";
            const t = document.createElement("textarea");
            t.innerHTML = s;
            return t.value;
        }

        let searchTimer;
        function searchLive() {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                const term = (searchInput?.value || "").trim();
                searchTerm = term;
                page = 1;
                updateSearchUrl();
                loadPosts();
            }, 300);
        }

        // Extract and play stream
        async function extractStream(postUrl, title) {
            playerEl.innerHTML = "Extracting & streaming...";
            try {
                const res = await fetch(PROXY + postUrl, {
                    headers: { "Referer": "https://pornzen.com" }
                });
                const html = await res.text();

                // Match iframe URL from player.wilowitty.win
                const match = html.match(/https?:\/\/player\.wilowitty\.win\/play\.php\?url=([^\s"'&]+)/i);
                if (!match) {
                    playerEl.innerHTML = "❌ m3u8 not found";
                    return;
                }

                // Decode the URL to get clean TulipVid .m3u8
                let m3u8Url = decodeURIComponent(match[1]);
                // Sometimes double-encoded, decode again
                m3u8Url = decodeURIComponent(m3u8Url);

                console.log("✅ Clean m3u8 URL:", m3u8Url);

                const proxiedStream = PROXY + m3u8Url;
                // Setup video player
                playerEl.innerHTML = `<h3>${title}</h3><video id="video" controls autoplay playsinline></video>`;
                const video = document.getElementById("video");

                if (Hls.isSupported()) {
                    const hls = new Hls({
                        maxBufferLength: 3600,        // 1 hour buffer
                        maxMaxBufferLength: 7200,     // 2 hours max buffer
                        maxBufferSize: 1024 * 1024 * 1024, // 1 GB buffer
                        maxBufferHole: 0.05,          // tiny gap tolerance
                        startFragPrefetch: true,
                        autoStartLoad: true,
                        xhrSetup: function (xhr, url) {
                            xhr.open('GET', url, true);
                            if (url.endsWith(".ts")) {
                                xhr.setRequestHeader("Referer", "https://player.wilowitty.win/");
                                xhr.setRequestHeader("Origin", "https://player.wilowitty.win/");
                            } else {
                                xhr.setRequestHeader("Referer", "https://pornzen.com/");
                                xhr.setRequestHeader("Origin", "https://pornzen.com/");
                            }
                        }
                    });

                    hls.loadSource(m3u8Url);
                    hls.attachMedia(video);

                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        console.log("Manifest parsed, starting ultra fast preloading...");
                        video.play();
                        hls.startLoad(0); // aggressively load from start
                    });

                    // Keep aggressively preloading fragments
                    hls.on(Hls.Events.FRAG_BUFFERED, () => {
                        hls.startLoad();
                    });

                    // Optional: log buffering progress
                    hls.on(Hls.Events.BUFFER_APPENDING, (event, data) => {
                        console.log("Appending fragment:", data.frag.sn);
                    });

                } else {
                    // Safari native HLS fallback
                    video.src = m3u8Url;
                }
            } catch (e) {
                playerEl.innerHTML = "❌ Failed to extract stream";
                console.error(e);
            }

        }
        function nextPage() { if (page < totalPages) { page++; loadPosts(); } }
        function prevPage() { if (page > 1) { page--; loadPosts(); } }
        function goPage() {
            const p = parseInt(pageInput.value, 10);
            if (!p) return;
            if (p >= 1 && p <= totalPages) { page = p; loadPosts(); }
        }

        if (searchInput) {
            searchInput.addEventListener("input", searchLive);
        }

        loadPosts();


        /* ================= BACK BUTTON SUPPORT ================= */

        function goBack() {
            history.back();
        }

    </script>

</body>

</html>
