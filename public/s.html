<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Stream Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css">
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar / Grid */
        #sidebar { width: 350px; display: flex; flex-direction: column; border-right: 1px solid #333; background: #111; }
        #search-box { padding: 15px; border-bottom: 1px solid #333; }
        #search-input { width: 100%; padding: 10px; background: #222; border: none; color: white; border-radius: 4px; }
        #channel-list { flex: 1; overflow-y: auto; }
        
        .channel-item { padding: 10px 15px; display: flex; align-items: center; cursor: pointer; border-bottom: 1px solid #222; transition: 0.2s; }
        .channel-item:hover { background: #222; }
        .channel-item.active { background: #0078ff; }
        .channel-item img { width: 50px; height: 30px; object-fit: contain; margin-right: 10px; background: #000; }
        .channel-info { display: flex; flex-direction: column; }
        .channel-name { font-weight: bold; font-size: 14px; }
        .channel-type { font-size: 11px; color: #aaa; }

        /* Player Area */
        #player-area { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #000; }
        #video-container { width: 100%; height: 100%; position: relative; }
        video { width: 100%; height: 100%; }
        
        /* Error/Status Overlay */
        #status-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; background: rgba(0,0,0,0.8); border-radius: 8px; display: none; text-align: center; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div id="search-box">
            <input type="text" id="search-input" placeholder="Search Channels..." onkeyup="filterList()">
        </div>
        <div id="channel-list">
            <div style="padding:20px; text-align:center;">Loading Playlist...</div>
        </div>
    </div>

    <div id="player-area">
        <div id="video-container" data-shaka-player-container>
            <video autoplay data-shaka-player id="video"></video>
        </div>
        <div id="status-msg"></div>
    </div>

    <script>
        let allChannels = [];
        let player = null;
        let ui = null;

        document.addEventListener('DOMContentLoaded', loadPlaylist);

        async function loadPlaylist() {
            try {
                // Fetch the M3U
                const res = await fetch('https://raw.githubusercontent.com/ascal-dev/matchlinks-jsontom3u/main/JTV-drm.m3u');
                const text = await res.text();
                allChannels = parseM3U(text);
                renderList(allChannels);
            } catch (e) {
                document.getElementById('channel-list').innerHTML = `<div style="padding:20px; color:red;">Failed to load playlist: ${e.message}</div>`;
            }
        }

        // --- 1. ROBUST PARSER ---
        function parseM3U(m3u) {
            const lines = m3u.split('\n');
            const channels = [];
            let current = null;
            let headers = {};
            let kodiProps = {};

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                if (line.startsWith('#EXTINF:')) {
                    current = { 
                        name: line.split(',')[1] || "Unknown Channel",
                        logo: (line.match(/tvg-logo="([^"]+)"/) || [])[1] || "",
                        group: (line.match(/group-title="([^"]+)"/) || [])[1] || "General"
                    };
                    // Reset props for new channel
                    headers = {};
                    kodiProps = {};
                } 
                else if (line.startsWith('#EXTHTTP:')) {
                    try { headers = JSON.parse(line.replace('#EXTHTTP:', '')); } catch(e){}
                }
                else if (line.startsWith('#KODIPROP:')) {
                    const parts = line.replace('#KODIPROP:', '').split('=');
                    if (parts.length > 1) {
                        const key = parts.shift();
                        const val = parts.join('='); // Rejoin in case value has =
                        kodiProps[key.trim()] = val.trim();
                    }
                }
                else if (line.startsWith('#EXTVLCOPT:http-user-agent=')) {
                    headers['User-Agent'] = line.split('=')[1];
                }
                else if (!line.startsWith('#') && current) {
                    current.url = line;
                    current.headers = headers;
                    current.kodiProps = kodiProps;
                    
                    // Determine type for UI
                    current.type = line.includes('.mpd') ? 'DASH' : 'HLS';
                    
                    channels.push(current);
                    current = null;
                }
            });
            return channels;
        }

        function renderList(list) {
            const container = document.getElementById('channel-list');
            container.innerHTML = list.map((ch, idx) => `
                <div class="channel-item" onclick="playChannel(${idx}, this)">
                    <img src="${ch.logo}" onerror="this.style.display='none'">
                    <div class="channel-info">
                        <span class="channel-name">${ch.name}</span>
                        <span class="channel-type">${ch.type} | ${ch.group}</span>
                    </div>
                </div>
            `).join('');
        }

        function filterList() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const items = document.querySelectorAll('.channel-item');
            items.forEach(item => {
                const text = item.innerText.toLowerCase();
                item.style.display = text.includes(term) ? 'flex' : 'none';
            });
        }

        // --- 2. PLAYER LOGIC (THE FIX) ---
        async function playChannel(index, el) {
            // UI Highlight
            document.querySelectorAll('.channel-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');

            const ch = allChannels[index];
            const video = document.getElementById('video');
            const status = document.getElementById('status-msg');
            
            status.style.display = 'block';
            status.innerText = `Loading ${ch.name}...`;

            // Init Shaka
            shaka.polyfill.installAll();
            if (player) { await player.destroy(); }
            
            player = new shaka.Player(video);
            ui = new shaka.ui.Overlay(player, document.getElementById('video-container'), video);

            // Configure Networking (Fixes 403)
            player.getNetworkingEngine().registerRequestFilter((type, request) => {
                // Apply specific headers from M3U
                if (ch.headers) {
                    Object.entries(ch.headers).forEach(([k, v]) => {
                        request.headers[k] = v;
                    });
                }
                
                // Fallback User-Agent if not set
                if (!request.headers['User-Agent']) {
                    if (ch.url.includes('hotstar')) {
                        request.headers['User-Agent'] = "Hotstar;in.startv.hotstar/25.02.24.8.11169 (Android/15)";
                    } else {
                        request.headers['User-Agent'] = "plaYtv/7.1.3 (Linux;Android 13) ygx/824.1 ExoPlayerLib/824.0";
                    }
                }
            });

            // Configure DRM (Fixes Black Screen for DASH)
            let drmConfig = {};
            const licenseKey = ch.kodiProps['inputstream.adaptive.license_key'];
            
            if (licenseKey) {
                let clearKeys = {};
                
                // Case A: URL Based Keys (e.g. https://...keyid=X&key=Y)
                if (licenseKey.startsWith('http')) {
                    try {
                        const urlObj = new URL(licenseKey);
                        const kid = urlObj.searchParams.get('keyid');
                        const key = urlObj.searchParams.get('key');
                        if (kid && key) {
                            clearKeys[kid] = key;
                            console.log("Extracted Key URL:", kid, key);
                        }
                    } catch(e) { console.error("Key URL Parse Error", e); }
                } 
                // Case B: Standard Hex Keys (kid:key)
                else if (licenseKey.includes(':')) {
                    const [kid, key] = licenseKey.split(':');
                    clearKeys[kid] = key;
                    console.log("Extracted Key Standard:", kid, key);
                }

                if (Object.keys(clearKeys).length > 0) {
                    drmConfig = { clearKeys: clearKeys };
                }
            }

            player.configure({
                drm: drmConfig,
                streaming: {
                    bufferingGoal: 15,
                    rebufferingGoal: 2,
                    stallEnabled: true
                }
            });

            // Load
            try {
                await player.load(ch.url);
                status.style.display = 'none';
                console.log("Stream Loaded via Shaka");
            } catch (error) {
                console.error('Error code', error.code, 'object', error);
                status.innerText = `Error: ${error.message} (Code: ${error.code})`;
            }
        }
    </script>
</body>
</html>
