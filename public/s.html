<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JioTV/Hotstar Live Player</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css" crossorigin="anonymous">

    <style>
        body { background: #0d0d0d; color: #fff; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Grid Layout */
        #channel-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            padding: 20px;
            overflow-y: auto;
        }
        
        .card {
            background: #1e1e1e;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border: 2px solid transparent;
        }
        .card:hover { border-color: #2196F3; background: #2a2a2a; }
        .card img { width: 100%; height: 90px; object-fit: contain; margin-bottom: 10px; }
        .card span { font-size: 14px; text-align: center; font-weight: 500; }

        /* Player Overlay */
        #player-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 1000; display: none;
        }
        .close-btn {
            position: absolute; top: 20px; right: 20px; z-index: 1100;
            background: #ff4444; color: white; border: none;
            padding: 10px 20px; cursor: pointer; border-radius: 5px; font-weight: bold;
        }
        #video { width: 100%; height: 100%; }
        
        /* Search */
        #search-bar { padding: 15px; background: #1e1e1e; display: flex; justify-content: center; }
        #search-input { padding: 10px; width: 100%; max-width: 400px; border-radius: 4px; border: none; }
    </style>
</head>
<body>

<div id="search-bar">
    <input type="text" id="search-input" placeholder="Search Channels..." onkeyup="filterChannels()">
</div>

<div id="channel-grid"></div>

<div id="player-container">
    <button class="close-btn" onclick="closePlayer()">CLOSE</button>
    <div data-shaka-player-container style="width:100%;height:100%">
        <video autoplay data-shaka-player id="video" style="width:100%;height:100%"></video>
    </div>
</div>

<script>
    let channels = [];
    let player;
    let ui;

    // 1. Load M3U
    async function init() {
        try {
            const res = await fetch('https://raw.githubusercontent.com/ascal-dev/matchlinks-jsontom3u/main/JTV-drm.m3u');
            const text = await res.text();
            channels = parseM3U(text);
            renderChannels(channels);
        } catch (e) {
            console.error("Failed to load playlist", e);
        }
    }

    // 2. Robust M3U Parser
    function parseM3U(data) {
        const lines = data.split('\n');
        const result = [];
        let current = {};
        
        lines.forEach(line => {
            line = line.trim();
            if (!line) return;

            if (line.startsWith('#EXTINF:')) {
                current = { headers: {}, drm: {} };
                const logoMatch = line.match(/tvg-logo="([^"]*)"/);
                const nameMatch = line.split(',').pop();
                current.logo = logoMatch ? logoMatch[1] : '';
                current.name = nameMatch.trim();
            } 
            else if (line.startsWith('#EXTHTTP:')) {
                try {
                    const json = JSON.parse(line.replace('#EXTHTTP:', ''));
                    current.headers = json;
                } catch (e) { console.warn('JSON Parse Error', e); }
            }
            else if (line.startsWith('#EXTVLCOPT:http-user-agent=')) {
                 current.headers['User-Agent'] = line.split('=')[1];
            }
            else if (line.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                const val = line.split('=')[1];
                current.drm.key_string = val;
            }
            else if (!line.startsWith('#')) {
                current.url = line;
                // Extract params from URL if headers are missing
                if (line.includes('Cookie=')) {
                    const params = new URLSearchParams(line.split('?')[1]);
                    if (!current.headers['Cookie']) current.headers['Cookie'] = params.get('Cookie');
                }
                result.push(current);
            }
        });
        return result;
    }

    // 3. Render Grid
    function renderChannels(list) {
        const grid = document.getElementById('channel-grid');
        grid.innerHTML = list.map((ch, i) => `
            <div class="card" onclick="playChannel(${i})">
                <img src="${ch.logo}" onerror="this.src='https://via.placeholder.com/100?text=TV'">
                <span>${ch.name}</span>
            </div>
        `).join('');
    }

    function filterChannels() {
        const term = document.getElementById('search-input').value.toLowerCase();
        const filtered = channels.filter(c => c.name.toLowerCase().includes(term));
        renderChannels(filtered);
    }

    // 4. Play Channel (The Fix)
    async function playChannel(index) {
        const ch = channels[index]; // Use global filtered list if needed, but for now simple index
        // Find actual channel object from full list based on name if filtering is active (simplified here)
        const targetChannel = channels.find(c => c.name === document.querySelectorAll('.card span')[index].innerText) || channels[index];

        document.getElementById('player-container').style.display = 'block';

        const video = document.getElementById('video');
        const container = video.parentElement;

        shaka.polyfill.installAll();
        if (player) { await player.destroy(); }
        
        player = new shaka.Player(video);
        ui = new shaka.ui.Overlay(player, container, video);

        // --- ERROR HANDLER ---
        player.addEventListener('error', (e) => console.error('Error code', e.detail.code, 'object', e.detail));

        // --- NETWORK FILTERS (Fixes 403) ---
        player.getNetworkingEngine().registerRequestFilter((type, request) => {
            // Add Headers from M3U
            if (targetChannel.headers) {
                for (const [key, value] of Object.entries(targetChannel.headers)) {
                    request.headers[key] = value;
                }
            }
            
            // Hardcode specific User-Agents if missing (Fixes JioTV/Hotstar)
            if (!request.headers['User-Agent']) {
                if (targetChannel.url.includes('hotstar')) {
                    request.headers['User-Agent'] = 'Hotstar;in.startv.hotstar/25.02.24.8.11169 (Android/15)';
                } else if (targetChannel.url.includes('jiotv') || targetChannel.url.includes('jio')) {
                    request.headers['User-Agent'] = 'plaYtv/7.1.3 (Linux;Android 13) ygx/824.1 ExoPlayerLib/824.0';
                }
            }
        });

        // --- DRM CONFIG (Fixes Black Screen/200 OK) ---
        let clearKeys = {};
        
        if (targetChannel.drm.key_string) {
            const kStr = targetChannel.drm.key_string;

            // Type A: Standard kid:key
            if (kStr.includes(':') && !kStr.includes('http')) {
                const parts = kStr.split(':');
                clearKeys[parts[0]] = parts[1];
            }
            // Type B: URL with params (e.g. aqfadtv.xyz/...?keyid=...&key=...)
            else if (kStr.includes('http') && kStr.includes('keyid=')) {
                try {
                    const urlObj = new URL(kStr);
                    const kid = urlObj.searchParams.get('keyid');
                    const key = urlObj.searchParams.get('key');
                    if (kid && key) {
                        clearKeys[kid] = key;
                    }
                } catch(e) { console.log("Error parsing Key URL", e); }
            }
        }

        const config = {
            drm: { 
                clearKeys: clearKeys 
            },
            streaming: {
                lowLatencyMode: true,
                bufferingGoal: 10,
                rebufferingGoal: 2
            }
        };
        
        player.configure(config);

        try {
            console.log("Loading:", targetChannel.url);
            console.log("Keys:", clearKeys);
            await player.load(targetChannel.url);
        } catch (e) {
            console.error('Load failed:', e);
        }
    }

    function closePlayer() {
        if (player) {
            player.unload();
        }
        document.getElementById('player-container').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
