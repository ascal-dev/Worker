<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IteraPlay Ultimate Stable with Clear Storage</title>

<style>
:root{
--bg:#0f0f0f;
--card:#1b1b1b;
--accent:#00e676;
--orange:#ff9100;
--danger:#ff4444;
--text:#ffffff;
--gold:linear-gradient(45deg,gold,orange);
}

*{margin:0;padding:0;box-sizing:border-box;font-family:Arial;}
body{background:var(--bg);color:var(--text);padding:14px;}

.nav{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:14px;}
.nav button{padding:8px 14px;border:0;border-radius:6px;background:#2c2c2c;color:white;cursor:pointer;}
.nav button.active{background:var(--accent);color:black;}

video{width:100%;max-height:300px;background:black;border-radius:10px;margin-bottom:20px;}

.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:14px;}

.card{background:var(--card);border-radius:10px;overflow:hidden;display:flex;flex-direction:column;}
.thumb-wrapper{position:relative;}
.card img{width:100%;height:200px;object-fit:contain;background:black;}

.premium-badge{
position:absolute;
top:8px;
left:8px;
background:var(--gold);
color:black;
font-size:11px;
padding:4px 8px;
border-radius:6px;
font-weight:bold;
}

.poster-icons{
position:absolute;
top:8px;
right:8px;
display:flex;
gap:6px;
}

.poster-icons button{
background:rgba(0,0,0,0.7);
border:0;
color:white;
padding:4px 6px;
border-radius:5px;
cursor:pointer;
}

.info{padding:10px;display:flex;flex-direction:column;}
.info h3{font-size:13px;height:34px;overflow:hidden;margin-bottom:6px;}

.btn{padding:7px;border:0;border-radius:6px;cursor:pointer;margin-top:6px;font-size:12px;}
.play{background:var(--accent);color:black;}
.redirect{background:var(--orange);color:black;}
.remove{background:var(--danger);color:white;}
.clear-all{background:#ff5555;color:white;margin-bottom:6px;}

.pagination{display:flex;justify-content:center;gap:6px;margin-top:18px;flex-wrap:wrap;}
.pagination button{padding:6px 10px;border:0;border-radius:6px;background:#2c2c2c;color:white;cursor:pointer;}
.pagination button.active{background:var(--accent);color:black;}
.pagination input{width:60px;padding:5px;border-radius:6px;border:0;text-align:center;}

.saved-section{margin-top:30px;}
.saved-item{
display:flex;
align-items:center;
gap:8px;
background:#181818;
padding:6px;
border-radius:8px;
margin-bottom:6px;
}

.saved-item img{
width:55px;
height:55px;
object-fit:contain;
background:black;
border-radius:6px;
}

.saved-title{
flex:1;
font-size:12px;
overflow:hidden;
}

.saved-premium{
background:var(--gold);
color:black;
font-size:10px;
padding:2px 6px;
border-radius:4px;
font-weight:bold;
}

.toast{
position:fixed;
bottom:20px;
left:50%;
transform:translateX(-50%);
background:#222;
padding:8px 14px;
border-radius:8px;
opacity:0;
transition:.3s;
}
.toast.show{opacity:1;}
.loading{text-align:center;padding:30px;color:#aaa;}
  /* ======= MOBILE FIX FOR SAVED LINKS ======= */
@media (max-width: 600px) {
  .saved-section {
    padding: 0 5px;
  }
  .saved-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
    padding: 8px;
  }
  .saved-item img {
    width: 100%;
    height: auto;
    max-height: 200px;
    object-fit: cover;
  }
  .saved-title {
    font-size: 14px;
    overflow: visible;
    width: 100%;
  }
  .saved-item button {
    width: 100%;
    margin-top: 4px;
  }
}

</style>
</head>
<body>

<div class="nav">
<button class="active" onclick="App.switchTab('trending',this)">Trending</button>
<button onclick="App.switchTab('all',this)">All</button>
<button onclick="App.switchTab('viral',this)">Viral</button>
<button onclick="App.switchTab('recent',this)">Recent</button>
</div>

<video id="player" controls></video>

<div id="grid" class="grid"></div>

<div class="pagination">
<button onclick="App.prevPage()">Prev</button>
<span id="pageNumbers"></span>
<button onclick="App.nextPage()">Next</button>
<input type="number" id="jumpInput" placeholder="Page">
<button onclick="App.jumpPage()">Go</button>
</div>

<div class="saved-section">
<h2>Saved Links</h2>
<button class="btn clear-all" onclick="App.clearAllSaved()">Delete All Saved Links</button>
<div id="savedContainer"></div>
</div>

<div id="toast" class="toast"></div>

<script>
const App={

CONFIG:{
PROXY:"https://iterplay.httpsfree-tvsdjjnworkersdev.workers.dev/?url=",
SECRET_KEY:"iTeraPl@y_V1d30_S3cur3_K3y_2025_!@#$",
LIMIT:20,
BYPASS_URL:"https://sdjjn.pages.dev/bypasstera.html"
},

STATE:{tab:"trending",page:1,videos:[],cache:{}},

API:{
all:{url:"https://iteraplay.com/api/get-videos.php",mode:"plain"},
recent:{url:"https://iteraplay.com/api/get-recent-videos.php",mode:"encrypted"},
trending:{url:"https://iteraplay.com/api/get-trending-videos.php",mode:"encrypted"},
viral:{url:"https://iteraplay.com/api/get-viral-videos.php",mode:"auto"}
},

init(){
if(!localStorage.getItem("savedLinks")){
localStorage.setItem("savedLinks","[]");
}
this.load();
this.renderSaved();
},

toast(msg){
const t=document.getElementById("toast");
t.innerText=msg;
t.classList.add("show");
setTimeout(()=>t.classList.remove("show"),2000);
},

switchTab(tab,btn){
this.STATE.tab=tab;
this.STATE.page=1;
document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
btn.classList.add("active");
this.load();
},

xorDecrypt(b64,key){
let d=atob(b64),o="";
for(let i=0;i<d.length;i++){
o+=String.fromCharCode(d.charCodeAt(i)^key.charCodeAt(i%key.length));
}
return o;
},

async fetchData(url,mode){
if(this.STATE.cache[url]) return this.STATE.cache[url];
let res=await fetch(this.CONFIG.PROXY+url);
let j=await res.json();
let data;
if(mode==="plain") data=j.videos||[];
else if(j.data){
let p=JSON.parse(this.xorDecrypt(j.data,this.CONFIG.SECRET_KEY));
data=p.videos||p||[];
}else data=j.videos||[];
this.STATE.cache[url]=data;
return data;
},

async load(){
document.getElementById("grid").innerHTML="<div class='loading'>Loading...</div>";
let api=this.API[this.STATE.tab];
let offset=(this.STATE.page-1)*this.CONFIG.LIMIT;
let url=api.url+"?offset="+offset+"&limit="+this.CONFIG.LIMIT+"&reset_seed=true";
let raw=await this.fetchData(url,api.mode);

this.STATE.videos=raw.map(v=>({
id:v.id||v.video_id,
title:v.title||v.file_name||"Untitled",
thumbnail:v.thumbnail||"",
terabox_url:v.terabox_url||v.external_url||"",
custom_url:v.custom_url||"",
player_url:"",
is_premium:v.is_premium!==false
}));

this.render();
this.renderPagination();
},

bestLink(v){return v.terabox_url||v.custom_url||v.player_url||"";},

setBypass(link){
localStorage.setItem("sharedTeraboxUrl",link);
localStorage.setItem("sharedTeraboxUrlfromiterplay",link);
},

render(){
let g=document.getElementById("grid");
g.innerHTML="";
this.STATE.videos.forEach((v,i)=>{
let card=document.createElement("div");
card.className="card";

let html=`<div class="thumb-wrapper">
<img loading="lazy" src="${v.thumbnail}">`;

if(v.is_premium) html+=`<div class="premium-badge">PREMIUM</div>`;

html+=`<div class="poster-icons">
<button onclick="App.copy(${i})">ðŸ“‹</button>
<button onclick="App.save(${i})">ðŸ’¾</button>
</div></div>
<div class="info">
<h3>${v.title}</h3>`;

if(!v.terabox_url){
html+=`<button class="btn play" onclick="App.play(${i})">Play</button>`;
}

html+=`<button class="btn redirect" onclick="App.redirect(${i})">Bypass</button>
</div>`;

card.innerHTML=html;
g.appendChild(card);
});
},

renderSaved(){
let container=document.getElementById("savedContainer");
container.innerHTML="";
let saved=JSON.parse(localStorage.getItem("savedLinks"));

saved.forEach((s,index)=>{
let div=document.createElement("div");
div.className="saved-item";

let html=`<img src="${s.thumbnail}">
<div class="saved-title">${s.title}</div>`;

if(s.is_premium){
html+=`<span class="saved-premium">PREMIUM</span>`;
}

if(!s.link.includes("terabox")){
html+=`<button class="btn play" onclick="App.playSaved(${index})">Play</button>`;
}

html+=`<button class="btn redirect" onclick="App.redirectSaved(${index})">Bypass</button>
<button class="btn remove" onclick="App.removeSaved(${index})">X</button>`;

div.innerHTML=html;
container.appendChild(div);
});
},

save(i){
let saved=JSON.parse(localStorage.getItem("savedLinks"));
let v=this.STATE.videos[i];
let link=this.bestLink(v);
if(!link)return this.toast("No link");
if(saved.find(s=>s.id===v.id))return this.toast("Already Saved");

saved.push({
id:v.id,
title:v.title,
thumbnail:v.thumbnail,
link:link,
is_premium:v.is_premium
});

localStorage.setItem("savedLinks",JSON.stringify(saved));
this.renderSaved();
this.toast("Saved!");
},

removeSaved(i){
let saved=JSON.parse(localStorage.getItem("savedLinks"));
saved.splice(i,1);
localStorage.setItem("savedLinks",JSON.stringify(saved));
this.renderSaved();
this.toast("Removed");
},

clearAllSaved(){
localStorage.setItem("savedLinks","[]");
this.renderSaved();
this.toast("All saved links deleted!");
},

redirect(i){
let link=this.bestLink(this.STATE.videos[i]);
if(!link)return this.toast("No link");
this.setBypass(link);
window.location.href=this.CONFIG.BYPASS_URL;
},

redirectSaved(i){
let saved=JSON.parse(localStorage.getItem("savedLinks"));
this.setBypass(saved[i].link);
window.location.href=this.CONFIG.BYPASS_URL;
},

copy(i){
let link=this.bestLink(this.STATE.videos[i]);
if(!link)return this.toast("No link");
navigator.clipboard.writeText(link);
this.toast("Copied!");
},

async play(i){
let v=this.STATE.videos[i];
if(v.player_url){
player.src=v.player_url;
player.play();
return;
}
if(!v.custom_url)return this.toast("No playable link");

let r=await fetch("https://iteraplay.com/s/watch.php?url="+encodeURIComponent(v.custom_url));
let h=await r.text();
let m=h.match(/https:\/\/pub-[^'"]+\.mp4/);

if(m){
v.player_url=m[0];
player.src=m[0];
player.play();
}else{
this.toast("Video not found");
}
},

playSaved(i){
let saved=JSON.parse(localStorage.getItem("savedLinks"));
player.src=saved[i].link;
player.play();
},

renderPagination(){
let container=document.getElementById("pageNumbers");
container.innerHTML="";
for(let i=Math.max(1,this.STATE.page-2);i<=this.STATE.page+2;i++){
let b=document.createElement("button");
b.innerText=i;
if(i===this.STATE.page)b.classList.add("active");
b.onclick=()=>{this.STATE.page=i;this.load();}
container.appendChild(b);
}
},

nextPage(){this.STATE.page++;this.load();},
prevPage(){if(this.STATE.page>1){this.STATE.page--;this.load();}},
jumpPage(){
let p=parseInt(document.getElementById("jumpInput").value);
if(p>0){this.STATE.page=p;this.load();}
}

};

document.addEventListener("DOMContentLoaded",()=>App.init());
</script>
</body>
</html>

