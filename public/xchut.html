<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fast WP Content Browser</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    body {
      background: #0b0b0b;
      color: #fff;
      font-family: Arial;
      padding: 10px
    }

    h2 {
      margin-bottom: 10px
    }

    .grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(3, 1fr)
    }

    @media(min-width:992px) {
      .grid {
        grid-template-columns: repeat(6, 1fr)
      }
    }

    .card {
      background: #1a1a1a;
      border-radius: 6px;
      overflow: hidden;
      cursor: pointer
    }

    .card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      background: #111
    }

    .card h4 {
      font-size: 14px;
      padding: 6px;
      text-align: center
    }

    #player {
      display: none;
      margin-bottom: 10px
    }

    #player video {
      width: 100%;
      max-height: 450px
    }

    .nav {
      text-align: center;
      margin-top: 15px
    }

    .nav button,
    .nav input {
      padding: 6px 10px;
      margin: 3px;
      border: none;
      border-radius: 4px
    }

    .nav button {
      background: #ff0055;
      color: #fff;
      cursor: pointer
    }

    .nav button:disabled {
      opacity: .4;
      cursor: not-allowed
    }

  .nav input {
    width: 60px
  }

  .nav .search-input {
    width: 160px
  }

    #pageInfo {
      margin-left: 8px;
      opacity: .8
    }
  </style>
</head>

<body>

  <h2 id="title">Categories</h2>

  <div class="nav">
    <button onclick="goBack()">Back</button>
    <button id="prevBtn" onclick="prevPage()">Prev</button>
    <input id="pageInput" type="number" min="1">
    <button onclick="goPage()">Go</button>
    <button id="nextBtn" onclick="nextPage()">Next</button>
    <input id="searchInput" class="search-input" type="text" placeholder="Search title">
    <button onclick="searchGo()">Search</button>
    <span id="pageInfo"></span>
  </div>

  <div id="player"></div>
  <div id="grid" class="grid"></div>

  <div class="nav">
    <button id="prevBtn" onclick="prevPage()">Prev</button>
    <input id="pageInput" type="number" min="1">
    <button onclick="goPage()">Go</button>
    <button id="nextBtn" onclick="nextPage()">Next</button>
    <span id="pageInfo"></span>
  </div>

  <script>
    /* ================= CONFIG ================= */
    const CAT_API = "https://xchut.com/wp-json/wp/v2/categories?per_page=50";
    const POST_API = "https://xchut.com/wp-json/wp/v2/posts";

    /* proxy YOU are already using */
    const PROXY = "https://tv-4vo.pages.dev/api/proxy?extract=true&url=";

    const CATEGORY_UI_LIMIT = 15;
    const POST_UI_LIMIT = 20;

    /* ================= STATE ================= */
    let mode = "categories";
    let page = 1;
    let categories = [];
    let posts = [];
    let renderToken = 0;

    /* ================= DOM ================= */
  const grid = document.getElementById("grid");
  const title = document.getElementById("title");
  const player = document.getElementById("player");
  const pageInput = document.getElementById("pageInput");
  const searchInput = document.getElementById("searchInput");
  const pageInfo = document.getElementById("pageInfo");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");

  let searchTerm = "";
  let currentCategoryId = null;
  let currentCategoryName = "";
  let lastMode = "categories";

    /* ================= UTILS ================= */
    const j = url => fetch(url).then(r => r.json());
    const tinyDelay = () => new Promise(r => setTimeout(r, 1));
    const proxify = url => url ? (url.startsWith(PROXY) ? url : PROXY + encodeURIComponent(url)) : "";

    function setImgWithProxy(imgEl, url) {
      if (!imgEl) return;
      if (!url) { imgEl.removeAttribute("src"); return; }
      imgEl.onerror = () => {
        if (!imgEl.dataset.proxied) {
          imgEl.dataset.proxied = "1";
          imgEl.src = proxify(url);
        }
      };
      imgEl.src = url;
    }

    /* ================= IMAGE (Yoast contentUrl ONLY) ================= */
    function getPostImage(post) {
      const graph = post?.yoast_head_json?.schema?.["@graph"];
      if (!Array.isArray(graph)) return null;

      for (const node of graph) {
        if (node?.contentUrl && node.contentUrl.includes("/wp-content/uploads/")) {
          return node.contentUrl;
        }
      }
      return null;
    }

    /* ================= MP4 FROM POST LINK HTML ================= */
    function extractMp4FromPostLink(postLink) {
      const fetchUrl = PROXY + encodeURIComponent(postLink);

      return fetch(fetchUrl)
        .then(res => res.text())
        .then(html => {
          const doc = new DOMParser().parseFromString(html, "text/html");

          // meta itemprop
          const meta = doc.querySelector('meta[itemprop="contentURL"]');
          if (meta && meta.content && meta.content.endsWith(".mp4")) {
            return meta.content;
          }

          // video source
          const source = doc.querySelector("video source[src$='.mp4']");
          if (source && source.src) {
            return source.src;
          }

          return null;
        })
        .catch(err => {
          console.warn("MP4 extract failed:", err);
          return null;
        });
    }

    /* ================= INIT ================= */
    loadCategories();

    /* ================= CATEGORIES ================= */
  function loadCategories() {
    mode = "categories";
    page = 1;
    lastMode = "categories";
    title.textContent = "Categories";
    hidePlayer();

    j(CAT_API).then(data => {
      categories = data;
      renderCategories();
    });
  }

    async function renderCategories() {
      const token = ++renderToken;
      grid.innerHTML = "";

      const slice = categories.slice(
        (page - 1) * CATEGORY_UI_LIMIT,
        page * CATEGORY_UI_LIMIT
      );

      slice.forEach(c => {
        const d = document.createElement("div");
        d.className = "card";
        d.innerHTML = `<img><h4>${c.name}</h4>`;
        d.onclick = () => loadPosts(c.id, c.name);
        grid.appendChild(d);
      });

      updatePageInfo();
      await new Promise(r => requestAnimationFrame(r));

      for (const c of slice) {
        if (token !== renderToken) return;

        try {
          const p = await j(`${POST_API}?categories=${c.id}&per_page=1`);
          if (!p.length) continue;

          const img = getPostImage(p[0]);
          if (!img) continue;

          const el = [...grid.children]
            .find(x => x.textContent === c.name)
            ?.querySelector("img");

          if (el) setImgWithProxy(el, img);
          await tinyDelay();
        } catch (e) { }
      }
    }

    /* ================= POSTS ================= */
  function loadPosts(catId, name) {
    mode = "posts";
    page = 1;
    lastMode = "posts";
    currentCategoryId = catId;
    currentCategoryName = name;
    title.textContent = name;
    hidePlayer();

    j(`${POST_API}?categories=${catId}&per_page=100`).then(data => {
      posts = data;
      renderPosts();
    });
  }

  function renderPosts() {
    renderToken++;
    grid.innerHTML = "";
    hidePlayer();

      const slice = posts.slice(
        (page - 1) * POST_UI_LIMIT,
        page * POST_UI_LIMIT
      );

    slice.forEach(p => {
      const img = getPostImage(p);
      const d = document.createElement("div");
      d.className = "card";
      d.innerHTML = `
        <img>
        <h4>${p.title.rendered}</h4>
      `;
      setImgWithProxy(d.querySelector("img"), img || "");
      d.onclick = () => openPlayer(p);
      grid.appendChild(d);
    });

    updatePageInfo();
    applyFilter();
  }

  function applyFilter() {
    const term = (searchInput?.value || "").toLowerCase().trim();
    const cards = grid.querySelectorAll(".card");
    cards.forEach(card => {
      const text = (card.textContent || "").toLowerCase();
      card.style.display = !term || text.includes(term) ? "" : "none";
    });
  }

  function searchGo() {
    const term = (searchInput?.value || "").trim();
    if (!term) {
      if (lastMode === "posts" && currentCategoryId) {
        title.textContent = currentCategoryName || "Posts";
        renderPosts();
      } else {
        loadCategories();
      }
      return;
    }
    searchTerm = term;
    mode = "search";
    page = 1;
    title.textContent = `Search: ${term}`;
    hidePlayer();
    j(`${POST_API}?search=${encodeURIComponent(term)}&per_page=100`).then(data => {
      posts = data;
      renderPosts();
    });
  }

    /* ================= PLAYER ================= */
    function openPlayer(post) {
      hidePlayer();

      extractMp4FromPostLink(post.link).then(mp4 => {
        if (!mp4) return;
        const proxiedMp4 = proxify(mp4);
        player.innerHTML = `
      <video controls autoplay>
        <source src="${proxiedMp4}" type="video/mp4">
      </video>
    `;
        player.style.display = "block";
      });
    }

    function hidePlayer() {
      player.style.display = "none";
      player.innerHTML = "";
    }

    /* ================= PAGINATION ================= */
    function updatePageInfo() {
      const total = mode === "categories"
        ? Math.ceil(categories.length / CATEGORY_UI_LIMIT)
        : Math.ceil(posts.length / POST_UI_LIMIT);

      pageInfo.textContent = `Page ${page} / ${total}`;
      prevBtn.disabled = page <= 1;
      nextBtn.disabled = page >= total;
    }

    function nextPage() {
      const total = mode === "categories"
        ? Math.ceil(categories.length / CATEGORY_UI_LIMIT)
        : Math.ceil(posts.length / POST_UI_LIMIT);

      if (page < total) { page++; mode === "categories" ? renderCategories() : renderPosts(); }
    }
    function prevPage() {
      if (page > 1) { page--; mode === "categories" ? renderCategories() : renderPosts(); }
    }
  function goPage() {
    const p = parseInt(pageInput.value);
    if (!p) return;

    const total = mode === "categories"
      ? Math.ceil(categories.length / CATEGORY_UI_LIMIT)
      : Math.ceil(posts.length / POST_UI_LIMIT);

    if (p >= 1 && p <= total) { page = p; mode === "categories" ? renderCategories() : renderPosts(); }
  }

  if (searchInput) {
    searchInput.addEventListener("input", applyFilter);
  }

    /* ================= BACK BUTTON SUPPORT ================= */

    function goBack() {
      if (mode === "posts") {
        loadCategories();
        history.pushState({ page: "categories" }, "", "#categories");
      } else {
        history.back();
      }
    }

    /* Browser / Android hardware back */
    history.pushState({ page: "categories" }, "", "#categories");

    window.addEventListener("popstate", function () {
      if (mode === "posts") {
        loadCategories();
      }
    });
  </script>

</body>

</html>
