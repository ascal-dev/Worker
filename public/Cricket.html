<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamFlex Pro - Live Sports</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        /* =========================================
           1. CSS VARIABLES & RESET
           ========================================= */
        :root {
            --primary: #e50914;
            --bg-dark: #0f0f0f;
            --bg-card: #181818;
            --text-main: #fff;
            --text-sub: #aaa;
            --header-h: 70px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        body { background: var(--bg-dark); color: var(--text-main); overflow-x: hidden; height: 100vh; width: 100vw; }

        /* =========================================
           2. UTILITY CLASSES
           ========================================= */
        .hidden { display: none !important; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .btn { cursor: pointer; border: none; outline: none; transition: 0.2s; }

        /* =========================================
           3. GRID VIEW STYLING
           ========================================= */
        #gridView { padding-top: var(--header-h); min-height: 100vh; }

        /* Header */
        .app-header {
            position: fixed; top: 0; left: 0; right: 0; height: var(--header-h);
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 4%;
            border-bottom: 1px solid #333;
        }

        .brand { font-size: 24px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
        .brand span { color: #fff; font-weight: 300; }

        .search-box {
            background: #222; border: 1px solid #333;
            padding: 10px 20px; border-radius: 50px;
            color: #fff; width: 300px; font-size: 14px;
        }
        .search-box:focus { border-color: var(--primary); }

        /* Grid */
        .channel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
            padding: 30px 4%;
        }

        .card {
            background: var(--bg-card); border-radius: 8px;
            overflow: hidden; cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
        }

        .card:hover { transform: scale(1.05); z-index: 10; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }

        .card-img-wrap {
            width: 100%; aspect-ratio: 16/9;
            background: #000; display: flex; align-items: center; justify-content: center;
        }
        .card-img-wrap img { max-width: 80%; max-height: 80%; object-fit: contain; }

        .card-body { padding: 12px; }
        .card-title { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-meta { font-size: 11px; color: var(--text-sub); margin-top: 4px; display: flex; gap: 6px; }
        .badge { background: #333; padding: 2px 6px; border-radius: 4px; }
        .badge.drm { background: #1b5e20; color: #a5d6a7; }

        /* =========================================
           4. PLAYER VIEW STYLING
           ========================================= */
        #playerView {
            position: fixed; inset: 0; z-index: 200;
            background: #000; display: flex; flex-direction: column;
        }

        /* Custom Back Button overlay */
        .player-nav {
            position: absolute; top: 0; left: 0; right: 0;
            padding: 20px; z-index: 205;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            display: flex; align-items: center; gap: 15px;
            opacity: 0; transition: opacity 0.3s; pointer-events: none; /* Let clicks pass through when hidden */
        }
        #playerView:hover .player-nav { opacity: 1; pointer-events: auto; }

        .back-btn {
            background: rgba(255,255,255,0.1); color: #fff;
            padding: 8px 16px; border-radius: 4px;
            font-weight: 600; display: flex; align-items: center; gap: 5px;
        }
        .back-btn:hover { background: rgba(255,255,255,0.2); }

        /* Shaka Container */
        .video-container { width: 100%; height: 100%; position: relative; }
        video { width: 100%; height: 100%; background: #000; }

        /* Aspect Ratio Styles */
        .aspect-fit { object-fit: contain; }
        .aspect-zoom { object-fit: cover; }
        .aspect-stretch { object-fit: fill; }
        .aspect-4-3 { object-fit: contain; max-width: 75vh; margin: 0 auto; }

        /* Loading */
        .loader {
            width: 48px; height: 48px;
            border: 5px solid #FFF; border-bottom-color: var(--primary);
            border-radius: 50%; display: inline-block;
            box-sizing: border-box; animation: rotation 1s linear infinite;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 210; display: none;
        }
        @keyframes rotation { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        /* Custom Control Buttons in Shaka Bar */
        .shaka-custom-btn {
            background: transparent; color: white; border: none; cursor: pointer;
            font-size: 18px; margin-right: 10px; display: flex; align-items: center;
        }
        .shaka-custom-btn:hover { color: var(--primary); }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="brand">Stream<span>Flex</span></div>
        <input type="text" class="search-box" id="searchInput" placeholder="Find channel..." onkeyup="app.filterGrid()">
    </header>

    <div id="gridView">
        <div id="channelGrid" class="channel-grid">
            <div style="grid-column: 1/-1; text-align: center; margin-top: 50px;">
                <span class="loader" style="display:inline-block; position:static; transform:none;"></span>
                <p style="margin-top:10px; color:#666;">Loading Playlist from GitHub...</p>
            </div>
        </div>
    </div>

    <div id="playerView" class="hidden">
        <div class="player-nav">
            <button class="back-btn btn" onclick="app.closePlayer()">
                <i class="material-icons">arrow_back</i> Back
            </button>
            <h3 id="playerTitle">Channel Name</h3>
        </div>
        
        <div class="video-container" id="videoContainer">
            <div class="loader" id="bufferingSpinner"></div>
            <video id="video" autoplay playsinline></video>
        </div>
    </div>

    <script>
        /**
         * ====================================================================
         * STREAMFLEX PRO - SINGLE FILE LOGIC
         * ====================================================================
         */
        
        const APP_CONFIG = {
            // The exact GitHub URL requested
            PLAYLIST_URL: 'https://raw.githubusercontent.com/ascal-dev/matchlinks-jsontom3u/main/Cricket.m3u',
            DEFAULT_UA: 'StreamFlex/7.1.3 (Linux;Android 13) StreamFlex/69.1 ExoPlayerLib/824.0'
        };

        class StreamApp {
            constructor() {
                this.channels = [];
                this.player = null;
                this.ui = null;
                this.currentAspectIndex = 0;
                this.aspectModes = ['aspect-fit', 'aspect-zoom', 'aspect-stretch', 'aspect-4-3'];
                this.aspectNames = ['Fit', 'Zoom', 'Stretch', '4:3'];
            }

            async init() {
                await this.fetchPlaylist();
                
                // Initialize Shaka UI only once
                shaka.polyfill.installAll();
                if (shaka.Player.isBrowserSupported()) {
                    this.initPlayerInstance();
                } else {
                    console.error('Browser not supported!');
                }
            }

            // 1. FETCH & PARSE
            async fetchPlaylist() {
                try {
                    const response = await fetch(APP_CONFIG.PLAYLIST_URL);
                    const text = await response.text();
                    this.channels = this.parseM3U(text);
                    this.renderGrid(this.channels);
                } catch (e) {
                    document.getElementById('channelGrid').innerHTML = `<p style="text-align:center; color:red;">Failed to load playlist.<br>${e.message}</p>`;
                }
            }

            parseM3U(data) {
                const lines = data.split('\n');
                const playlist = [];
                let current = null;
                let props = {};

                lines.forEach(line => {
                    line = line.trim();
                    if (!line) return;

                    if (line.startsWith('#EXTINF:')) {
                        // Push previous
                        if (current && current.url) playlist.push(current);
                        
                        const logo = (line.match(/tvg-logo="([^"]+)"/) || [])[1] || "";
                        const group = (line.match(/group-title="([^"]+)"/) || [])[1] || "General";
                        const name = line.split(',').pop().trim();
                        
                        current = { name, logo, group, props: {} };
                        props = {}; // Reset props

                    } else if (line.startsWith('#KODIPROP:')) {
                        const [key, ...vals] = line.replace('#KODIPROP:', '').split('=');
                        const val = vals.join('=').trim();
                        if (!props.kodi) props.kodi = {};
                        props.kodi[key.trim()] = val;

                    } else if (line.startsWith('#EXTVLCOPT:')) {
                        if (line.includes('http-user-agent=')) {
                            props.ua = line.split('http-user-agent=')[1].trim();
                        }

                    } else if (line.startsWith('#EXTHTTP:')) {
                        try {
                            const json = JSON.parse(line.replace('#EXTHTTP:', ''));
                            if (json.cookie) props.cookie = json.cookie;
                        } catch(e){}

                    } else if (!line.startsWith('#')) {
                        if (current) {
                            current.url = line;
                            // Merge specific props
                            current.props = { ...props };
                            // Add default UA if missing
                            if (!current.props.ua) current.props.ua = APP_CONFIG.DEFAULT_UA;
                            playlist.push(current);
                            current = null;
                        }
                    }
                });
                if (current && current.url) playlist.push(current); // Push last
                return playlist;
            }

            // 2. RENDER UI
            renderGrid(list) {
                const grid = document.getElementById('channelGrid');
                grid.innerHTML = list.map((ch, idx) => `
                    <div class="card" onclick="app.playChannel(${idx})">
                        <div class="card-img-wrap">
                            <img src="${ch.logo}" onerror="this.src='https://via.placeholder.com/200x112?text=${encodeURIComponent(ch.name)}'">
                        </div>
                        <div class="card-body">
                            <div class="card-title">${ch.name}</div>
                            <div class="card-meta">
                                <span class="badge">${ch.group}</span>
                                ${ch.props.kodi ? '<span class="badge drm">DRM</span>' : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            filterGrid() {
                const q = document.getElementById('searchInput').value.toLowerCase();
                const filtered = this.channels.filter(c => c.name.toLowerCase().includes(q));
                this.renderGrid(filtered);
            }

            // 3. PLAYER CORE
            initPlayerInstance() {
                const video = document.getElementById('video');
                const container = document.getElementById('videoContainer');
                
                this.player = new shaka.Player(video);
                this.ui = new shaka.ui.Overlay(this.player, container, video);

                // Configure Shaka UI Controls
                const uiConfig = {
                    'controlPanelElements': [
                        'play_pause', 'time_and_duration', 'spacer',
                        'mute', 'volume',
                        'quality', 'language', // Multi-audio & Quality Support
                        'picture_in_picture', 'fullscreen', 'overflow_menu'
                    ],
                    'overflowMenuButtons': ['quality', 'language', 'captions', 'playback_rate']
                };
                this.ui.configure(uiConfig);

                // Add Custom Aspect Ratio Button to DOM
                this.addAspectButton();

                // Listen for Errors
                this.player.addEventListener('error', (e) => console.error('Error code', e.detail.code, 'object', e.detail));
                
                // Buffer Spinner
                this.player.addEventListener('buffering', (e) => {
                    document.getElementById('bufferingSpinner').style.display = e.buffering ? 'inline-block' : 'none';
                });
            }

            addAspectButton() {
                // We inject a custom button into the Shaka controls via DOM manipulation
                // because shaka's API for custom buttons is verbose for a single file.
                // We run this after a short delay to ensure UI is rendered.
                setTimeout(() => {
                    const controls = document.querySelector('.shaka-controls-button-panel');
                    if (controls && !document.getElementById('aspectBtn')) {
                        const btn = document.createElement('button');
                        btn.id = 'aspectBtn';
                        btn.className = 'shaka-custom-btn material-icons';
                        btn.textContent = 'aspect_ratio';
                        btn.title = 'Change Aspect Ratio';
                        btn.onclick = () => this.toggleAspect();
                        // Insert before the last element (usually overflow menu or fullscreen)
                        controls.insertBefore(btn, controls.lastElementChild);
                    }
                }, 1000); // 1 sec delay to be safe
            }

            async playChannel(index) {
                const ch = this.channels[index];
                const video = document.getElementById('video');
                
                // Toggle Views
                document.getElementById('gridView').classList.add('hidden');
                document.getElementById('playerView').classList.remove('hidden');
                document.getElementById('playerTitle').innerText = ch.name;
                document.getElementById('bufferingSpinner').style.display = 'inline-block';

                // --- 1. DRM CONFIGURATION ---
                let drmConfig = { clearKeys: {} };
                if (ch.props.kodi && ch.props.kodi['inputstream.adaptive.license_key']) {
                    const keys = ch.props.kodi['inputstream.adaptive.license_key'];
                    // Logic to handle multiple keys if separated by pipes
                    // Format: kid:key|kid:key or just kid:key
                    const pairs = keys.split('|'); 
                    pairs.forEach(p => {
                        if(p.includes(':')) {
                            const [k, v] = p.split(':');
                            drmConfig.clearKeys[k] = v;
                        }
                    });
                }

                // --- 2. NETWORK FILTERS (THE CRITICAL FIX) ---
                this.player.getNetworkingEngine().clearAllRequestFilters();
                this.player.getNetworkingEngine().registerRequestFilter((type, request) => {
                    
                    // A. Set User-Agent (Always)
                    if (ch.props.ua) {
                        request.headers['User-Agent'] = ch.props.ua;
                    }

                    // B. Set Referer (Always standard)
                    request.headers['Referer'] = 'https://jiotv.com/';

                    // C. TOKEN & COOKIE LOGIC
                    // 1. Is there a token in the URL already?
                    let hasUrlToken = ch.url.includes('__hdnea__');
                    
                    // 2. Is there a token in the Cookie?
                    let cookieVal = ch.props.cookie || "";
                    let hasCookieToken = cookieVal.includes('__hdnea__');
                    
                    // D. Apply Cookie Header
                    if (cookieVal) {
                        request.headers['Cookie'] = cookieVal;
                    }

                    // E. Append Token to URL if missing (For Manifest & Segments)
                    if (type === shaka.net.NetworkingEngine.RequestType.MANIFEST || 
                        type === shaka.net.NetworkingEngine.RequestType.SEGMENT) {
                        
                        // If the URL is "clean" (no token) BUT we have a cookie token,
                        // we must extract the token from the cookie and append it.
                        // This handles the "mpd with cookie" scenario.
                        if (!hasUrlToken && hasCookieToken) {
                            const tokenMatch = cookieVal.match(/__hdnea__=[^;]+/);
                            if (tokenMatch) {
                                const token = tokenMatch[0];
                                
                                // Append to all request URIs
                                request.uris = request.uris.map(uri => {
                                    // double check to prevent recursion
                                    if (uri.includes('__hdnea__')) return uri; 
                                    const separator = uri.includes('?') ? '&' : '?';
                                    return uri + separator + token;
                                });
                            }
                        }
                    }
                });

                // --- 3. CONFIGURE & LOAD ---
                this.player.configure({
                    drm: drmConfig,
                    streaming: {
                        bufferingGoal: 30,
                        rebufferingGoal: 5,
                        retryParameters: { maxAttempts: 5, timeout: 5000, backoffFactor: 2 }
                    },
                    preferredAudioLanguage: 'hi' // Auto-select Hindi if available
                });

                try {
                    await this.player.load(ch.url);
                    video.play();
                } catch (e) {
                    console.error("Load Error", e);
                    alert("Stream failed to load. See console for details.");
                }
            }

            closePlayer() {
                document.getElementById('video').pause();
                this.player.unload();
                document.getElementById('playerView').classList.add('hidden');
                document.getElementById('gridView').classList.remove('hidden');
            }

            toggleAspect() {
                const v = document.getElementById('video');
                // Remove current
                v.classList.remove(this.aspectModes[this.currentAspectIndex]);
                // Next
                this.currentAspectIndex = (this.currentAspectIndex + 1) % this.aspectModes.length;
                // Add new
                v.classList.add(this.aspectModes[this.currentAspectIndex]);
                
                // Show toast (simple alert substitute)
                const btn = document.getElementById('aspectBtn');
                if(btn) btn.title = "Current: " + this.aspectNames[this.currentAspectIndex];
            }
        }

        // Initialize App
        const app = new StreamApp();
        document.addEventListener('DOMContentLoaded', () => app.init());

    </script>
</body>
</html>
