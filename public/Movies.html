<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>World4uFree Movies</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #121824;
      --card: #161e2b;
      --text: #e5e7eb;
      --muted: #9aa4b2;
      --accent: #f59e0b;
      --border: rgba(255,255,255,0.08);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Manrope', system-ui, sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(245, 158, 11, 0.12), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(14, 165, 233, 0.12), transparent 55%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px 16px 50px; }
    header { display: flex; gap: 14px; flex-wrap: wrap; align-items: center; margin-bottom: 16px; }
    .title { font-size: 1.7rem; font-weight: 800; letter-spacing: 0.5px; }
    .pill { font-size: 12px; padding: 6px 10px; border: 1px solid var(--border); border-radius: 999px; color: var(--muted); background: rgba(18, 24, 36, 0.7); }

    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-left: auto; }
    .search { min-width: 220px; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--panel); color: var(--text); }
    .search::placeholder { color: #64748b; }
    .btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      cursor: pointer;
      font-size: 13px;
      transition: border 0.2s ease, transform 0.2s ease;
    }
    .btn:hover:not(:disabled) { border-color: var(--accent); transform: translateY(-1px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .page-info { font-size: 12px; color: var(--muted); min-width: 120px; text-align: center; }

    .status { margin: 18px 0; padding: 14px; border: 1px dashed var(--border); border-radius: 12px; background: rgba(18, 24, 36, 0.7); color: var(--muted); display: none; }
    .spinner { width: 22px; height: 22px; border: 3px solid rgba(255,255,255,0.15); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.9s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; align-items: stretch; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; display: grid; grid-template-rows: auto 1fr; min-height: 245px; cursor: pointer; transition: transform 0.2s ease, border 0.2s ease; }
    .card:hover { transform: translateY(-2px); border-color: var(--accent); }
    .thumb { width: 100%; height: 240px; object-fit: cover; object-position: top; background: #0b1018; display: block; }
    .card-body { padding: 12px 14px 14px; display: grid; gap: 6px; align-content: start; }
    .card-title { font-size: 14px; font-weight: 600; line-height: 1.35; min-height: 38px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .card-meta { font-size: 11px; color: var(--muted); margin-top: auto; }

    .detail { display: none; margin-top: 16px; }
    .detail.show { display: block; }
    .detail-header { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; flex-wrap: wrap; }
    .detail-title { font-size: 1.4rem; font-weight: 700; line-height: 1.3; }
    .detail-grid { display: grid; grid-template-columns: minmax(180px, 280px) 1fr; gap: 18px; align-items: start; }
    .poster { width: 100%; aspect-ratio: 2 / 3; border-radius: 12px; border: 1px solid var(--border); background: #0b1018; object-fit: cover; }
    .detail-panel { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 14px; }
    .detail-list { display: grid; gap: 8px; font-size: 13px; color: var(--text); }
    .detail-list span { color: var(--muted); }
    .shots { margin-top: 16px; }
    .shots-grid { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 6px; }
    .shots-grid img { width: 180px; height: 120px; border-radius: 10px; border: 1px solid var(--border); background: #0b1018; object-fit: cover; flex: 0 0 auto; }
    .links { margin-top: 16px; }
    .links a { display: inline-block; margin: 6px 8px 0 0; padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: var(--text); text-decoration: none; font-size: 12px; }
    .links a.primary { background: var(--accent); color: #0b0f14; border-color: rgba(0,0,0,0.2); font-weight: 700; }

    footer { margin-top: 22px; font-size: 12px; color: var(--muted); text-align: center; }

    @media (max-width: 640px) {
      .title { font-size: 1.4rem; }
      .grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
      .thumb { height: 240px; }
      .search { min-width: 160px; }
      .detail-grid { grid-template-columns: 1fr; }
      .detail-title { font-size: 1.2rem; }
      .detail-panel { padding: 12px; }
      .shots-grid img { width: 150px; height: 100px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">World4uFree Movies</div>
      <div class="pill">WP JSON Feed</div>
      <div class="toolbar">
        <input id="searchInput" class="search" type="text" placeholder="Search movies..." />
        <button id="searchBtn" class="btn">Search</button>
        <button id="clearBtn" class="btn">Clear</button>
        <input id="pageInput" class="search" type="number" min="1" placeholder="Go to page" style="max-width:120px;" />
        <button id="goBtn" class="btn">Go</button>
        <div id="pageInfo" class="page-info">Page 1</div>
      </div>
    </header>

    <div id="status" class="status"></div>
    <div id="grid" class="grid"></div>
    <div id="detail" class="detail">
      <div class="detail-header">
        <button id="backBtn" class="btn">Back</button>
        <div id="detailTitle" class="detail-title"></div>
      </div>
      <div class="detail-grid">
        <img id="detailPoster" class="poster" alt="Poster" />
        <div class="detail-panel">
          <div id="detailInfo" class="detail-list"></div>
        </div>
      </div>
      <div class="shots">
        <h3>Screenshot</h3>
        <div id="detailShots" class="shots-grid"></div>
      </div>
      <div class="links">
        <h3>Download Links</h3>
        <div id="detailLinks"></div>
      </div>
    </div>

    <footer>Click any card to open the post. Use search and pagination to browse the catalog.</footer>
  </div>

  <script>
    const API = 'https://world4ufree.deals/wp-json/wp/v2/posts';
    const grid = document.getElementById('grid');
    const statusEl = document.getElementById('status');
    const pageInfo = document.getElementById('pageInfo');
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const clearBtn = document.getElementById('clearBtn');
    const pageInput = document.getElementById('pageInput');
    const goBtn = document.getElementById('goBtn');
    const detail = document.getElementById('detail');
    const detailTitle = document.getElementById('detailTitle');
    const detailPoster = document.getElementById('detailPoster');
    const detailInfo = document.getElementById('detailInfo');
    const detailShots = document.getElementById('detailShots');
    const detailLinks = document.getElementById('detailLinks');
    const backBtn = document.getElementById('backBtn');

    const state = {
      page: 1,
      perPage: 12,
      totalPages: 1,
      loading: false,
      query: ''
    };

    let lastPosts = [];

    function showStatus(message, loading = false) {
      statusEl.style.display = 'block';
      statusEl.innerHTML = loading ? `<span class="spinner"></span>${message}` : message;
    }

    function hideStatus() {
      statusEl.style.display = 'none';
      statusEl.innerHTML = '';
    }

    function decodeHtml(html) {
      const t = document.createElement('textarea');
      t.innerHTML = html;
      return t.value;
    }

    function formatDate(dateStr) {
      try {
        return new Date(dateStr).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
      } catch {
        return dateStr || '';
      }
    }

    function getImage(post) {
      const contentHtml = post?.content?.rendered || '';
      const images = extractImagesFromContent(contentHtml);
      const pngPoster = images.find(src => /\.png(\?|$)/i.test(src));
      if (pngPoster) return pngPoster;
      return images[0]
        || post.yoast_head_json?.og_image?.[0]?.url
        || post._embedded?.['wp:featuredmedia']?.[0]?.source_url
        || '';
    }

    function extractImagesFromContent(html) {
      const doc = new DOMParser().parseFromString(html || '', 'text/html');
      const imgs = Array.from(doc.querySelectorAll('img'))
        .map(img => img.getAttribute('src') || '')
        .filter(Boolean);
      return imgs;
    }

    function extractTextLines(html) {
      const doc = new DOMParser().parseFromString(html || '', 'text/html');
      const text = doc.body.textContent || '';
      return text.split('\n').map(t => t.trim()).filter(t => t.length > 0);
    }

    function extractLinks(html) {
      const doc = new DOMParser().parseFromString(html || '', 'text/html');
      return Array.from(doc.querySelectorAll('a'))
        .map(a => ({
          href: a.getAttribute('href') || '',
          text: (a.textContent || '').trim()
        }))
        .filter(a => a.href);
    }

    function extractDownloadLinks(html) {
      const doc = new DOMParser().parseFromString(html || '', 'text/html');
      const links = [];
      let afterDownload = false;

      const isDownloadMarker = (el) => {
        if (!el || !el.textContent) return false;
        const tag = el.tagName ? el.tagName.toLowerCase() : '';
        if (!['h1','h2','h3','h4','h5','h6','p','strong','em','span','div'].includes(tag)) return false;
        return /download/i.test(el.textContent);
      };

      const walker = document.createTreeWalker(doc.body, NodeFilter.SHOW_ELEMENT, null);
      while (walker.nextNode()) {
        const el = walker.currentNode;
        if (!afterDownload && isDownloadMarker(el)) {
          afterDownload = true;
        }
        if (afterDownload && el.tagName && el.tagName.toLowerCase() === 'a') {
          const href = el.getAttribute('href') || '';
          const text = (el.textContent || '').trim();
          if (href) links.push({ href, text });
        }
      }

      return links;
    }

    function openDetail(post) {
      const content = post?.content?.rendered || '';
      const title = decodeHtml(post?.title?.rendered || 'Untitled');
      const images = extractImagesFromContent(content);
      const pngPoster = images.find(src => /\.png(\?|$)/i.test(src));
      const poster = pngPoster || images[0] || getImage(post) || '';
      const screenshots = images.filter(src => src !== poster);
      const textLines = extractTextLines(content);
      const infoLines = textLines.filter(line => line.includes(':')).slice(0, 12);
      let links = extractDownloadLinks(content);
      const allLinks = extractLinks(content);
      const qualityLinks = allLinks.filter(l => /1080|720|480|hdrip|webrip|web-dl|hdtv|x264|x265|hevc|mb|gb/i.test(l.text || l.href));
      if (links.length || qualityLinks.length) {
        const seen = new Set();
        links = [...links, ...qualityLinks].filter(l => {
          if (!l.href || seen.has(l.href)) return false;
          seen.add(l.href);
          return true;
        });
      } else {
        links = allLinks;
      }

      const primaryLinks = [];
      const otherLinks = [];
      links.forEach(l => {
        const t = l.text.toLowerCase();
        if (t.includes('1080') || t.includes('720') || t.includes('480')) primaryLinks.push(l);
        else if (t.includes('download') || t.includes('hdrip') || t.includes('mb')) primaryLinks.push(l);
        else otherLinks.push(l);
      });
      const orderedLinks = [...primaryLinks, ...otherLinks];

      detailTitle.textContent = title;
      detailPoster.src = poster;
      detailPoster.style.display = poster ? 'block' : 'none';

      if (infoLines.length) {
        detailInfo.innerHTML = infoLines.map(line => {
          const parts = line.split(':');
          const key = parts.shift().trim();
          const value = parts.join(':').trim();
          return `<div><span>${key}:</span> ${value}</div>`;
        }).join('');
      } else {
        detailInfo.innerHTML = '<div><span>Details:</span> Not available</div>';
      }

      detailShots.innerHTML = screenshots.map(src => `<img src="${src}" alt="Screenshot" loading="lazy" />`).join('');
      if (!screenshots.length) {
        detailShots.innerHTML = '<div class="card-meta">No screenshots found.</div>';
      }

      detailLinks.innerHTML = orderedLinks.map(l => {
        const label = l.text || l.href;
        const isPrimary = /1080|720|480/i.test(label);
        return `<a class="${isPrimary ? 'primary' : ''}" href="${l.href}" target="_blank" rel="noopener">${label}</a>`;
      }).join('');
      if (!orderedLinks.length) {
        detailLinks.innerHTML = '<div class="card-meta">No download links found.</div>';
      }

      grid.style.display = 'none';
      detail.classList.add('show');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function fetchPostById(id) {
      const res = await fetch(`${API}/${id}?_embed=1`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    function closeDetail() {
      detail.classList.remove('show');
      grid.style.display = '';
    }

    function renderPosts(posts) {
      if (!posts.length) {
        showStatus('No posts found.', false);
        grid.innerHTML = '';
        return;
      }

      hideStatus();
      lastPosts = posts;
      grid.innerHTML = posts.map(p => {
        const title = decodeHtml(p.title?.rendered || 'Untitled');
        const img = getImage(p);
        const date = formatDate(p.date);
        return `
          <article class="card" data-id="${p.id}" data-link="${p.link || ''}">
            <img class="thumb" src="${img}" alt="${title}" loading="lazy" onerror="this.style.display='none'" />
            <div class="card-body">
              <div class="card-title">${title}</div>
              <div class="card-meta">${date}</div>
            </div>
          </article>
        `;
      }).join('');

      grid.querySelectorAll('.card[data-id]').forEach(card => {
        const id = card.getAttribute('data-id');
        card.addEventListener('click', async () => {
          try {
            const cached = lastPosts.find(p => String(p.id) === String(id));
            const post = cached && cached.content ? cached : await fetchPostById(id);
            openDetail(post);
          } catch (e) {
            console.error(e);
            const link = card.getAttribute('data-link');
            if (link) window.open(link, '_blank', 'noopener');
          }
        });
      });
    }

    async function loadPage(page) {
      if (state.loading) return;
      state.loading = true;
      showStatus('Loading posts...', true);
      if (goBtn) goBtn.disabled = true;

      try {
        const params = new URLSearchParams({
          per_page: state.perPage,
          page: page,
          _embed: '1'
        });
        if (state.query) params.set('search', state.query);

        const res = await fetch(`${API}?${params.toString()}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const total = parseInt(res.headers.get('X-WP-TotalPages') || '1', 10);
        state.totalPages = Number.isFinite(total) ? total : 1;
        state.page = page;

        const posts = await res.json();
        renderPosts(posts);
      } catch (err) {
        console.error(err);
        showStatus('Failed to load posts. Please try again.', false);
        grid.innerHTML = '';
      } finally {
        state.loading = false;
        pageInfo.textContent = `Page ${state.page} of ${state.totalPages}`;
        if (goBtn) goBtn.disabled = false;
        if (pageInput) pageInput.value = String(state.page);
      }
    }

    function runSearch() {
      state.query = (searchInput.value || '').trim();
      state.page = 1;
      loadPage(1);
    }

    searchBtn.addEventListener('click', runSearch);
    clearBtn.addEventListener('click', () => {
      searchInput.value = '';
      state.query = '';
      state.page = 1;
      loadPage(1);
    });
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') runSearch();
    });

    function goToPage() {
      const p = parseInt(pageInput.value, 10);
      if (!p) return;
      const target = Math.max(1, Math.min(state.totalPages, p));
      loadPage(target);
    }

    goBtn.addEventListener('click', goToPage);
    pageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') goToPage();
    });

    backBtn.addEventListener('click', closeDetail);

    loadPage(1);
  </script>
</body>
</html>
