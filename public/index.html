<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova TV</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.7.11/dist/shaka-player.compiled.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.js"></script>

    <style>
        :root {
            --bg: #09090b;
            --bg2: #18181b;
            --card: rgba(39, 39, 42, 0.5);
            --accent: #a855f7;
            --accent2: #c084fc;
            --border: rgba(255, 255, 255, 0.08);
            --text: #fafafa;
            --text2: #a1a1aa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* Login */
        .login {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(ellipse at top, #1e1b4b 0%, var(--bg) 70%);
        }

        .login-box {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 360px;
            text-align: center;
            margin: 20px;
        }

        .login-box h1 {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, #a855f7, #ec4899);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 6px;
        }

        .login-box .sub {
            color: var(--text2);
            font-size: 13px;
            margin-bottom: 24px;
        }

        .login-box input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: #fff;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .login-box input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .login-box button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #a855f7, #9333ea);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .login-box button:hover {
            opacity: 0.9;
        }

        .login-err {
            color: #f87171;
            font-size: 12px;
            margin-top: 10px;
            display: none;
        }

        /* App */
        .app {
            display: none;
        }

        header {
            background: rgba(9, 9, 11, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            flex-wrap: wrap;
        }

        .logo {
            font-size: 1.3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #a855f7, #ec4899);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tabs {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text2);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
        }

        .tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }

        .tab:hover:not(.active) {
            border-color: var(--accent);
        }

        .stats {
            margin-left: auto;
            font-size: 11px;
            color: var(--text2);
        }

        main {
            padding: 16px 20px;
        }

        /* Player */
        .player-box {
            display: none;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
        }

        .player-box.active {
            display: block;
        }

        .player-wrap {
            position: relative;
            background: #000;
        }

        .player-wrap video {
            width: 100%;
            height: 100%;
            aspect-ratio: 16/9;
            background: #000;
            display: block;
            transition: transform 0.3s ease-in-out, width 0.3s, height 0.3s;
            transform-origin: center center;
        }

        .player-wrap iframe {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            display: block;
            border: none;
        }

        .close-x {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            z-index: 20;
        }

        .close-x:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Player Overlay */
        .player-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 15;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: sp 0.8s linear infinite;
            display: none;
        }

        .player-box.loading .loader {
            display: block;
        }

        .player-box.buffering .loader {
            display: block;
        }

        @keyframes sp {
            to {
                transform: rotate(360deg);
            }
        }

        /* Custom Controls */
        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
            padding: 12px 16px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }

        .player-wrap:hover .controls {
            opacity: 1;
        }

        .progress-wrap {
            margin-bottom: 10px;
            cursor: pointer;
        }

        .progress-bar {
            height: 5px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            position: relative;
        }

        .progress-buffer {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .progress-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
        }

        .progress-handle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 14px;
            height: 14px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .progress-wrap:hover .progress-handle {
            opacity: 1;
        }

        .ctrl-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Responsive player controls - compress down to single-line at very small widths */
        @media (max-width: 480px) {
            .controls {
                padding: 8px 10px;
            }

            .ctrl-row {
                gap: 8px;
            }

            .ctrl-btn {
                font-size: 16px;
                padding: 3px;
            }

            .vol-slider {
                display: none;
            }

            .time {
                display: none;
            }

            .progress-wrap {
                margin-bottom: 8px;
            }

            .progress-bar {
                height: 4px;
            }

            .now-bar img {
                width: 40px;
                height: 40px;
            }

            .now-bar h4 {
                font-size: 13px;
            }

            .now-bar p {
                display: none;
            }
        }

        @media (max-width: 320px) {
            .controls {
                padding: 6px 8px;
            }

            .ctrl-row {
                gap: 6px;
            }

            .ctrl-btn {
                font-size: 15px;
                padding: 2px;
            }

            .btn-group {
                padding: 2px 4px;
            }

            .progress-wrap {
                display: none;
            }

            .quality {
                padding: 2px 6px;
                font-size: 10px;
            }

            .now-bar {
                padding: 8px 10px;
            }

            .now-bar img {
                width: 36px;
                height: 36px;
            }

            .now-bar h4 {
                font-size: 12px;
            }

            .now-bar .quality {
                margin-left: 8px;
            }
        }

        /* Tight single-line mode when viewport <= 300px */
        @media (max-width: 300px) {

            .player-wrap video,
            .player-wrap iframe {
                aspect-ratio: 16/9;
            }

            .controls {
                padding: 4px 6px;
            }

            .ctrl-row {
                gap: 4px;
                align-items: center;
            }

            .ctrl-left,
            .ctrl-right {
                gap: 4px;
            }

            .ctrl-btn {
                font-size: 14px;
                padding: 2px;
            }

            .btn-group {
                padding: 1px 4px;
            }

            .time,
            .vol-wrap,
            .search,
            .speedSelector,
            .qualitySelector {
                display: none !important;
            }

            .progress-wrap {
                display: none !important;
            }

            .now-bar {
                padding: 6px 8px;
                gap: 8px;
            }

            .now-bar img {
                width: 32px;
                height: 32px;
            }

            .now-bar h4 {
                font-size: 11px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .now-bar p {
                display: none;
            }

            .now-bar .quality {
                display: inline-block;
                margin-left: auto;
                padding: 2px 6px;
                font-size: 10px;
            }

            .player-box {
                border-radius: 6px;
            }

            /* Ensure controls stay on one line and overflow gracefully */
            .controls,
            .now-bar {
                display: flex;
                flex-wrap: nowrap;
                align-items: center;
            }

            .ctrl-left {
                flex: 0 1 auto;
            }

            .ctrl-right {
                flex: 0 1 auto;
                margin-left: 6px;
            }
        }

        .ctrl-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ctrl-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ctrl-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            opacity: 0.9;
            transition: opacity 0.2s, transform 0.2s;
        }

        .ctrl-btn:hover:not(:disabled) {
            opacity: 1;
            transform: scale(1.1);
        }

        .ctrl-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 4px;
            align-items: center;
            padding: 2px 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }

        .seek-group {
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .seek-group .ctrl-btn {
            font-size: 14px;
        }

        .ctrl-left {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .time {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-variant-numeric: tabular-nums;
        }

        .vol-wrap {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .vol-slider {
            width: 60px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            cursor: pointer;
        }

        .vol-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
        }

        /* Status Indicators */
        .status-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            z-index: 20;
            display: none;
        }

        .status-badge.live {
            background: #ef4444;
            display: block;
        }

        .status-badge.vod {
            background: #22c55e;
            display: block;
        }

        /* Fix URL Modal */
        .fix-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .fix-modal.show {
            display: flex;
        }

        .fix-modal-content {
            background: #18181b;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .fix-modal h3 {
            margin-bottom: 15px;
            color: #fff;
        }

        .fix-modal input {
            width: 100%;
            padding: 10px;
            background: #09090b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            border-radius: 6px;
            margin-bottom: 10px;
            font-family: monospace;
        }

        .fix-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .fix-test-btn {
            padding: 8px 16px;
            background: #a855f7;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
        }

        .fix-close-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #ccc;
            cursor: pointer;
        }


        /* Now Bar */
        .now-bar {
            padding: 12px 16px;
            background: var(--bg2);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .now-bar img {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--bg);
        }

        .now-bar h4 {
            font-size: 14px;
            font-weight: 600;
        }

        .now-bar p {
            font-size: 11px;
            color: var(--text2);
        }

        .now-bar .quality {
            margin-left: auto;
            padding: 4px 8px;
            background: var(--accent);
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search {
            flex: 1;
            min-width: 180px;
            max-width: 320px;
            padding: 10px 14px;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
        }

        .search:focus {
            outline: none;
            border-color: var(--accent);
        }

        .search::placeholder {
            color: #52525b;
        }

        .pager {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
        }

        .pg-btn {
            padding: 8px 14px;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
        }

        .pg-btn:hover:not(:disabled) {
            border-color: var(--accent);
        }

        .pg-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pg-info {
            font-size: 12px;
            color: var(--text2);
            min-width: 60px;
            text-align: center;
        }

        /* Grid - Optimized for density (4 in one line on small screens) */
        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        @media (min-width: 640px) {
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 16px;
            }
        }

        @media (max-width: 639px) {
            .grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }

            .card .info h3 {
                font-size: 11px;
            }

            .card .info p {
                font-size: 9px;
            }

            .card .info {
                padding: 6px;
            }
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .card:hover {
            background: rgba(168, 85, 247, 0.1);
            border-color: rgba(168, 85, 247, 0.5);
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(168, 85, 247, 0.2);
        }

        .thumb {
            width: 100%;
            aspect-ratio: 16/10;
            background: var(--bg2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 700;
            color: var(--accent);
            overflow: hidden;
            position: relative;
        }

        .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Performance optimization */
        .card {
            content-visibility: auto;
            contain-intrinsic-size: 200px;
        }

        .thumb.loading::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg,
                    rgba(255, 255, 255, 0.05) 0%,
                    rgba(255, 255, 255, 0.15) 50%,
                    rgba(255, 255, 255, 0.05) 100%);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .play-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .card:hover .play-overlay {
            opacity: 1;
        }

        .play-btn {
            width: 56px;
            height: 56px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(168, 85, 247, 0.5);
        }

        .play-btn svg {
            width: 24px;
            height: 24px;
            fill: #fff;
            margin-left: 4px;
        }

        .info {
            padding: 12px;
        }

        .info h3 {
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .info p {
            font-size: 11px;
            color: var(--text2);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .empty {
            text-align: center;
            padding: 48px;
            color: var(--text2);
        }

        .spin {
            width: 28px;
            height: 28px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: sp 0.7s linear infinite;
            margin: 0 auto 10px;
        }

        /* Sub Menu Bar */
        .sub-menu-bar {
            display: none;
            gap: 10px;
            padding: 12px 20px;
            background: rgba(24, 24, 27, 0.8);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            position: sticky;
            top: 72px;
            /* Set below header */
            z-index: 90;
        }

        .sub-menu-bar::-webkit-scrollbar {
            display: none;
        }

        .sub-menu-btn {
            padding: 8px 16px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text2);
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sub-menu-btn:hover {
            border-color: var(--accent);
            color: #fff;
            transform: translateY(-1px);
        }

        .sub-menu-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
        }

        /* Bottom Pagination */
        .bottom-pager {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 24px 0;
            margin-top: 20px;
            border-top: 1px solid var(--border);
        }

        /* Webpage Container */
        .webpage-box {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 200;
            background: var(--bg);
            overflow: auto;
        }

        .webpage-box.active {
            display: block;
        }

        .webpage-header {
            position: sticky;
            top: 0;
            z-index: 210;
            background: rgba(15, 15, 18, 0.98);
            backdrop-filter: blur(20px);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .webpage-btn {
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .webpage-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .webpage-btn.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        #webpageConsole {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: rgba(0, 0, 0, 0.9);
            color: #0f0;
            font-family: 'Consolas', monospace;
            font-size: 11px;
            padding: 10px;
            overflow-y: auto;
            z-index: 220;
            display: none;
            border-top: 2px solid var(--primary);
            pointer-events: none;
        }

        #webpageConsole.active {
            display: block;
        }

        .log-entry {
            margin-bottom: 4px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 2px;
        }

        .log-error {
            color: #f44;
        }

        .log-warn {
            color: #ff0;
        }

        .webpage-header h3 {
            flex: 1;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .webpage-close {
            padding: 8px 16px;
            background: var(--accent);
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .webpage-content {
            min-height: 100vh;
            background: #fff;
            color: #000;
        }

        /* Global Loading Indicator */
        #globalLoader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #6366f1, transparent);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #globalLoader.active {
            opacity: 1;
        }

        /* Buffering Indicator */
        .buffering-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border: 4px solid rgba(99, 102, 241, 0.2);
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            opacity: 0;
            pointer-events: none;
            z-index: 100;
        }

        .buffering-indicator.active {
            opacity: 1;
        }

        @keyframes spin {
            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        /* Jio TV / Sports Modern UI */
        #jiotvSportsContainer {
            padding: 20px;
        }

        .jiotv-header {
            margin-bottom: 24px;
        }

        .jiotv-search-bar {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .jiotv-search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 16px;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            outline: none;
        }

        .jiotv-search-input:focus {
            border-color: var(--accent);
        }

        .jiotv-language-select {
            padding: 12px 16px;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            outline: none;
            cursor: pointer;
        }

        .jiotv-btn-primary {
            padding: 12px 24px;
            background: linear-gradient(135deg, #a855f7, #ec4899);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .jiotv-btn-primary:hover {
            opacity: 0.9;
        }

        .jiotv-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }

        .jiotv-channel-card {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }

        .jiotv-channel-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent);
        }

        .jiotv-channel-logo {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
            background: var(--bg);
        }

        .jiotv-channel-info {
            padding: 12px;
        }

        .jiotv-channel-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .jiotv-channel-group {
            font-size: 12px;
            color: var(--text2);
        }

        /* Shaka Player Custom UI */
        #shakaPlayerContainer {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 10000;
            display: none;
            flex-direction: column;
        }

        #shakaPlayerContainer.active {
            display: flex;
        }

        #shakaVideo {
            flex: 1;
            width: 100%;
            background: #000;
        }

        .shaka-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #shakaPlayerContainer:hover .shaka-controls {
            opacity: 1;
        }

        .shaka-controls-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .shaka-title {
            color: #fff;
            font-size: 18px;
            font-weight: 600;
        }

        .shaka-controls-bottom {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .shaka-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .shaka-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .shaka-volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .shaka-volume-slider {
            width: 100px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            cursor: pointer;
        }

        .shaka-quality-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        .shaka-aspect-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        /* Network Status Indicator */
        .network-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            font-size: 12px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            z-index: 9999;
        }

        .network-status.show {
            opacity: 1;
            transform: translateY(0);
        }

        .network-status.online {
            border-left: 3px solid #10b981;
        }

        .network-status.offline {
            border-left: 3px solid #ef4444;
        }

        /* Search Loading State */
        .search.loading {
            background-image: linear-gradient(90deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.05) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        /* Responsive Design */
        @media (min-width: 1400px) {
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }

        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 14px;
            }

            header {
                padding: 12px 20px;
            }
        }

        @media (max-width: 768px) {
            header {
                padding: 10px 15px;
            }

            .logo {
                font-size: 1.1rem;
            }

            .tab {
                padding: 6px 12px;
                font-size: 10px;
            }

            .grid {
                gap: 8px;
            }

            .player-wrap video,
            .player-wrap iframe {
                aspect-ratio: 16/9;
            }

            .ctrl-btn {
                font-size: 16px;
                padding: 4px;
            }

            .time {
                font-size: 10px;
            }

            .vol-wrap {
                display: none;
            }
        }

        @media (max-width: 600px) {
            header {
                flex-direction: column;
                gap: 8px;
                padding: 10px;
            }

            .stats {
                margin-left: 0;
                font-size: 10px;
                text-align: left;
                margin-top: 0;
            }

            .toolbar {
                flex-direction: column;
                gap: 6px;
                align-items: stretch;
                padding: 0 8px;
            }

            .search {
                max-width: 100%;
                width: 100%;
                padding: 8px 12px;
                font-size: 12px;
            }

            .pager {
                justify-content: space-between;
                width: 100%;
            }

            .pg-btn {
                padding: 6px 10px;
                font-size: 11px;
            }

            .pg-info {
                font-size: 11px;
            }

            .ctrl-row {
                flex-wrap: nowrap;
                justify-content: space-between;
                gap: 4px;
                overflow-x: auto;
                scrollbar-width: none;
            }

            .ctrl-row::-webkit-scrollbar {
                display: none;
            }

            .ctrl-left,
            .ctrl-right {
                width: auto;
                justify-content: flex-start;
                margin: 0;
                gap: 4px;
            }

            .time {
                width: auto;
                text-align: left;
                margin-top: 0;
                font-size: 9px;
            }

            .btn-group {
                padding: 1px 3px;
                border-radius: 4px;
                gap: 2px;
            }

            .ctrl-btn {
                font-size: 11px;
                padding: 1px;
                min-width: 28px;
                min-height: 28px;
            }

            .seek-group .ctrl-btn {
                font-size: 9px;
            }

            .now-bar {
                padding: 6px 10px;
            }

            .now-bar img {
                width: 28px;
                height: 28px;
            }

            .now-bar h4 {
                font-size: 12px;
            }

            .now-bar p {
                font-size: 9px;
            }

            .webpage-header {
                padding: 10px;
                gap: 8px;
            }

            .webpage-btn {
                padding: 6px 10px;
                font-size: 11px;
            }

            .webpage-header h3 {
                font-size: 12px;
                display: none;
                /* Hide title on very small screens to save space */
            }
        }

        @media (max-width: 480px) {
            .grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }

            .card .info h3 {
                font-size: 10px;
                line-height: 1.2;
                height: 2.4em;
                overflow: hidden;
            }

            .card .info p {
                font-size: 8px;
            }

            .card .info {
                padding: 4px;
            }

            main {
                padding: 8px 10px;
            }
        }

        @media (max-width: 360px) {
            .grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 4px;
            }

            .logo {
                font-size: 0.9rem;
            }

            .tab {
                padding: 4px 8px;
                font-size: 9px;
            }
        }

        /* Landscape mobile optimization */
        @media (max-width: 900px) and (max-height: 500px) and (orientation: landscape) {
            header {
                padding: 8px 15px;
            }

            .logo {
                font-size: 1rem;
            }

            .tab {
                padding: 4px 8px;
                font-size: 9px;
            }

            #playerBox.active {
                padding: 0;
            }

            .player-wrap {
                height: 100vh;
            }

            #controls {
                padding: 8px;
            }
        }
    </style>
</head>

<body>
    <!-- Global Loading Indicator -->
    <div id="globalLoader"></div>

    <!-- Network Status -->
    <div class="network-status" id="networkStatus"></div>

    <div class="login" id="loginScreen">
        <div class="login-box">
            <h1>Nova TV</h1>
            <p class="sub">Enter password</p>
            <input type="password" id="pwInput" placeholder="Password" autofocus>
            <button onclick="doLogin()">Sign In</button>
            <p class="login-err" id="loginErr">Wrong password</p>
        </div>
    </div>

    <div class="app" id="app">
        <header>
            <div class="logo">Nova TV</div>
            <div class="tabs">
                <div><a href="./Movies.html">Movies </a></div>
                <div><a href="./Music.html">Music</a></div>
                <div><a href="./Playersac.html">Playersac</a></div>
                <div><a href="./jtv.html">Jio TV</a></div>
                <div><a href="./jstar.html">Jstar</a></div>
                <div><a href="./pakistan.html">Pakistan</a></div>
                <div><a href="./tera.html">Tera</a></div>
                <div><a href="./Cztech.html">Cztech</a></div>
                <div><a href="./iterlay-com.html">Iterlay</a></div>
                <div><a href="./desileak.html">Desileak</a></div>
                <div><a href="./pornzen.html">Pornzen</a></div>
                <div><a href="./xchut.html">Xchut</a></div>
                <div><a href="./Desibf.html">Desibf</a></div>
                <div><a href="./Vdsblog.html">Vdsblog</a></div>
                <div><a href="./kamatv.html">Kamatv</a></div>
                <div><a href="./zmaal.html">Zmaal </a></div>

                <div class="tab active" data-t="fav">‚≠êFav</div>
                <div class="tab" data-t="koreanpornmovie">üîû Korean Porn Movie</div>
                <div class="tab" data-t="zmaal">ü¶Å Zmaal</div>
                <div class="tab" data-t="wataa">üåü All in One</div>
                <div class="tab" data-t="desitales">üé≠ Desi Tales</div>
                <div class="tab" data-t="xnxxvideos">üîû XnxxVideos</div>
                <div class="tab" data-t="MastiRaja">MastiRaja</div>
                <div class="tab" data-t="iss3">üîû ISS3</div>
                <div class="tab" data-t="noodle">üçú Noodle</div>
                <div class="tab" data-t="xhamster">üêπ xHamster</div>
                <div class="tab" data-t="viralfap">üî• ViralFap</div>
                <div class="tab" data-t="xmazza">üí• XMazaa</div>
                <div class="tab" data-t="fullcinema">üé¨ FullCinema</div>
                <div class="tab" data-t="korean">üá∞üá∑ Korean</div>
                <div class="tab" data-t="movies">üé¨ Movies</div>
                <div class="tab" data-t="moviesecret">üîí Secret</div>
                <div class="tab" data-t="video">üìπ Video</div>
                <div class="tab" data-t="m3u8">üì° M3U8</div>
                <div class="tab" data-t="mp4">üé• MP4</div>
                <div class="tab" data-t="adultiptv">üîû IPTV</div>
                <div class="tab" data-t="erotic">üîû Erotic</div>
                <div class="tab" data-t="tv">üì∫ TV</div>
                <div class="tab" data-t="jiotv">üì∫ Jio TV</div>
                <div class="tab" data-t="sports">‚öΩ Sports</div>
                <div><a href="https://dillzycreations.github.io/Star-Sports-Hindi/"
                        style="color:inherit;text-decoration:none;">Star Sports Hindi</a> |<a
                        href="https://cricketstan.github.io/Allrounder-/world-sports/player.html?id=tnt-sports-1"
                        style="color:inherit;text-decoration:none;">TNT 1</a> | <a
                        href="https://cricketstan.github.io/Allrounder-/world-sports/player.html?id=tnt-sports-2"
                        style="color:inherit;text-decoration:none;">TNT 2</a> | <a
                        href="https://cricketstan.github.io/Allrounder-/world-sports/player.html?id=tnt-sports-3"
                        style="color:inherit;text-decoration:none;">TNT 3</a> | <a
                        href="https://cricketstan.github.io/Allrounder-/world-sports/player.html?id=prime-tv"
                        style="color:inherit;text-decoration:none;">Prime TV</a> | <a
                        href="https://cricketstan.github.io/Allrounder-/world-sports/player.html?id=premier-sports-1"
                        style="color:inherit;text-decoration:none;">Premier 1</a> | <a
                        href="https://cricketstan.github.io/Allrounder-/world-sports/player.html?id=premier-sports-2"
                        style="color:inherit;text-decoration:none;">Premier 2</a> | <a
                        href="https://cricketstan.github.io/Allrounder-/world-sports/player.html?id=fubo-sports-1"
                        style="color:inherit;text-decoration:none;">Fubo 1</a> | <a
                        href="https://cricketstan.github.io/Allrounder-/world-sports/player.html?id=fubo-sports-2"
                        style="color:inherit;text-decoration:none;">Fubo 2</a></div>

            </div>
            <div class="stats" id="stats">Loading...</div>
            <button onclick="openPlayStreamModal()" title="Play Stream URL"
                style="margin-left:12px;padding:8px 12px;border-radius:8px;background:linear-gradient(135deg,#06b6d4,#7c3aed);border:none;color:#fff;cursor:pointer">Play
                Stream</button>
        </header>

        <main>
            <div class="player-box" id="playerBox">
                <div class="player-wrap" id="playerWrap">
                    <button class="close-x" onclick="stopPlayer()">‚úï</button>
                    <div class="status-badge" id="statusBadge"></div>
                    <div class="buffering-indicator" id="bufferingIndicator"></div>
                    <video id="vid"></video>
                    <iframe id="iframePlayer" style="display:none;" allowfullscreen></iframe>
                    <div class="player-overlay">
                        <div class="loader"></div>
                    </div>
                    <div class="controls" id="controls">
                        <div class="progress-wrap" id="progressWrap">
                            <div class="progress-bar">
                                <div class="progress-buffer" id="bufferBar"></div>
                                <div class="progress-fill" id="progressFill"></div>
                                <div class="progress-handle" id="progressHandle"></div>
                            </div>
                        </div>
                        <div class="ctrl-row">
                            <div class="ctrl-left">
                                <div class="btn-group">
                                    <button class="ctrl-btn" id="prevVideoBtn" onclick="playPreviousVideo()"
                                        title="Previous Video (P)">‚èÆÔ∏è</button>
                                    <button class="ctrl-btn" id="fixUrlBtn" onclick="openFixUrlModal()"
                                        title="Fix Stream URL" style="display:none; color: #facc15;">üîß</button>
                                    <button class="ctrl-btn" id="playBtn" onclick="togglePlay()">‚ñ∂</button>
                                    <button class="ctrl-btn" id="nextVideoBtn" onclick="playNextVideo()"
                                        title="Next Video (N)">‚è≠Ô∏è</button>
                                </div>
                                <div class="btn-group seek-group">
                                    <button class="ctrl-btn" onclick="skip(-10)" title="Rewind 10s">‚è™10</button>
                                    <button class="ctrl-btn" onclick="skip(10)" title="Forward 10s">10‚è©</button>
                                </div>
                                <span class="time"><span id="curTime">0:00</span> / <span
                                        id="durTime">0:00</span></span>
                            </div>
                            <div class="ctrl-right">
                                <select id="speedSelector" class="ctrl-btn"
                                    style="font-size:10px;background:rgba(255,255,255,0.1);border:none;color:#fff;padding:2px 5px;border-radius:4px;cursor:pointer;"
                                    title="Playback Speed">
                                    <option value="0.25">0.25x</option>
                                    <option value="0.5">0.5x</option>
                                    <option value="0.75">0.75x</option>
                                    <option value="1" selected>1x</option>
                                    <option value="1.25">1.25x</option>
                                    <option value="1.5">1.5x</option>
                                    <option value="1.75">1.75x</option>
                                    <option value="2">2x</option>
                                </select>
                                <select id="qualitySelector" class="ctrl-btn"
                                    style="display:none;font-size:10px;background:rgba(255,255,255,0.1);border:none;color:#fff;padding:2px 5px;border-radius:4px;cursor:pointer;"
                                    title="Quality"></select>
                                <div class="vol-wrap">
                                    <button class="ctrl-btn" id="muteBtn" onclick="toggleMute()">üîä</button>
                                    <input type="range" class="vol-slider" id="volSlider" min="0" max="1" step="0.1"
                                        value="1">
                                </div>
                                <button class="ctrl-btn" id="aspectBtn" onclick="toggleAspect()"
                                    title="Aspect Ratio">‚¨ú</button>
                                <button class="ctrl-btn" id="rotateBtn" onclick="toggleRotate()"
                                    title="Rotate">üîÑ</button>
                                <button class="ctrl-btn" onclick="toggleFullscreen()">‚õ∂</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="now-bar">
                    <img id="nowImg" src="">
                    <div>
                        <h4 id="nowTitle">-</h4>
                        <p id="nowGroup">-</p>
                    </div>
                    <span class="quality" id="qualityBadge">-</span>
                </div>
            </div>

            <div class="toolbar">
                <input type="text" class="search" id="searchInput" placeholder="Search...">
                <div class="pager" style="display:flex;align-items:center;gap:8px;">
                    <button class="pg-btn" id="prevBtn" onclick="goPage(-1)"
                        style="padding:8px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:#fff;font-size:12px;cursor:pointer;">‚Üê
                        Prev</button>
                    <input type="number" id="pageInput" min="1" value="1"
                        style="width:50px;padding:6px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:#fff;text-align:center;font-size:12px;"
                        onchange="goToPage()">
                    <span class="pg-info" id="pageInfo" style="font-size:12px;color:var(--text2);">/ 1</span>
                    <button class="pg-btn" id="nextBtn" onclick="goPage(1)"
                        style="padding:8px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:#fff;font-size:12px;cursor:pointer;">Next
                        ‚Üí</button>
                    <button class="load-more-btn" id="loadMoreTop" onclick="loadMoreContent()"
                        style="background:linear-gradient(135deg,#a855f7,#ec4899);border:none;color:#fff;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;font-size:12px;margin-left:8px;">üîÑ
                        Load More</button>
                </div>
            </div>

            <!-- Sub Menu for Source-specific navigation -->
            <div id="subMenu" class="sub-menu-bar"></div>

            <!-- Jio TV / Sports Modern UI -->
            <div id="jiotvSportsContainer" style="display:none;">
                <div class="jiotv-header">
                    <div class="jiotv-search-bar">
                        <input type="text" id="jiotvSearch" placeholder="Search channels..." class="jiotv-search-input">
                        <select id="jiotvLanguageFilter" class="jiotv-language-select">
                            <option value="">All Languages</option>
                        </select>
                        <button id="jiotvShowAll" class="jiotv-btn-primary">Show All Channels</button>
                    </div>
                </div>
                <div class="jiotv-grid" id="jiotvGrid"></div>
            </div>

            <div class="grid" id="grid">
                <div class="empty">
                    <div class="spin"></div>Loading...
                </div>
            </div>
            <div class="bottom-pager" id="bottomPager"
                style="display:flex;justify-content:center;align-items:center;gap:8px;padding:16px;">
                <button class="pg-btn" id="prevBtn2" onclick="goPage(-1)"
                    style="padding:8px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:#fff;font-size:12px;cursor:pointer;">‚Üê
                    Prev</button>
                <span class="pg-info" id="pageInfo2" style="font-size:12px;color:var(--text2);">Page 1</span>
                <button class="pg-btn" id="nextBtn2" onclick="goPage(1)"
                    style="padding:8px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:#fff;font-size:12px;cursor:pointer;">Next
                    ‚Üí</button>
                <button class="load-more-btn" id="loadMoreBottom" onclick="loadMoreContent()"
                    style="background:linear-gradient(135deg,#a855f7,#ec4899);border:none;color:#fff;padding:10px 24px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;margin-left:8px;">üîÑ
                    Load More</button>
            </div>
        </main>
    </div>

    <!-- Webpage Container for external sites -->
    <div class="webpage-box" id="webpageBox">
        <div class="webpage-header">
            <button class="webpage-btn" onclick="webpageBack()" id="webpageBackBtn" style="display:none;">‚Üê
                Back</button>
            <button class="webpage-btn" onclick="webpageRefresh()">‚Üª Refresh</button>
            <h3 id="webpageTitle">Browser</h3>
            <button class="webpage-btn" onclick="toggleWebpageDebug()" id="webpageDebugBtn">Console</button>
            <button class="webpage-close" onclick="closeWebpage()">‚úï Close</button>
        </div>
        <div class="webpage-content" id="webpageContent"></div>
    </div>
    <div id="webpageConsole"></div>

    <!-- Fix URL Modal -->
    <div id="fixUrlModal" class="fix-modal">
        <div class="fix-modal-content">
            <h3>Fix Stream URL</h3>
            <p style="color:#aaa;font-size:12px;margin-bottom:10px;">Edit the URL below. If it plays, it will be saved.
            </p>
            <input type="text" id="fixUrlInput" placeholder="https://...">
            <div class="fix-buttons">
                <button class="fix-close-btn" onclick="closeFixUrlModal()">Cancel</button>
                <button class="fix-test-btn" onclick="testFixUrl()">Test & Save</button>
            </div>
        </div>
    </div>

    <!-- Play Stream Modal -->
    <div id="playStreamModal" class="fix-modal" style="display:none;">
        <div class="fix-modal-content">
            <h3>Play Stream URL</h3>
            <p style="color:#aaa;font-size:12px;margin-bottom:10px;">Paste any stream URL (HLS/MPD/MP4). Optionally
                provide UA or DRM settings.</p>
            <input type="text" id="streamUrlInput" placeholder="https://.../stream.m3u8 or .mpd">
            <input type="text" id="streamNameInput" placeholder="Optional name">
            <input type="text" id="streamUaInput" placeholder="Optional User-Agent (for proxy)">
            <div style="display:flex;gap:8px;margin-top:8px;align-items:center;">
                <label style="font-size:13px;">DRM:</label>
                <select id="streamDrmType"
                    style="flex:1;padding:8px;border-radius:6px;background:var(--bg2);border:1px solid var(--border);color:var(--text);">
                    <option value="">None</option>
                    <option value="com.widevine.alpha">Widevine</option>
                    <option value="com.microsoft.playready">PlayReady</option>
                    <option value="clearkey">ClearKey</option>
                </select>
            </div>
            <input type="text" id="streamDrmLicense" placeholder="License server URL (for Widevine/PlayReady)">
            <input type="text" id="streamDrmKey" placeholder="ClearKey key (keyId:keyBase64) - for ClearKey only">
            <div class="fix-buttons">
                <button class="fix-close-btn" onclick="closePlayStreamModal()">Cancel</button>
                <button class="fix-test-btn" onclick="submitPlayStream()">Play</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/mpegts.js@latest/dist/mpegts.min.js"></script>

    <!-- Shaka Player Custom UI Container -->
    <div id="shakaPlayerContainer">
        <video id="shakaVideo" autoplay></video>
        <div class="shaka-controls">
            <div class="shaka-controls-top">
                <div class="shaka-title" id="shakaTitle">Now Playing</div>
                <button class="shaka-btn" onclick="closeShakaPlayer()">‚úï Close</button>
            </div>
            <div class="shaka-controls-bottom">
                <button class="shaka-btn" id="shakaPlayPause" onclick="toggleShakaPlay()">‚è∏Ô∏è</button>
                <div class="shaka-volume-control">
                    <button class="shaka-btn" id="shakaMute" onclick="toggleShakaMute()">üîä</button>
                    <input type="range" class="shaka-volume-slider" id="shakaVolume" min="0" max="100" value="100"
                        oninput="setShakaVolume(this.value)">
                </div>
                <select class="shaka-quality-select" id="shakaQuality" onchange="changeShakaQuality(this.value)">
                    <option value="auto">Auto Quality</option>
                </select>
                <select class="shaka-aspect-select" id="shakaAspect" onchange="changeShakaAspect(this.value)">
                    <option value="16:9">16:9</option>
                    <option value="4:3">4:3</option>
                    <option value="1:1">1:1</option>
                    <option value="21:9">21:9</option>
                </select>
                <button class="shaka-btn" onclick="toggleShakaOrientation()">üîÑ Rotate</button>
                <button class="shaka-btn" onclick="toggleShakaFullscreen()">‚õ∂ Fullscreen</button>
            </div>
        </div>
    </div>
    <script>
        // ===== SUPABASE CLIENT (Must be initialized first) =====
        const SUPABASE_URL = 'https://jdrheygmqtnohloykrxs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkcmhleWdtcXRub2hsb3lrcnhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1Nzk5OTksImV4cCI6MjA4NDE1NTk5OX0.kmGJ2TOlTX53Qg4Q67HeqvRvYsNF3QgvmZy5_70hoa0';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global external CORS proxy helper (for JioTV / Sports flows)
        window.__externalCorsProxy = window.__externalCorsProxy || 'https://cors-everywhere-wc8b4.ondigitalocean.app';
        window.buildExternalProxyUrl = window.buildExternalProxyUrl || function (target) {
            if (!target) return '';
            const base = window.__externalCorsProxy.replace(/\/$/, '');
            return base + '/' + encodeURIComponent(target);
        };

        const PW = 'nova2024', PP = 50;
        let D = { fav: [], desitales: [], desitalesCategories: [], desitalesTags: [], xnxxvideos: [], MastiRaja: [], MastiRajaCategories: [], xnxxvideosCategories: [], iss3: [], iss3Categories: [], iss3Tags: [], noodle: [], xhamster: [], erotic: [], movies: [], moviesecret: [], video: [], m3u8: [], mp4: [], adultiptv: [], tv: [], viralfap: [], fullcinema: [], korean: [], koreanpornmovie: [], zmaal: [], xmazza: [], wataaCategories: [], wataaTags: [], jiotv: [], sports: [] }, F = [], tab = 'fav', pg = 1;

        // Jio TV / Sports state
        let jiotvChannels = [], sportsChannels = [], currentJiotvSource = null;
        let shakaPlayer = null, shakaCurrentChannel = null;
        let viralfapCategories = [], viralfapView = 'categories', currentCategory = null; // For ViralFap browsing
        let hls = null, tsPlayer = null, vid, isLive = false;

        // Universal Pagination State
        let paginationState = { source: null, id: null, page: 1, type: null, name: null };

        // Init
        vid = document.getElementById('vid');
        if (localStorage.getItem('npw') === PW) showApp();
        document.getElementById('pwInput').onkeypress = e => { if (e.key === 'Enter') doLogin(); };

        // Loading Indicators
        const globalLoader = document.getElementById('globalLoader');
        const bufferingIndicator = document.getElementById('bufferingIndicator');
        const networkStatus = document.getElementById('networkStatus');

        function showGlobalLoader() {
            if (globalLoader) globalLoader.classList.add('active');
        }

        function hideGlobalLoader() {
            if (globalLoader) globalLoader.classList.remove('active');
        }

        function showBuffering() {
            if (bufferingIndicator) bufferingIndicator.classList.add('active');
        }

        function hideBuffering() {
            if (bufferingIndicator) bufferingIndicator.classList.remove('active');
        }

        function showNetworkStatus(message, isOnline = true) {
            if (networkStatus) {
                networkStatus.textContent = message;
                networkStatus.className = 'network-status show ' + (isOnline ? 'online' : 'offline');
                setTimeout(() => {
                    networkStatus.classList.remove('show');
                }, 3000);
            }
        }

        // Network monitoring
        window.addEventListener('online', () => showNetworkStatus('‚úì Back online', true));
        window.addEventListener('offline', () => showNetworkStatus('‚ö† Offline', false));

        // Advanced Multi-User Support: AbortController for request cancellation
        let activeAbortController = null;

        function createAbortController() {
            if (activeAbortController) {
                activeAbortController.abort(); // Cancel previous request
            }
            activeAbortController = new AbortController();
            return activeAbortController.signal;
        }

        // Load More Content State
        let loadMoreState = {
            koreanpornmovie: { offset: 0, limit: 100, hasMore: true },
            xnxxvideos: { offset: 0, limit: 100, hasMore: true },
            MastiRaja: { offset: 0, limit: 100, hasMore: true },
            zmaal: { offset: 0, limit: 100, hasMore: true },
            xmazza: { offset: 0, limit: 100, hasMore: true }
        };

        // Load More Content Function
        async function loadMoreContent() {
            const btn1 = document.getElementById('loadMoreTop');
            const btn2 = document.getElementById('loadMoreBottom');

            // Show loading state
            if (btn1) btn1.textContent = '‚è≥ Loading...';
            if (btn2) btn2.textContent = '‚è≥ Loading...';

            try {
                if (tab === 'koreanpornmovie' || tab === 'zmaal' || tab === 'xmazza') {
                    // Supabase sources - use offset pagination
                    const state = loadMoreState[tab];
                    state.offset += state.limit;

                    const moreData = await supabaseClient
                        .from(tab)
                        .select('*')
                        .order('id', { ascending: false })
                        .range(state.offset, state.offset + state.limit - 1);

                    if (moreData.data && moreData.data.length > 0) {
                        const newVideos = moreData.data.map(v => ({
                            n: v.title || 'Untitled',
                            l: v.img ? (v.img.startsWith('http') ? v.img : 'https://cdn.xnxxvideos.in' + v.img) : '',
                            g: tab === 'koreanpornmovie' ? 'KPM' : (tab === 'xnxxvideos' ? 'XNXX' : (tab === 'zmaal' ? 'Zmaal' : 'XMazaa')),
                            u: v.stream_url ? (tab === 'xnxxvideos' ? v.stream_url : proxyUrl(v.stream_url)) : '',
                            _isVideo: true,
                            _isXNXX: tab === 'xnxxvideos'
                        }));
                        D[tab] = [...D[tab], ...newVideos];
                        F = [...F, ...newVideos];
                        render();
                        state.hasMore = moreData.data.length === state.limit;
                    } else {
                        state.hasMore = false;
                    }

                    // Update button text
                    if (!state.hasMore) {
                        if (btn1) btn1.textContent = '‚úì All Loaded';
                        if (btn2) btn2.textContent = '‚úì All Loaded';
                    }
                } else if (tab === 'desitales' || tab === 'iss3' || tab === 'xnxxvideos' || tab === 'MastiRaja') {
                    const page = paginationState.page || 1;
                    const type = paginationState.type || 'latest';
                    const id = paginationState.id;
                    const name = paginationState.name || '';

                    if (tab === 'desitales') await loadDesitalesVideos(type, id, name, page + 1, true);
                    else if (tab === 'xnxxvideos') await loadXnxxVideos(type, id, name, page + 1, true);
                    else if (tab === 'MastiRaja') await loadMastirajaVideos(type, id, name, page + 1, true);
                    else await loadISS3Videos(type, id, name, page + 1, true);

                    // Check if we reached the end
                    const tot = Math.ceil((paginationState.total || 0) / PP);
                    if (paginationState.page >= tot) {
                        if (btn1) btn1.textContent = '‚úì All Loaded';
                        if (btn2) btn2.textContent = '‚úì All Loaded';
                    }
                } else {
                    // For other sources, just show message
                    console.log('Load more not supported for this tab:', tab);
                }
            } catch (e) {
                console.error('Load more error:', e);
            }

            // Reset button text
            if (btn1 && btn1.textContent.includes('Loading')) btn1.textContent = 'üîÑ Load More Content';
            if (btn2 && btn2.textContent.includes('Loading')) btn2.textContent = 'üîÑ Load More Content';
        }

        // Connection speed detection for adaptive quality
        let connectionSpeed = 'high'; // 'high', 'medium', 'low'

        async function detectConnectionSpeed() {
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            if (connection) {
                const effectiveType = connection.effectiveType;
                if (effectiveType === '4g') connectionSpeed = 'high';
                else if (effectiveType === '3g') connectionSpeed = 'medium';
                else connectionSpeed = 'low';
            } else {
                // Fallback: measure actual download speed
                const start = performance.now();
                try {
                    await fetch('/m3u/faviourites.txt', { cache: 'no-store' });
                    const elapsed = performance.now() - start;
                    connectionSpeed = elapsed < 200 ? 'high' : elapsed < 500 ? 'medium' : 'low';
                } catch (e) { connectionSpeed = 'medium'; }
            }
            console.log('Connection speed:', connectionSpeed);
        }
        detectConnectionSpeed();

        // Video prefetching for instant next-video playback
        let prefetchedVideo = null;

        function prefetchNextVideo(nextUrl) {
            if (!nextUrl || nextUrl === prefetchedVideo) return;
            prefetchedVideo = nextUrl;
            // Prefetch video metadata only (not full video)
            const link = document.createElement('link');
            link.rel = 'prefetch';
            link.href = nextUrl;
            link.as = 'video';
            document.head.appendChild(link);
        }

        // ULTRA-ADVANCED: Watch History & Smart Recommendations
        const watchHistory = JSON.parse(localStorage.getItem('watchHistory') || '[]');

        function trackWatch(item) {
            const entry = { title: item.n, group: item.g, timestamp: Date.now() };
            const idx = watchHistory.findIndex(h => h.title === item.n);
            if (idx > -1) watchHistory.splice(idx, 1);
            watchHistory.unshift(entry);
            if (watchHistory.length > 50) watchHistory.pop();
            localStorage.setItem('watchHistory', JSON.stringify(watchHistory));
        }

        // ULTRA-ADVANCED: Real-time Bandwidth Monitoring
        let currentBandwidth = 0;
        const bandwidthHistory = [];

        function updateBandwidth(bytes, durationMs) {
            const mbps = (bytes * 8) / (durationMs / 1000) / 1000000;
            bandwidthHistory.push(mbps);
            if (bandwidthHistory.length > 10) bandwidthHistory.shift();
            currentBandwidth = bandwidthHistory.reduce((a, b) => a + b, 0) / bandwidthHistory.length;
        }

        // ULTRA-ADVANCED: Parallel Image Preloading for Next Page
        function preloadNextPageImages() {
            const start = pg * PP;
            const end = Math.min(start + PP, F.length);
            for (let i = start; i < end; i++) {
                if (F[i] && F[i].l) {
                    const img = new Image();
                    img.src = F[i].l;
                }
            }
        }

        // ULTRA-ADVANCED: Memory-efficient Virtual Scrolling Support
        let virtualScrollEnabled = false;
        const VIRTUAL_SCROLL_THRESHOLD = 500;

        function checkVirtualScrollNeeded() {
            virtualScrollEnabled = F.length > VIRTUAL_SCROLL_THRESHOLD;
        }

        // ULTRA-ADVANCED: Performance Metrics Dashboard (for debugging)
        const perfMetrics = {
            apiCalls: 0,
            cacheHits: 0,
            avgLoadTime: 0,
            renderCount: 0
        };

        // Helper: Fetch videos from Supabase (ordered by id ascending)
        async function fetchFromSupabase(table, limit = 100) {
            const { data, error } = await supabaseClient.from(table).select('*').order('id', { ascending: false }).limit(limit);
            if (error) { console.error(`Supabase ${table} error:`, error); return []; }
            return data || [];
        }

        // Helper: Fetch categories/tags from Supabase
        async function fetchCategoriesFromSupabase(sourcePrefix, type = 'categories') {
            const table = `${sourcePrefix}_${type}`;
            const { data, error } = await supabaseClient.from(table).select('*');
            if (error) { console.error(`Supabase ${table} error:`, error); return []; }
            return data || [];
        }

        // Helper: Fetch videos by category/tag ID
        async function fetchVideosByCategoryFromSupabase(sourcePrefix, categoryId, type = 'category') {
            const table = `${sourcePrefix}_${type}_videos`;
            const idField = type === 'tag' ? 'tag_id' : 'category_id';
            const { data, error } = await supabaseClient.from(table).select('*').eq(idField, categoryId);
            if (error) { console.error(`Supabase ${table} error:`, error); return []; }
            return data || [];
        }

        // IndexedDB Cache for Lightning Speed
        const DB_NAME = 'NovaTV_Cache';
        const DB_VERSION = 1;
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };


                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('data')) {
                        db.createObjectStore('data', { keyPath: 'key' });
                    }
                };
            });
        }

        async function getCachedData(key) {
            if (!db) await initDB();
            return new Promise((resolve) => {
                const tx = db.transaction('data', 'readonly');
                const store = tx.objectStore('data');
                const request = store.get(key);
                request.onsuccess = () => {
                    const data = request.result;
                    // Cache valid for 10 minutes
                    if (data && Date.now() - data.timestamp < 600000) {
                        resolve(data.value);
                    } else {
                        resolve(null);
                    }
                };
                request.onerror = () => resolve(null);
            });
        }

        async function setCachedData(key, value) {
            if (!db) await initDB();
            return new Promise((resolve) => {
                const tx = db.transaction('data', 'readwrite');
                const store = tx.objectStore('data');
                store.put({ key, value, timestamp: Date.now() });
                tx.oncomplete = () => resolve();
                tx.onerror = () => resolve();
            });
        }

        // Request deduplication
        const pendingRequests = new Map();

        async function fetchWithCache(url, key) {
            // Check if request is already pending
            if (pendingRequests.has(key)) {
                return pendingRequests.get(key);
            }

            // Check cache first
            const cached = await getCachedData(key);
            if (cached) {
                return cached;
            }

            // Make request
            const promise = fetch(url)
                .then(r => r.json())
                .then(data => {
                    setCachedData(key, data);
                    pendingRequests.delete(key);
                    return data;
                })
                .catch(err => {
                    pendingRequests.delete(key);
                    throw err;
                });

            pendingRequests.set(key, promise);
            return promise;
        }

        function doLogin() {
            if (document.getElementById('pwInput').value === PW) {
                localStorage.setItem('npw', PW);
                showApp();
            } else document.getElementById('loginErr').style.display = 'block';
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            loadData();
        }

        async function loadData() {
            const t0 = performance.now();
            try {
                const [fav, noodle, xhamster, movies, moviesecret, video, m3u8, mp4, adultiptv, erotic, tv, kpData, korean, fullcinema1, fullcinema2, vfapCats, kpmCats, zmaalData, xmazzaData, desitalesCats, desitalesTags, iss3Cats, iss3Tags, mastirajaCats, xnxxCats] = await Promise.all([
                    fetch('/m3u/faviourites.txt').then(r => r.text()).catch(() => ''),
                    fetch('/m3u/noodle.txt').then(r => r.text()).catch(() => ''),
                    fetch('/m3u/xhamster.txt').then(r => r.text()).catch(() => ''),
                    fetch('/m3u/movies.txt').then(r => r.text()).catch(() => ''),
                    fetch('/m3u/Movies Secret.txt').then(r => r.text()).catch(() => ''),
                    fetch('/m3u/video.txt').then(r => r.text()).catch(() => ''),
                    fetch('/m3u/m3u8.txt').then(r => r.text()).catch(() => ''),
                    fetch('/m3u/mp4.txt').then(r => r.text()).catch(() => ''),
                    fetch('/m3u/adultiptv.txt').then(r => r.text()).catch(() => ''),
                    fetch('/m3u/erotic.txt').then(r => r.text()).catch(() => ''),
                    fetch('/m3u/Adult TV.txt').then(r => r.text()).catch(() => ''),
                    fetch('/api/all?pw=' + PW).then(r => r.json()).catch(() => []),
                    fetch('/json/erotic korea.json').then(r => r.json()).catch((e) => { console.error('Korean JSON error:', e); return []; }),
                    fetch('https://fullxcinema.com/wp-json/wp/v2/posts?tags=1674&per_page=100&page=1').then(r => r.json()).catch((e) => { console.error('FullCinema page 1 error:', e); return []; }),
                    fetch('https://fullxcinema.com/wp-json/wp/v2/posts?tags=1674&per_page=100&page=2').then(r => r.json()).catch((e) => { console.error('FullCinema page 2 error:', e); return []; }),
                    fetch('https://viralfap.com/wp-json/wp/v2/categories?per_page=29').then(r => r.json()).catch((e) => { console.error('ViralFap categories error:', e); return []; }),
                    // ===== SUPABASE DATA =====
                    fetchFromSupabase('koreanpornmovie', 10000),  // KPM from Supabase
                    fetchFromSupabase('zmaal', 100000),            // Zmaal from Supabase
                    fetchFromSupabase('xmazza', 500),           // XMazaa from Supabase
                    fetchCategoriesFromSupabase('desi', 'categories'),  // Desi Tales categories
                    fetchCategoriesFromSupabase('desitales', 'tags'),        // Desi Tales tags
                    fetchCategoriesFromSupabase('iss3', 'categories'),  // ISS3 categories
                    fetchCategoriesFromSupabase('iss3', 'tags'),         // ISS3 tags
                    fetchCategoriesFromSupabase('mastiraja', 'categories'),  // MastiRaja categories
                    // Try RPC first for unique categories, fallback to limited table fetch
                    supabaseClient.rpc('get_xnxx_unique_categories')
                        .then(res => res.error ? supabaseClient.from('xnxxvideos').select('category_id, category_name').not('category_id', 'is', null).limit(100000000000) : res)
                ]);
                D.fav = parse(fav); D.noodle = parse(noodle); D.xhamster = parse(xhamster);
                D.erotic = parse(erotic);
                D.moviesecret = parse(moviesecret);
                D.movies = parse(movies); D.video = parseWithProxy(video);
                D.m3u8 = parseWithProxy(m3u8); D.mp4 = parse(mp4); D.adultiptv = parseWithProxy(adultiptv); D.tv = parseWithProxy(tv);

                // Process Desi Tales - Folder-style menu with Uncategorized
                D.desitales = []; // Will be populated by loadDesitalesVideos('latest')

                // Store categories from Supabase (using ID instead of slug)
                D.desitalesCategories = (desitalesCats || []).map(cat => ({
                    n: 'üìÅ ' + cat.name,
                    l: '',
                    g: 'Category',
                    u: `desitalescat:${cat.id}`,
                    catId: cat.id,
                    _isFolder: true
                }));

                D.desitalesTags = (desitalesTags || []).map(tag => ({
                    n: 'üè∑Ô∏è ' + tag.name,
                    l: '',
                    g: 'Tag',
                    u: `desitalestag:${tag.id}`,
                    tagId: tag.id,
                    _isFolder: true
                }));

                // Fetch first video thumbnail for Desi Tales categories (background)
                D.desitalesCategories.slice(0, 30).forEach(async (cat) => {
                    try {
                        const { data } = await supabaseClient.from('desi_category_videos').select('img').eq('category_id', cat.catId).limit(1);
                        if (data && data[0] && data[0].img) {
                            cat.l = data[0].img;
                            if (tab === 'desitales') render();
                        }
                    } catch (e) { console.error('Desitales cat thumb error:', e); }
                });

                // Fetch first video thumbnail for Desi Tales tags (background)
                D.desitalesTags.slice(0, 30).forEach(async (tag) => {
                    try {
                        const { data } = await supabaseClient.from('desi_tag_videos').select('img').eq('tag_id', tag.tagId).limit(1);
                        if (data && data[0] && data[0].img) {
                            tag.l = data[0].img;
                            if (tab === 'desitales') render();
                        }
                    } catch (e) { console.error('Desitales tag thumb error:', e); }
                });

                // Process ISS3 - From Supabase with Uncategorized folder
                D.iss3 = []; // Will be populated by loadISS3Videos('latest')

                D.iss3Categories = (iss3Cats || []).map(cat => ({
                    n: 'üìÅ ' + cat.name,
                    l: '',
                    g: 'Category',
                    u: `iss3cat:${cat.id}`,
                    catId: cat.id,
                    _isFolder: true
                }));

                D.iss3Tags = (iss3Tags || []).map(tag => ({
                    n: 'üè∑Ô∏è ' + tag.name,
                    l: '',
                    g: 'Tag',
                    u: `iss3tag:${tag.id}`,
                    tagId: tag.id,
                    _isFolder: true
                }));

                // Fetch first video thumbnail for ISS3 categories (background)
                D.iss3Categories.slice(0, 60).forEach(async (cat) => {
                    try {
                        const { data } = await supabaseClient.from('iss3_category_videos').select('img').eq('category_id', cat.catId).limit(1);
                        if (data && data[0] && data[0].img) {
                            cat.l = data[0].img;
                            if (tab === 'iss3') render();
                        }
                    } catch (e) { }
                });

                // Fetch first video thumbnail for ISS3 tags (background)
                D.iss3Tags.slice(0, 60).forEach(async (tag) => {
                    try {
                        const { data } = await supabaseClient.from('iss3_tag_videos').select('img').eq('tag_id', tag.tagId).limit(1);
                        if (data && data[0] && data[0].img) {
                            tag.l = data[0].img;
                            if (tab === 'iss3') render();
                        }
                    } catch (e) { }
                });

                // Process XnxxVideos categories
                const xnxxUniqueCats = [];
                const xnxxSeenIds = new Set();
                (xnxxCats.data || []).forEach(c => {
                    if (!xnxxSeenIds.has(c.category_id)) {
                        xnxxSeenIds.add(c.category_id);
                        xnxxUniqueCats.push(c);
                    }
                });

                D.xnxxvideosCategories = xnxxUniqueCats.map(cat => ({
                    n: 'üìÅ ' + cat.category_name,
                    l: '',
                    g: 'Category',
                    u: `xnxxcat:${cat.category_id}`,
                    catId: cat.category_id,
                    _isFolder: true
                }));

                // Fetch thumbnails for Xnxx categories
                D.xnxxvideosCategories.slice(0, 60).forEach(async (cat) => {
                    try {
                        const { data } = await supabaseClient.from('xnxxvideos').select('img').eq('category_id', cat.catId).limit(1);
                        if (data && data[0] && data[0].img) {
                            cat.l = data[0].img;
                            if (tab === 'xnxxvideos') render();
                        }
                    } catch (e) { }
                });

                // Process MastiRaja categories
                // MastiRaja dedicated proxy (images + streaming only)
                const MASTIRAJA_PROXY = 'https://tv-4vo.pages.dev/api/proxy?extract=true&url=';
                const mastirajaProxy = (url) => {
                    if (!url) return '';
                    if (url.startsWith(MASTIRAJA_PROXY)) return url;
                    if (url.startsWith('http')) return MASTIRAJA_PROXY + encodeURIComponent(url);
                    return url;
                };

                D.MastiRaja = []; // Will be populated by loadMastirajaVideos('latest')
                D.MastiRajaCategories = (mastirajaCats || []).map(cat => ({
                    n: 'üìÅ ' + cat.name,
                    l: '',
                    g: 'Category',
                    u: `mastirajacat:${cat.id}`,
                    catId: cat.id,
                    _isFolder: true
                }));

                // Fetch thumbnails for MastiRaja categories
                D.MastiRajaCategories.forEach(async (cat) => {
                    try {
                        const { data } = await supabaseClient
                            .from('mastiraja_videos')
                            .select('img')
                            .eq('category_id', cat.catId)
                            .not('img', 'is', null)
                            .order('created_at', { ascending: false })
                            .limit(1);
                        if (data && data[0] && data[0].img) {
                            cat.l = mastirajaProxy(data[0].img);
                            if (tab === 'MastiRaja') render();
                        }
                    } catch (e) {
                        console.error('MastiRaja category thumbnail error:', e);
                    }
                });

                // Helper to wrap URL with proxy. Automatically appends UA and cookie from window globals if present.
                const proxyUrl = (url, opts) => {
                    if (!url) return '';
                    let out = `/api/proxy?url=${encodeURIComponent(url)}`;
                    const ua = (opts && opts.ua) || window.__proxyUA;
                    const cookie = (opts && opts.cookie) || window.__proxyCookie;
                    if (ua) out += `&ua=${encodeURIComponent(ua)}`;
                    if (cookie) out += `&cookie=${encodeURIComponent(cookie)}`;
                    return out;
                };

                // KPM Smart URL Generator - Creates multiple fallback URLs with different capitalizations
                const kpmSmartUrl = (rawUrl) => {
                    if (!rawUrl) return { primary: '', fallbacks: [] };

                    try {
                        const smallWords = ['to', 'a', 'an', 'the', 'in', 'on', 'at', 'for', 'of', 'and', 'but', 'or', 'by', 'with', 'from', 'as', 'is', 'it', 'vs'];

                        const urlParts = rawUrl.split('/');
                        const filename = urlParts[urlParts.length - 1];

                        let decoded;
                        try {
                            decoded = decodeURIComponent(filename.replace('.mp4', ''));
                        } catch (e) {
                            decoded = filename.replace('.mp4', '').replace(/%20/g, ' ');
                        }

                        // AGGRESSIVE CLEANUP: Remove double symbols and ensure clean spacing
                        const cleanTitle = (title) => {
                            return title
                                .replace(/[-_.\s]{2,}/g, ' ')  // Replace any combination of 2+ symbols with a single space
                                .replace(/--+/g, '-')
                                .replace(/__+/g, '_')
                                .replace(/\.\.+/g, '.')
                                .replace(/,,+/g, ',')
                                .replace(/\s\s+/g, ' ')
                                .replace(/['']/g, "'")
                                .replace(/[""]/g, '"')
                                .replace(/[?!:;]/g, '')
                                .replace(/-/g, ' ')            // Hyphen to space for processing
                                .trim();
                        };

                        const cleaned = cleanTitle(decoded);

                        const generateVariants = (text) => {
                            // Variant 1: Small words lowercase (e.g., Soft by Day)
                            const v1 = text.split(' ').map((word, i) => {
                                if (!word) return '';
                                if (i === 0) return word.charAt(0).toUpperCase() + word.slice(1);
                                if (smallWords.includes(word.toLowerCase())) return word.toLowerCase();
                                return word.charAt(0).toUpperCase() + word.slice(1);
                            }).filter(w => w).join('%20');

                            // Variant 2: All first letters capitalized (e.g., Soft By Day)
                            const v2 = text.split(' ').map(word => {
                                if (!word) return '';
                                return word.charAt(0).toUpperCase() + word.slice(1);
                            }).filter(w => w).join('%20');

                            // Variant 3: All lowercase (just in case)
                            const v3 = text.toLowerCase().replace(/ /g, '%20');

                            return [v1, v2, v3];
                        };

                        const variants = generateVariants(cleaned);
                        const baseUrl = 'https://koreanporn.stream/';

                        const paths = new Set();
                        variants.forEach(v => {
                            if (v) paths.add(v + '.mp4');
                        });

                        // Add some specific variants user mentioned
                        // Hyphen-to-Space is basically covered by Variant 2 after hyphen removal in cleaned
                        paths.add(cleaned.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join('%20') + '.mp4');

                        const fallbacks = Array.from(paths).map(p => baseUrl + p);
                        fallbacks.push(rawUrl); // Original from DB

                        return {
                            primary: fallbacks[0] || rawUrl,
                            fallbacks: fallbacks.slice(1)
                        };
                    } catch (e) {
                        console.error('[KPM] URL generation error:', e);
                        return { primary: rawUrl, fallbacks: [] };
                    }
                };

                // Process Korean Porn Movie from Supabase with smart URL fallbacks
                D.koreanpornmovie = (kpmCats || []).map(v => {
                    const urls = kpmSmartUrl(v.stream_url);
                    return {
                        n: v.title || 'Untitled',
                        l: v.img || 'https://koreanpornmovie.com/wp-content/uploads/2020/08/logo-kporn-.png',
                        g: 'KPM',
                        u: urls.primary,
                        _fallbackUrls: urls.fallbacks,
                        _isVideo: true,
                        _isKPM: true
                    };
                });

                // Process Zmaal posts from Supabase
                D.zmaal = (zmaalData || []).map(v => ({
                    n: v.title || 'Untitled',
                    l: v.img ? mastirajaProxy(v.img) : '',
                    g: 'Zmaal',
                    u: v.stream_url ? mastirajaProxy(v.stream_url) : '',
                    _isZmaal: true
                }));
                zmaalPage = 1;

                // Process XMazaa posts from Supabase
                D.xmazza = (xmazzaData || []).map(v => ({
                    n: v.title || 'Untitled',
                    l: v.img ? mastirajaProxy(v.img) : '',
                    g: 'XMazaa',
                    u: v.stream_url ? mastirajaProxy(v.stream_url) : '',
                    _isXMazaa: true
                }));
                xmazzaPage = 1;

                // Process Wataa - All in One (Categories + Tags)
                D.wataa = [
                    { n: 'üìÅ Categories', l: '', g: 'Folder', u: 'wataa:menu', _isFolder: true },
                    { n: 'üè∑Ô∏è Tags', l: '', g: 'Folder', u: 'wataa:tagmenu', _isFolder: true }
                ];
                // Wataa Categories
                D.wataaCategories = [
                    { n: 'Indian', l: '', g: 'Category', u: 'wataacat:17', cid: 17 },
                    { n: 'OnlyFans', l: '', g: 'Category', u: 'wataacat:65', cid: 65 },
                    { n: 'TikTok', l: '', g: 'Category', u: 'wataacat:29', cid: 29 },
                    { n: 'Twitter', l: '', g: 'Category', u: 'wataacat:1', cid: 1 }
                ];
                // Wataa Tags
                D.wataaTags = [
                    { n: 'Movies', l: '', g: 'Tag', u: 'wataatag:19', tid: 19 },
                    { n: 'Wife sharing', l: '', g: 'Tag', u: 'wataatag:126', tid: 126 },
                    { n: 'Risky outdoor', l: '', g: 'Tag', u: 'wataatag:89', tid: 89 },
                    { n: 'Mom son', l: '', g: 'Tag', u: 'wataatag:117', tid: 117 },
                    { n: 'Desi MMS', l: '', g: 'Tag', u: 'wataatag:40', tid: 40 },
                    { n: 'MMS', l: '', g: 'Tag', u: 'wataatag:23', tid: 23 },
                    { n: 'Sex Seyret', l: '', g: 'Tag', u: 'wataatag:94', tid: 94 }
                ];

                // Fetch thumbnails for Wataa categories (parallel, speed optimization)
                Promise.all(D.wataaCategories.map(async (cat) => {
                    try {
                        const res = await fetch(`https://wataa.io/wp-json/wp/v2/posts?categories=${cat.cid}&per_page=1&_embed`);
                        if (res.ok) {
                            const posts = await res.json();
                            if (posts && posts[0]) {
                                cat.l = posts[0].yoast_head_json?.og_image?.[0]?.url || posts[0]._embedded?.['wp:featuredmedia']?.[0]?.source_url || '';
                            }
                        }
                    } catch (e) { console.error('Wataa cat thumb error:', e); }
                })).then(() => { if (tab === 'wataa') render(); });

                // Fetch thumbnails for Wataa tags (parallel)
                Promise.all(D.wataaTags.map(async (tag) => {
                    try {
                        const res = await fetch(`https://wataa.io/wp-json/wp/v2/posts?tags=${tag.tid}&per_page=1&_embed`);
                        if (res.ok) {
                            const posts = await res.json();
                            if (posts && posts[0]) {
                                tag.l = posts[0].yoast_head_json?.og_image?.[0]?.url || posts[0]._embedded?.['wp:featuredmedia']?.[0]?.source_url || '';
                            }
                        }
                    } catch (e) { console.error('Wataa tag thumb error:', e); }
                })).then(() => { if (tab === 'wataa') render(); });

                // Process Korean - use ONLY vid_m_poster_image (compulsory) - wrap m3u8 URLs with proxy
                D.korean = korean.map(v => {
                    const streamUrl = getKoreanUrl(v);
                    return {
                        n: v.title?.rendered || 'Untitled',
                        l: v.cmb2?.poster_feature_image?.vid_m_poster_image || '',
                        g: 'Korean Erotica',
                        u: streamUrl ? proxyUrl(streamUrl) : '',
                        _raw: v
                    };
                }).filter(v => v.u);

                // Process FullCinema - use direct image URLs for instant loading
                const fullcinemaAll = [...fullcinema1, ...fullcinema2];
                D.fullcinema = fullcinemaAll.map(v => {
                    // Priority order for images: og_image > featured media > empty
                    let posterUrl = '';

                    if (v.yoast_head_json?.og_image && v.yoast_head_json.og_image[0]?.url) {
                        posterUrl = v.yoast_head_json.og_image[0].url;
                    } else if (v._embedded?.['wp:featuredmedia']?.[0]?.source_url) {
                        posterUrl = v._embedded['wp:featuredmedia'][0].source_url;
                    } else if (v._embedded?.['wp:featuredmedia']?.[0]?.media_details?.sizes?.full?.source_url) {
                        posterUrl = v._embedded['wp:featuredmedia'][0].media_details.sizes.full.source_url;
                    }

                    return {
                        n: v.title?.rendered || 'Untitled',
                        l: posterUrl,
                        g: 'FullXCinema',
                        u: v.link,
                        _raw: v
                    };
                });

                // Process ViralFap categories with first video thumbnail
                viralfapCategories = vfapCats.filter(c => c.count > 0);

                // Create categories with placeholder images FIRST for instant render
                D.viralfap = viralfapCategories.map(c => {
                    let categoryImage = '';
                    // Try to extract image from description first
                    if (c.description) {
                        const imgMatch = c.description.match(/<img[^>]+src=["']([^"']+)["']/i);
                        if (imgMatch) categoryImage = imgMatch[1];
                    }
                    return {
                        n: c.name,
                        l: categoryImage,
                        g: `${c.count} videos`,
                        u: `viralfap:${c.id}`,
                        _cat: c
                    };
                });

                // Render immediately with available data
                const total = Object.values(D).reduce((a, b) => a + b.length, 0);
                document.getElementById('stats').textContent = `${total} items | ${Math.round(performance.now() - t0)}ms`;
                filter();

                // BACKGROUND: Fetch thumbnails for categories without images (non-blocking)
                viralfapCategories.forEach(async (c, i) => {
                    const target = D.viralfap.find(x => x.u === `viralfap:${c.id}`);
                    if (target && !target.l) {
                        try {
                            const postsRes = await fetch(`https://viralfap.com/wp-json/wp/v2/posts?categories=${c.id}&per_page=1`);
                            const posts = await postsRes.json();
                            if (posts && posts[0]) {
                                target.l = posts[0].yoast_head_json?.og_image?.[0]?.url ||
                                    posts[0]._embedded?.['wp:featuredmedia']?.[0]?.source_url || '';
                                if (tab === 'viralfap') render(); // Re-render only if on this tab
                            }
                        } catch (err) {
                            console.error(`Failed to fetch thumbnail for category ${c.name}:`, err);
                        }
                    }
                });
            } catch (error) {
                console.error('Fatal error loading data:', error);
                document.getElementById('stats').textContent = 'Error loading data';
                showErrorMessage('Failed to load some content. Some features may not work.');
                // Still try to show what we have
                filter();
            }
        }

        function getKoreanUrl(video) {
            const vs = video.cmb2?.video_player_settings;
            if (!vs) return null;
            if (vs.vm_video_url) return vs.vm_video_url;
            if (vs.vm_video_shortcode) {
                const match = vs.vm_video_shortcode.match(/src=["']([^"']+\.m3u8[^"']*)["']/i);
                if (match) return match[1];
            }
            if (vs.vid_vtt_preview_sprite_image) {
                return vs.vid_vtt_preview_sprite_image.replace(/\.(jpg|jpeg|png|gif)$/i, '.m3u8');
            }
            return null;
        }

        let zmaalPage = 1; // Track current Zmaal page
        let xmazzaPage = 1; // Track current XMazaa page

        function buildZmaalUrl(p) {
            // Extract category from class_list like "category-bulbul-play" ‚Üí "Bulbul Play"
            let category = 'Zmaal';
            if (p.class_list && Array.isArray(p.class_list)) {
                const catClass = p.class_list.find(c => c.startsWith('category-') && c !== 'category-uncategorized');
                if (catClass) {
                    category = catClass.replace('category-', '').split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                }
            }

            // Extract series name from title (without episode/year info)
            const title = (p.title?.rendered || '').replace(/&#8211;/g, '-').replace(/&amp;/g, '&').replace(/&quot;/g, '"').replace(/&#8217;/g, "'");
            // Remove episode info like "Episode 1", "Ep 1", etc.
            let series = title.replace(/\s*(Episode|Ep\.?)\s*\d+.*/i, '').trim();
            // Remove year like (2024)
            series = series.replace(/\s*\(\d{4}\)\s*/g, '').trim();

            // Full title for filename - clean up entities
            const fullTitle = title.replace(/\s+/g, ' ').trim();

            // Build URL: https://video.maalcdn.com/{Category}/{Series}/{Full Title}.mp4
            const categoryPath = category.trim().replace(/\s/g, '%20');
            const seriesPath = series.trim().replace(/\s/g, '%20');
            const titlePath = fullTitle.trim().replace(/\s/g, '%20');

            return `https://video.maalcdn.com/${categoryPath}/${seriesPath}/${titlePath}.mp4`;
        }

        function buildXMazaaUrl(p) {
            let category = 'XMazaa';
            if (p.class_list && Array.isArray(p.class_list)) {
                const catClass = p.class_list.find(c => c.startsWith('category-') && c !== 'category-uncategorized');
                if (catClass) {
                    category = catClass.replace('category-', '').split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                }
            }
            const title = (p.title?.rendered || '').replace(/&#8211;/g, '-').replace(/&amp;/g, '&').replace(/&quot;/g, '"').replace(/&#8217;/g, "'");
            let series = title.replace(/\s*(Episode|Ep\.?)\s*\d+.*/i, '').trim();
            series = series.replace(/\s*\(\d{4}\)\s*/g, '').trim();
            const fullTitle = title.replace(/\s+/g, ' ').trim();
            const categoryPath = category.trim().replace(/\s/g, '%20');
            const seriesPath = series.trim().replace(/\s/g, '%20');
            const titlePath = fullTitle.trim().replace(/\s/g, '%20');
            return `https://video.maalcdn.com/${categoryPath}/${seriesPath}/${titlePath}.mp4`;
        }


        function parse(txt) {
            const r = [], seen = new Set(), lines = txt.split('\n');
            let i = 0;
            while (i < lines.length) {
                const l = lines[i].trim();
                if (l.startsWith('#EXTINF:')) {
                    const nm = l.match(/,(.+)$/);
                    const lg = l.match(/tvg-logo="([^"]+)"/);
                    const gr = l.match(/group-title="([^"]+)"/);

                    i++;
                    while (i < lines.length && (lines[i].trim().startsWith('#') || !lines[i].trim())) i++;

                    if (i < lines.length) {
                        const url = lines[i].trim();
                        if (url && !seen.has(url)) {
                            seen.add(url);
                            let logo = lg ? lg[1] : '';

                            // Ensure https for logos
                            if (logo.startsWith('http://')) {
                                logo = logo.replace('http://', 'https://');
                            }

                            // For content without logo, we'll extract video frame later
                            r.push({
                                n: nm ? nm[1].trim() : '?',
                                l: logo,
                                g: gr ? gr[1] : '',
                                u: url
                            });
                        }
                    }
                }
                i++;
            }
            return r;
        }

        // Render Sub-Menu for Desi Tales / ISS3 / XnxxVideos / MastiRaja
        function renderSubMenu(source) {
            const container = document.getElementById('subMenu');
            if (!container) return;

            let buttons;
            if (source === 'MastiRaja' || source === 'xnxxvideos') {
                // MastiRaja and XnxxVideos only have Latest and Categories
                buttons = [
                    { id: 'latest', name: '‚ú® Latest', icon: '‚ú®' },
                    { id: 'categories', name: 'üìÅ Categories', icon: 'üìÅ' }
                ];
            } else {
                // Desi Tales and ISS3 have all options
                buttons = [
                    { id: 'latest', name: '‚ú® Latest', icon: '‚ú®' },
                    { id: 'categories', name: 'üìÅ Categories', icon: 'üìÅ' },
                    { id: 'tags', name: 'üè∑Ô∏è Tags', icon: 'üè∑Ô∏è' },
                    { id: 'uncategorized', name: 'üìÇ Uncategorized', icon: 'üìÇ' }
                ];
            }

            container.innerHTML = buttons.map(btn => `
                <button class="sub-menu-btn ${paginationState.type === btn.id ? 'active' : ''}" 
                        onclick="handleSubMenuClick('${source}', '${btn.id}')">
                    ${btn.name}
                </button>
            `).join('');
        }

        function handleSubMenuClick(source, type) {
            pg = 1;
            if (type === 'latest') {
                if (source === 'desitales') loadDesitalesVideos('latest', null, 'Latest Videos');
                else if (source === 'xnxxvideos') loadXnxxVideos('latest', null, 'Latest Videos');
                else if (source === 'MastiRaja') loadMastirajaVideos('latest', null, 'Latest Videos');
                else loadISS3Videos('latest', null, 'Latest Videos');
            } else if (type === 'categories') {
                if (source === 'desitales') F = D.desitalesCategories;
                else if (source === 'xnxxvideos') F = D.xnxxvideosCategories;
                else if (source === 'MastiRaja') F = D.MastiRajaCategories;
                else F = D.iss3Categories;
                paginationState = { source: source + '_folders', type: 'categories' };
                render();
            } else if (type === 'tags') {
                F = source === 'desitales' ? D.desitalesTags : D.iss3Tags;
                if (source === 'xnxxvideos' || source === 'MastiRaja') F = []; // Xnxx and MastiRaja have no tags
                paginationState = { source: source + '_folders', type: 'tags' };
                render();
            } else if (type === 'uncategorized') {
                if (source === 'desitales') loadDesitalesVideos('category', null, 'Uncategorized');
                else if (source === 'xnxxvideos') loadXnxxVideos('category', null, 'Uncategorized');
                else if (source === 'MastiRaja') loadMastirajaVideos('category', null, 'Uncategorized');
                else loadISS3Videos('category', null, 'Uncategorized');
            }
            // Update active states
            document.querySelectorAll('.sub-menu-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.includes(type === 'latest' ? 'Latest' : (type === 'categories' ? 'Categories' : (type === 'tags' ? 'Tags' : 'Uncategorized'))));
            });
        }

        // Parse M3U with proxy URLs (for video, m3u8, adultiptv, tv - excluding babes)
        function parseWithProxy(txt) {
            const items = parse(txt);
            return items.map(item => {
                // Skip babes channel
                if (item.n && item.n.toLowerCase().includes('babes')) {
                    return item;
                }
                return {
                    ...item,
                    u: item.u ? proxyUrl(item.u) : ''
                };
            });
        }

        // Tabs
        document.querySelectorAll('.tab').forEach(t => t.onclick = () => {
            document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
            t.classList.add('active');
            tab = t.dataset.t;
            pg = 1;

            // Handle Sub-Menu Visibility
            const subMenu = document.getElementById('subMenu');
            const jiotvContainer = document.getElementById('jiotvSportsContainer');
            const mainGrid = document.getElementById('grid');

            if (tab === 'desitales' || tab === 'iss3' || tab === 'xnxxvideos' || tab === 'MastiRaja') {
                subMenu.style.display = 'flex';
                jiotvContainer.style.display = 'none';
                mainGrid.style.display = 'grid';
                renderSubMenu(tab);
                // Initial load: Latest videos
                if (tab === 'desitales') loadDesitalesVideos('latest', null, 'Latest Videos');
                else if (tab === 'xnxxvideos') loadXnxxVideos('latest', null, 'Latest Videos');
                else if (tab === 'MastiRaja') loadMastirajaVideos('latest', null, 'Latest Videos');
                else loadISS3Videos('latest', null, 'Latest Videos');
            } else if (tab === 'jiotv' || tab === 'sports') {
                subMenu.style.display = 'none';
                jiotvContainer.style.display = 'block';
                mainGrid.style.display = 'none';
                if (tab === 'jiotv') {
                    if (jiotvChannels.length === 0) loadJioTV();
                    else renderJioTVChannels();
                } else {
                    if (sportsChannels.length === 0) loadSports();
                    else renderJioTVChannels();
                }
            } else {
                subMenu.style.display = 'none';
                jiotvContainer.style.display = 'none';
                mainGrid.style.display = 'grid';
                filter();
            }
        });

        // Search
        let st;
        document.getElementById('searchInput').oninput = () => { clearTimeout(st); st = setTimeout(() => { pg = 1; filter(); }, 120); };

        // Jio TV / Sports search and filter
        if (document.getElementById('jiotvSearch')) {
            document.getElementById('jiotvSearch').oninput = () => {
                renderJioTVChannels();
            };
        }
        if (document.getElementById('jiotvLanguageFilter')) {
            document.getElementById('jiotvLanguageFilter').onchange = () => {
                renderJioTVChannels();
            };
        }
        if (document.getElementById('jiotvShowAll')) {
            document.getElementById('jiotvShowAll').onclick = () => {
                document.getElementById('jiotvSearch').value = '';
                document.getElementById('jiotvLanguageFilter').value = '';
                renderJioTVChannels();
            };
        }

        async function filter() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            if (tab === 'koreanpornmovie' && q.length > 2) {
                await searchKPM(q);
                return;
            }
            if (tab === 'zmaal' && q.length > 2) {
                await searchZmaal(q);
                return;
            }
            if (tab === 'xmazza' && q.length > 2) {
                await searchXMazaa(q);
                return;
            }
            if (tab === 'xnxxvideos' && q.length > 2) {
                await searchXnxxVideos(q);
                return;
            }
            if (tab === 'MastiRaja' && q.length > 2) {
                await searchMastirajaVideos(q);
                return;
            }
            paginationState = { source: null }; // Reset for local filter
            const src = D[tab] || [];
            F = q ? src.filter(c => c.n.toLowerCase().includes(q) || c.g.toLowerCase().includes(q)) : src;
            render();
        }

        async function searchKPM(q, page = 1, append = false) {
            if (!append) document.getElementById('grid').innerHTML = '<div class="empty"><div class="spin"></div>Searching...</div>';
            try {
                const res = await fetch(`https://koreanpornmovie.com/wp-json/wp/v2/search?search=${encodeURIComponent(q)}&per_page=50&page=${page}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const results = await res.json();

                const mapped = results.map(r => ({
                    n: r.title,
                    l: 'https://koreanpornmovie.com/wp-content/uploads/2020/08/logo-kporn-.png',
                    g: 'KPM Search',
                    u: kpmUrl(r.title),
                    id: r.id,
                    type: r.subtype || r.type
                }));

                if (append) F = [...F, ...mapped];
                else {
                    F = mapped;
                    pg = 1;
                }

                paginationState = { source: 'kpm_search', q, page };
                render();

                // Asynchronously fetch thumbnails for each search result in this batch
                mapped.forEach(async (item) => {
                    try {
                        const endpoint = item.type === 'attachment' ? `media/${item.id}` : `media?parent=${item.id}`;
                        const mRes = await fetch(`https://koreanpornmovie.com/wp-json/wp/v2/${endpoint}`);
                        if (mRes.ok) {
                            const media = await mRes.json();
                            const mediaObj = Array.isArray(media) ? media[0] : media;
                            if (mediaObj) {
                                item.l = mediaObj.source_url || mediaObj.guid?.rendered || item.l;
                                if (tab === 'koreanpornmovie') render();
                            }
                        }
                    } catch (e) {
                        console.error(`Error fetching thumbnail for ${item.id}:`, e);
                    }
                });
            } catch (e) {
                console.error('KPM search error:', e);
                if (!append) document.getElementById('grid').innerHTML = '<div class="empty">Search failed.</div>';
            }
        }

        async function searchZmaal(q, page = 1, append = false) {
            if (!append) document.getElementById('grid').innerHTML = '<div class="empty"><div class="spin"></div>Searching Zmaal...</div>';
            try {
                const res = await fetch(`https://zmaal.net/wp-json/wp/v2/posts?search=${encodeURIComponent(q)}&per_page=50&page=${page}&_embed`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const results = await res.json();
                const mapped = results.map(p => ({
                    n: p.title?.rendered || 'Untitled',
                    l: p.yoast_head_json?.og_image?.[0]?.url || p._embedded?.['wp:featuredmedia']?.[0]?.source_url || '',
                    g: 'Zmaal Search',
                    u: buildZmaalUrl(p),
                    _isZmaal: true,
                    _raw: p
                }));
                if (append) F = [...F, ...mapped];
                else {
                    F = mapped;
                    pg = 1;
                }

                paginationState = { source: 'zmaal_search', q, page };
                render();
            } catch (e) {
                console.error('Zmaal search error:', e);
                if (!append) document.getElementById('grid').innerHTML = '<div class="empty">Zmaal search failed.</div>';
            }
        }

        async function loadZmaalPosts(page = 1) {
            if (page === 1) document.getElementById('grid').innerHTML = '<div class="empty"><div class="spin"></div>Loading Zmaal...</div>';
            try {
                const res = await fetch(`https://zmaal.net/wp-json/wp/v2/posts?per_page=100&page=${page}&_embed`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const posts = await res.json();
                const mapped = posts.map(p => ({
                    n: p.title?.rendered || 'Untitled',
                    l: p.yoast_head_json?.og_image?.[0]?.url || p._embedded?.['wp:featuredmedia']?.[0]?.source_url || '',
                    g: 'Zmaal',
                    u: buildZmaalUrl(p),
                    _isZmaal: true,
                    _raw: p
                }));
                if (page === 1) D.zmaal = mapped;
                else D.zmaal = [...D.zmaal, ...mapped];
                zmaalPage = page;
                paginationState = { source: 'zmaal', page: page };

                if (tab === 'zmaal') {
                    F = D.zmaal;
                    render();
                }
            } catch (e) {
                console.error('Zmaal posts error:', e);
                if (page === 1) document.getElementById('grid').innerHTML = '<div class="empty">Failed to load Zmaal.</div>';
            }
        }

        async function searchXMazaa(q, page = 1, append = false) {
            if (!append) document.getElementById('grid').innerHTML = '<div class="empty"><div class="spin"></div>Searching XMazaa...</div>';
            try {
                const res = await fetch(`https://xmazaa.net/wp-json/wp/v2/posts?search=${encodeURIComponent(q)}&per_page=50&page=${page}&_embed`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const results = await res.json();
                const mapped = results.map(p => ({
                    n: p.title?.rendered || 'Untitled',
                    l: p.yoast_head_json?.og_image?.[0]?.url || p._embedded?.['wp:featuredmedia']?.[0]?.source_url || '',
                    g: 'XMazaa Search',
                    u: buildXMazaaUrl(p),
                    _isXMazaa: true,
                    _raw: p
                }));
                if (append) F = [...F, ...mapped];
                else {
                    F = mapped;
                    pg = 1;
                }
                paginationState = { source: 'xmazza_search', q, page };
                render();
            } catch (e) {
                console.error('XMazaa search error:', e);
                if (!append) document.getElementById('grid').innerHTML = '<div class="empty">XMazaa search failed.</div>';
            }
        }

        async function loadXMazaaPosts(page = 1) {
            if (page === 1) document.getElementById('grid').innerHTML = '<div class="empty"><div class="spin"></div>Loading XMazaa...</div>';
            try {
                const res = await fetch(`https://xmazaa.net/wp-json/wp/v2/posts?per_page=100&page=${page}&_embed`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const posts = await res.json();
                const mapped = posts.map(p => ({
                    n: p.title?.rendered || 'Untitled',
                    l: p.yoast_head_json?.og_image?.[0]?.url || p._embedded?.['wp:featuredmedia']?.[0]?.source_url || '',
                    g: 'XMazaa',
                    u: buildXMazaaUrl(p),
                    _isXMazaa: true,
                    _raw: p
                }));
                if (page === 1) D.xmazza = mapped;
                else D.xmazza = [...D.xmazza, ...mapped];
                xmazzaPage = page;
                paginationState = { source: 'xmazza', page: page };
                if (tab === 'xmazza') {
                    F = D.xmazza;
                    render();
                }
            } catch (e) {
                console.error('XMazaa posts error:', e);
                if (page === 1) document.getElementById('grid').innerHTML = '<div class="empty">Failed to load XMazaa.</div>';
            }
        }

        async function loadMore() {
            const btn = document.getElementById('loadMoreBtn');
            if (btn) {
                btn.innerHTML = '<div class="spin" style="display:inline-block;width:14px;height:14px;margin-right:8px;"></div>Loading...';
                btn.disabled = true;
            }
            paginationState.page++;
            if (paginationState.source === 'zmaal') {
                await loadZmaalPosts(paginationState.page);
            } else if (paginationState.source === 'zmaal_search') {
                await searchZmaal(paginationState.q, paginationState.page, true);
            } else if (paginationState.source === 'xmazza') {
                await loadXMazaaPosts(paginationState.page);
            } else if (paginationState.source === 'xmazza_search') {
                await searchXMazaa(paginationState.q, paginationState.page, true);
            } else if (paginationState.source === 'wataa') {
                await loadWataaPosts(paginationState.type, paginationState.id, paginationState.name, paginationState.page, true);
            } else if (paginationState.source === 'kpm') {
                await loadKPMPosts(paginationState.id, paginationState.name, paginationState.page, true);
            } else if (paginationState.source === 'kpm_search') {
                await searchKPM(paginationState.q, paginationState.page, true);
            } else if (paginationState.source === 'desitales_videos') {
                await loadDesitalesVideos(paginationState.type, paginationState.id, paginationState.name, paginationState.page, true);
            } else if (paginationState.source === 'iss3_videos') {
                await loadISS3Videos(paginationState.type, paginationState.id, paginationState.name, paginationState.page, true);
            } else if (paginationState.source === 'xnxx_videos') {
                await loadXnxxVideos(paginationState.type, paginationState.id, paginationState.name, paginationState.page, true);
            } else if (paginationState.source === 'xnxx_search') {
                await searchXnxxVideos(paginationState.q, paginationState.page, true);
            } else if (paginationState.source === 'mastiraja_videos') {
                await loadMastirajaVideos(paginationState.type, paginationState.id, paginationState.name, paginationState.page, true);
            } else if (paginationState.source === 'mastiraja_search') {
                await searchMastirajaVideos(paginationState.q, paginationState.page, true);
            }
        }

        async function loadWataaPosts(type, id, name, page = 1, append = false) {
            if (!append) document.getElementById('grid').innerHTML = '<div class="empty"><div class="spin"></div>Loading ' + name + '...</div>';
            try {
                const res = await fetch(`https://wataa.io/wp-json/wp/v2/posts?${type}=${id}&per_page=50&page=${page}&_embed`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const posts = await res.json();
                const mapped = posts.map(p => ({
                    n: p.title?.rendered || 'Untitled',
                    l: p.yoast_head_json?.og_image?.[0]?.url || p._embedded?.['wp:featuredmedia']?.[0]?.source_url || '',
                    g: name,
                    u: p.link,
                    _isWataaPost: true,
                    _raw: p
                }));
                if (append) F = [...F, ...mapped];
                else {
                    F = mapped;
                    pg = 1;
                }

                paginationState = { source: 'wataa', id, type, name, page };
                render();
            } catch (e) {
                console.error('Wataa posts error:', e);
                if (!append) document.getElementById('grid').innerHTML = '<div class="empty">Failed to load posts.</div>';
            }
        }

        // Desi Tales RSS Loading
        // Desi Tales RSS Loading
        async function loadISS3Videos(type, id, name, page = 1, append = false) {
            if (!append) document.getElementById('grid').innerHTML = '<div class="empty"><div class="spin"></div>Loading ' + name + '...</div>';
            try {
                const limit = 100;
                const offset = (page - 1) * limit;

                let query;
                if (type === 'latest') {
                    // Mixture of all videos sorted by created_at
                    query = supabaseClient.from('iss3_category_videos').select('*', { count: 'exact' });
                } else {
                    const table = type === 'category' ? 'iss3_category_videos' : 'iss3_tag_videos';
                    const idField = type === 'category' ? 'category_id' : 'tag_id';
                    query = supabaseClient.from(table).select('*', { count: 'exact' });
                    if (id === null) query = query.is(idField, null);
                    else query = query.eq(idField, id);
                }

                query = query.range(offset, offset + limit - 1).order('created_at', { ascending: false });

                const { data, count, error } = await query;
                if (error) throw error;

                // Deduplicate by stream_url only (Global check across existing F)
                const seen = new Set(append ? F.map(v => v.u) : []);
                const uniqueData = [];
                (data || []).forEach(v => {
                    const url = v.stream_url || '';
                    if (url && !seen.has(url)) {
                        seen.add(url);
                        uniqueData.push(v);
                    }
                });

                const videos = uniqueData.map(v => ({
                    n: v.title || 'Untitled',
                    l: v.img || '',
                    g: 'ISS3' + (name ? ` ‚Ä¢ ${name}` : ''),
                    u: v.stream_url || '',
                    _isVideo: true
                }));

                if (append) F = [...F, ...videos];
                else { F = videos; pg = 1; }
                paginationState = { source: 'iss3_videos', type, id, name, page, total: count || 0 };
                render();
            } catch (e) {
                console.error('ISS3 Videos error:', e);
                if (!append) document.getElementById('grid').innerHTML = '<div class="empty">Failed to load ISS3 videos.</div>';
            }
        }

        async function loadDesitalesVideos(type, id, name, page = 1, append = false) {
            if (!append) {
                document.getElementById('grid').innerHTML = '<div class="empty"><div class="spin"></div>Loading ' + name + '...</div>';
            }

            try {
                const limit = 100;
                const offset = (page - 1) * limit;

                let query;
                if (type === 'latest') {
                    // Latest 50 videos sorted by created_at
                    query = supabaseClient.from('desi_category_videos').select('*', { count: 'exact' });
                } else {
                    const table = type === 'category' ? 'desi_category_videos' : 'desi_tag_videos';
                    const idField = type === 'category' ? 'category_id' : 'tag_id';
                    query = supabaseClient.from(table).select('*', { count: 'exact' });
                    if (id === null) query = query.is(idField, null);
                    else query = query.eq(idField, id);
                }

                query = query.range(offset, offset + limit - 1).order('created_at', { ascending: false });

                const { data, count, error } = await query;
                if (error) throw error;

                // Deduplicate by stream_url only (Global check across existing F)
                const seen = new Set(append ? F.map(v => v.u) : []);
                const uniqueData = [];
                (data || []).forEach(v => {
                    const url = v.stream_url || '';
                    if (url && !seen.has(url)) {
                        seen.add(url);
                        uniqueData.push(v);
                    }
                });

                const videos = uniqueData.map(v => ({
                    n: v.title || 'Untitled',
                    l: v.img || '',
                    g: 'Desi Tales' + (name ? ` ‚Ä¢ ${name}` : ''),
                    u: v.stream_url || '',
                    _isVideo: true
                }));

                if (append) {
                    F = [...F, ...videos];
                } else {
                    F = videos;
                    pg = 1;
                }

                paginationState = { source: 'desitales_videos', type, id, name, page, total: count || 0 };
                render();
            } catch (e) {
                console.error('Desitales Videos error:', e);
                if (!append) document.getElementById('grid').innerHTML = '<div class="empty">Failed to load videos. Try refreshing.</div>';
            }
        }

        // XnxxVideos Logic
        async function loadXnxxVideos(type, id, name, page = 1, append = false) {
            if (!append) document.getElementById('grid').innerHTML = '<div class="empty"><div class="spin"></div>Loading ' + name + '...</div>';
            try {
                const limit = 100;
                const offset = (page - 1) * limit;

                let query = supabaseClient.from('xnxxvideos').select('*', { count: 'exact' });
                if (type === 'category') {
                    if (id === null) query = query.is('category_id', null);
                    else query = query.eq('category_id', id);
                }

                query = query.range(offset, offset + limit - 1).order('post_date_raw', { ascending: false });

                const { data, count, error } = await query;
                if (error) throw error;

                // Deduplicate by stream_url
                const seen = new Set(append ? F.map(v => v.u) : []);
                const uniqueData = [];
                (data || []).forEach(v => {
                    const url = v.stream_url || '';
                    if (url && !seen.has(url)) {
                        seen.add(url);
                        uniqueData.push(v);
                    }
                });

                const videos = uniqueData.map(v => ({
                    id: v.id,
                    n: v.title || 'Untitled',
                    l: v.img ? (v.img.startsWith('http') ? v.img : 'https://cdn.xnxxvideos.in' + v.img) : '',
                    g: 'XNXX' + (v.category_name ? ` ‚Ä¢ ${v.category_name}` : ''),
                    u: v.stream_url || '',
                    _isVideo: true,
                    _isXNXX: true
                }));

                if (append) { F = [...F, ...videos]; }
                else { F = videos; pg = 1; }
                paginationState = { source: 'xnxx_videos', type, id, name, page, total: count || 0 };
                render();
            } catch (e) {
                console.error('XnxxVideos error:', e);
                if (!append) document.getElementById('grid').innerHTML = '<div class="empty">Failed to load Xnxx videos.</div>';
            }
        }

        async function searchXnxxVideos(q, page = 1, append = false) {
            if (!append) document.getElementById('grid').innerHTML = '<div class="empty"><div class="spin"></div>Searching Xnxx...</div>';
            try {
                const limit = 100;
                const offset = (page - 1) * limit;
                const { data, count, error } = await supabaseClient
                    .from('xnxxvideos')
                    .select('*', { count: 'exact' })
                    .ilike('title', `%${q}%`)
                    .range(offset, offset + limit - 1)
                    .order('post_date_raw', { ascending: false });

                if (error) throw error;
                const videos = (data || []).map(v => ({
                    id: v.id,
                    n: v.title || 'Untitled',
                    l: v.img ? (v.img.startsWith('http') ? v.img : 'https://cdn.xnxxvideos.in' + v.img) : '',
                    g: 'XNXX Search',
                    u: v.stream_url || '',
                    _isVideo: true,
                    _isXNXX: true
                }));

                if (append) F = [...F, ...videos];
                else { F = videos; pg = 1; }
                paginationState = { source: 'xnxx_search', q, page, total: count || 0 };
                render();
            } catch (e) {
                console.error('Xnxx search error:', e);
                if (!append) document.getElementById('grid').innerHTML = '<div class="empty">Xnxx search failed.</div>';
            }
        }

        // MastiRaja Logic
        async function loadMastirajaVideos(type, id, name, page = 1, append = false) {
            if (!append) document.getElementById('grid').innerHTML = '<div class="empty"><div class="spin"></div>Loading ' + name + '...</div>';
            try {
                const limit = 100;
                const offset = (page - 1) * limit;

                let query = supabaseClient.from('mastiraja_videos').select('*, mastiraja_categories(name)', { count: 'exact' });
                if (type === 'category') {
                    if (id === null) query = query.is('category_id', null);
                    else query = query.eq('category_id', id);
                }

                // For latest, we'll sort client-side by post_date and post_time
                // For category, use created_at as fallback
                query = query.range(offset, offset + limit - 1);
                if (type === 'latest') {
                    query = query.order('created_at', { ascending: false }); // Get recent first, then sort client-side
                } else {
                    query = query.order('created_at', { ascending: false });
                }

                const { data, count, error } = await query;
                if (error) throw error;

                // Sort by post_date and post_time if type is 'latest'
                let sortedData = data || [];
                if (type === 'latest') {
                    sortedData = sortedData.sort((a, b) => {
                        // Parse post_date (format: "DD MMM YYYY" like "15 Jan 2024") and post_time (format: "HH:MM:SS")
                        const parseDate = (postDate, postTime) => {
                            if (!postDate || !postTime) return new Date(0);
                            try {
                                // Format: "15 Jan 2024 14:30:00"
                                // JavaScript Date can parse this format
                                const dateStr = postDate + ' ' + postTime;
                                const parsed = new Date(dateStr);
                                // If parsing fails, return epoch
                                return isNaN(parsed.getTime()) ? new Date(0) : parsed;
                            } catch (e) {
                                return new Date(0);
                            }
                        };
                        const dateA = parseDate(a.post_date, a.post_time);
                        const dateB = parseDate(b.post_date, b.post_time);
                        return dateB - dateA; // Descending order (newest first)
                    });
                }

                // Deduplicate by stream_url
                const seen = new Set(append ? F.map(v => v.u) : []);
                const uniqueData = [];
                sortedData.forEach(v => {
                    const url = v.stream_url || '';
                    if (url && !seen.has(url)) {
                        seen.add(url);
                        uniqueData.push(v);
                    }
                });

                const videos = uniqueData.map(v => ({
                    id: v.id,
                    n: v.title || 'Untitled',
                    l: v.img || '',
                    g: 'MastiRaja' + (v.mastiraja_categories && v.mastiraja_categories.name ? ` ‚Ä¢ ${v.mastiraja_categories.name}` : ''),
                    u: v.stream_url || '',
                    _isVideo: true,
                    _isMastiRaja: true
                }));

                if (append) { F = [...F, ...videos]; }
                else { F = videos; pg = 1; }
                paginationState = { source: 'mastiraja_videos', type, id, name, page, total: count || 0 };
                render();
            } catch (e) {
                console.error('MastiRaja error:', e);
                if (!append) document.getElementById('grid').innerHTML = '<div class="empty">Failed to load MastiRaja videos.</div>';
            }
        }

        async function searchMastirajaVideos(q, page = 1, append = false) {
            if (!append) document.getElementById('grid').innerHTML = '<div class="empty"><div class="spin"></div>Searching MastiRaja...</div>';
            try {
                const limit = 100;
                const offset = (page - 1) * limit;
                const { data, count, error } = await supabaseClient
                    .from('mastiraja_videos')
                    .select('*, mastiraja_categories(name)', { count: 'exact' })
                    .ilike('title', `%${q}%`)
                    .range(offset, offset + limit - 1)
                    .order('created_at', { ascending: false });

                if (error) throw error;
                const videos = (data || []).map(v => ({
                    id: v.id,
                    n: v.title || 'Untitled',
                    l: v.img || '',
                    g: 'MastiRaja Search' + (v.mastiraja_categories && v.mastiraja_categories.name ? ` ‚Ä¢ ${v.mastiraja_categories.name}` : ''),
                    u: v.stream_url || '',
                    _isVideo: true,
                    _isMastiRaja: true
                }));

                if (append) F = [...F, ...videos];
                else { F = videos; pg = 1; }
                paginationState = { source: 'mastiraja_search', q, page, total: count || 0 };
                render();
            } catch (e) {
                console.error('MastiRaja search error:', e);
                if (!append) document.getElementById('grid').innerHTML = '<div class="empty">MastiRaja search failed.</div>';
            }
        }

        // ===== JIO TV / SPORTS M3U PARSER WITH DRM SUPPORT =====
        function parseM3UWithDRM(txt) {
            const channels = [];
            const lines = txt.split('\n');
            let currentChannel = null;
            let currentProps = {};

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                if (line.startsWith('#EXTINF:')) {
                    currentChannel = {};
                    currentProps = {};

                    // Parse EXTINF
                    const nameMatch = line.match(/,(.+)$/);
                    const logoMatch = line.match(/tvg-logo=["']([^"']+)["']/i);
                    const groupMatch = line.match(/group-title=["']([^"']+)["']/i);
                    const tvgIdMatch = line.match(/tvg-id=["']([^"']+)["']/i);

                    currentChannel.name = nameMatch ? nameMatch[1].trim() : 'Unknown';
                    currentChannel.logo = logoMatch ? logoMatch[1] : '';
                    currentChannel.group = groupMatch ? groupMatch[1] : '';
                    currentChannel.tvgId = tvgIdMatch ? tvgIdMatch[1] : '';
                } else if (line.startsWith('#KODIPROP:')) {
                    // Parse KODIPROP
                    const propMatch = line.match(/#KODIPROP:([^=]+)=(.+)/);
                    if (propMatch) {
                        const key = propMatch[1].trim();
                        const value = propMatch[2].trim();
                        if (!currentProps.kodiprop) currentProps.kodiprop = {};
                        currentProps.kodiprop[key] = value;
                    }
                } else if (line.startsWith('#EXTVLCOPT:')) {
                    // Parse EXTVLCOPT
                    const optMatch = line.match(/#EXTVLCOPT:([^=]+)=(.+)/);
                    if (optMatch) {
                        const key = optMatch[1].trim();
                        const value = optMatch[2].trim();
                        if (!currentProps.extvlcopt) currentProps.extvlcopt = {};
                        currentProps.extvlcopt[key] = value;
                    }
                } else if (line.startsWith('#EXTHTTP:')) {
                    // Parse EXTHTTP (JSON)
                    try {
                        const jsonMatch = line.match(/#EXTHTTP:(.+)/);
                        if (jsonMatch) {
                            currentProps.exthttp = JSON.parse(jsonMatch[1]);
                        }
                    } catch (e) {
                        console.warn('Failed to parse EXTHTTP:', e);
                    }
                } else if (line && !line.startsWith('#') && currentChannel) {
                    // URL line
                    currentChannel.url = line;
                    currentChannel.u = line;  // Add short alias for consistency
                    currentChannel.props = currentProps;
                    // Extract user-agent if available for easier access
                    if (currentProps.extvlcopt?.['http-user-agent']) {
                        currentChannel.ua = currentProps.extvlcopt['http-user-agent'];
                    }
                    channels.push(currentChannel);
                    currentChannel = null;
                    currentProps = {};
                }
            }

            return channels;
        }

        // Global variables to store channel data

        // 1. M3U PARSER: Extracts URL, DRM Keys, and Cookies
        function parseM3UWithDRM(txt) {
            const channels = [];
            const lines = txt.split('\n');
            let currentChannel = null;
            let currentProps = {};

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                if (line.startsWith('#EXTINF:')) {
                    currentChannel = {};
                    currentProps = {};

                    const nameMatch = line.match(/,(.+)$/);
                    const logoMatch = line.match(/tvg-logo=["']([^"']+)["']/i);
                    const groupMatch = line.match(/group-title=["']([^"']+)["']/i);

                    currentChannel.name = nameMatch ? nameMatch[1].trim() : 'Unknown';
                    currentChannel.logo = logoMatch ? logoMatch[1] : '';
                    currentChannel.group = groupMatch ? groupMatch[1] : '';
                } else if (line.startsWith('#KODIPROP:')) {
                    const propMatch = line.match(/#KODIPROP:([^=]+)=(.+)/);
                    if (propMatch) {
                        if (!currentProps.kodiprop) currentProps.kodiprop = {};
                        currentProps.kodiprop[propMatch[1].trim()] = propMatch[2].trim();
                    }
                } else if (line.startsWith('#EXTHTTP:')) {
                    try {
                        const jsonMatch = line.match(/#EXTHTTP:(.+)/);
                        if (jsonMatch) currentProps.exthttp = JSON.parse(jsonMatch[1]);
                    } catch (e) {
                        console.warn('Failed to parse EXTHTTP JSON', e);
                    }
                } else if (line && !line.startsWith('#') && currentChannel) {
                    currentChannel.url = line;
                    currentChannel.props = currentProps;
                    channels.push(currentChannel);
                    currentChannel = null;
                    currentProps = {};
                }
            }
            return channels;
        }

        // 2. LOAD JIO TV
        async function loadJioTV() {
            try {
                tab = 'jiotv';
                const grid = document.getElementById('jiotvGrid');
                grid.innerHTML = '<div class="loading">Loading Jio TV...</div>';

                const m3uUrl = 'https://raw.githubusercontent.com/SDJJN/auto-m3u-bot/main/jstar_drm.m3u';
                const response = await fetch(m3uUrl); // Direct fetch, no proxy
                const text = await response.text();

                jiotvChannels = parseM3UWithDRM(text);
                renderJioTVChannels();
            } catch (e) {
                console.error('Jio TV Load Error:', e);
            }
        }

        // 3. LOAD SPORTS
        async function loadSports() {
            try {
                tab = 'sports';
                const grid = document.getElementById('jiotvGrid');
                grid.innerHTML = '<div class="loading">Loading Sports...</div>';

                const m3uUrl = 'https://raw.githubusercontent.com/SDJJN/auto-m3u-bot/main/playlist_jpg.m3u';
                const response = await fetch(m3uUrl); // Direct fetch, no proxy
                const text = await response.text();

                sportsChannels = parseM3UWithDRM(text);
                renderJioTVChannels();
            } catch (e) {
                console.error('Sports Load Error:', e);
            }
        }

        // 4. RENDER CHANNELS
        function renderJioTVChannels() {
            const grid = document.getElementById('jiotvGrid');
            const channels = tab === 'jiotv' ? jiotvChannels : sportsChannels;

            // Filter logic (Search & Language)
            const searchTerm = document.getElementById('jiotvSearch')?.value.toLowerCase() || '';
            const languageFilter = document.getElementById('jiotvLanguageFilter')?.value || '';

            let filtered = channels.filter(ch => {
                const matchesSearch = !searchTerm || ch.name.toLowerCase().includes(searchTerm);
                const matchesLanguage = !languageFilter || (ch.group && ch.group.includes(languageFilter));
                return matchesSearch && matchesLanguage;
            });

            // Populate Language Dropdown
            const langSelect = document.getElementById('jiotvLanguageFilter');
            if (langSelect && langSelect.options.length <= 1) {
                const groups = [...new Set(channels.map(c => c.group).filter(Boolean))];
                groups.forEach(group => {
                    const opt = document.createElement('option');
                    opt.value = group;
                    opt.textContent = group;
                    langSelect.appendChild(opt);
                });
            }

            grid.innerHTML = filtered.map((ch, idx) => `
                <div class="channel-card" onclick="playChannel(${tab === 'jiotv' ? 'jiotvChannels' : 'sportsChannels'}[${channels.indexOf(ch)}])">
                    <img src="${ch.logo}" onerror="this.src='https://via.placeholder.com/150x84?text=No+Logo'">
                    <div class="name">${ch.name}</div>
                </div>
            `).join('');
        }

        // 5. PLAY CHANNEL (Redirects to video.html)
        function playChannel(channel) {
            const streamUrl = encodeURIComponent(channel.url);

            // Extract ClearKey DRM
            let keyId = "";
            let key = "";
            const licenseKey = channel.props?.kodiprop?.['inputstream.adaptive.license_key'];
            if (licenseKey && licenseKey.includes(':')) {
                const parts = licenseKey.split(':');
                keyId = parts[0];
                key = parts[1];
            }

            // Extract Cookie
            const cookieVal = encodeURIComponent(channel.props?.exthttp?.cookie || "");

            // Redirect to video.html
            window.location.href = `video.html?url=${streamUrl}&keyId=${keyId}&key=${key}&cookie=${cookieVal}`;
        }

        // Update quality selector
        function updateQualitySelector() {
            if (!shakaPlayer) return;

            const tracks = shakaPlayer.getVariantTracks();
            const qualitySelect = document.getElementById('shakaQuality');

            // Clear existing options except "Auto"
            qualitySelect.innerHTML = '<option value="auto">Auto Quality</option>';

            // Add quality options
            const uniqueHeights = [...new Set(tracks.map(t => t.height).filter(Boolean).sort((a, b) => b - a))];
            uniqueHeights.forEach(height => {
                const option = document.createElement('option');
                option.value = height;
                option.textContent = height + 'p';
                qualitySelect.appendChild(option);
            });
        }

        // Shaka Player controls
        function toggleShakaPlay() {
            if (!shakaPlayer) return;
            const video = document.getElementById('shakaVideo');
            if (video.paused) {
                video.play();
                document.getElementById('shakaPlayPause').textContent = '‚è∏Ô∏è';
            } else {
                video.pause();
                document.getElementById('shakaPlayPause').textContent = '‚ñ∂Ô∏è';
            }
        }

        function toggleShakaMute() {
            if (!shakaPlayer) return;
            const video = document.getElementById('shakaVideo');
            video.muted = !video.muted;
            document.getElementById('shakaMute').textContent = video.muted ? 'üîá' : 'üîä';
        }

        function setShakaVolume(value) {
            if (!shakaPlayer) return;
            const video = document.getElementById('shakaVideo');
            video.volume = value / 100;
        }

        function changeShakaQuality(value) {
            if (!shakaPlayer) return;
            const tracks = shakaPlayer.getVariantTracks();
            if (value === 'auto') {
                shakaPlayer.configure({ abr: { enabled: true } });
            } else {
                const height = parseInt(value);
                const track = tracks.find(t => t.height === height);
                if (track) {
                    shakaPlayer.selectVariantTrack(track, true);
                }
            }
        }

        function changeShakaAspect(value) {
            const video = document.getElementById('shakaVideo');
            const [w, h] = value.split(':').map(Number);
            video.style.aspectRatio = `${w}:${h}`;
        }

        let shakaRotation = 0;
        function toggleShakaOrientation() {
            shakaRotation = (shakaRotation + 90) % 360;
            const video = document.getElementById('shakaVideo');
            video.style.transform = `rotate(${shakaRotation}deg)`;
        }

        function toggleShakaFullscreen() {
            const container = document.getElementById('shakaPlayerContainer');
            if (!document.fullscreenElement) {
                container.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function closeShakaPlayer() {
            if (shakaPlayer) {
                shakaPlayer.destroy();
                shakaPlayer = null;
            }
            document.getElementById('shakaPlayerContainer').classList.remove('active');
            shakaCurrentChannel = null;
        }


        const wataaCache = {}; // Cache extracted video URLs

        async function playWataaVideo(c) {
            // Check cache first for instant playback
            if (wataaCache[c.u]) {
                const cached = wataaCache[c.u];
                playDirectVideo(c.n, c.g, cached.poster, cached.videoUrl);
                return;
            }

            // Show player box immediately with loading state
            const box = document.getElementById('playerBox');
            document.getElementById('nowTitle').textContent = c.n;
            document.getElementById('nowGroup').textContent = c.g;
            document.getElementById('nowImg').src = c.l || '';
            box.classList.add('active', 'loading');
            box.scrollIntoView({ behavior: 'smooth' });

            try {
                const res = await fetch(proxyUrl(c.u));
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const html = await res.text();

                const videoMatch = html.match(/<video[^>]*class="s-video"[^>]*src="([^"]+)"/i) ||
                    html.match(/<video[^>]*src="([^"]+)"[^>]*class="s-video"/i) ||
                    html.match(/<video[^>]*src="([^"]+)"/i) ||
                    html.match(/src:\s*['"]([^'"]+\.mp4(?:\?[^'"]*)?)['"]/i) ||
                    html.match(/source\s*src=["']([^"']+)["']/i);

                if (videoMatch && videoMatch[1]) {
                    const videoUrl = videoMatch[1].startsWith('//') ? 'https:' + videoMatch[1] : videoMatch[1];
                    const posterMatch = html.match(/<video[^>]*poster="([^"]+)"/i) || html.match(/posters?:\s*['"]([^'"]+)['"]/i);
                    const poster = posterMatch ? posterMatch[1] : c.l;

                    // Cache for future instant playback
                    wataaCache[c.u] = { videoUrl, poster };

                    stopHls();
                    resetControls();

                    const vid = document.getElementById('vid');
                    vid.src = videoUrl;
                    vid.load();
                    vid.play().catch(e => console.error('Play error:', e));
                    box.classList.remove('loading');
                } else {
                    throw new Error('Video URL not found in page');
                }
            } catch (e) {
                console.error('Wataa video extraction error:', e);
                box.classList.remove('loading', 'active');
                document.getElementById('grid').innerHTML = '<div class="empty">Failed to extract video.</div>';
            }
        }

        function playDirectVideo(title, group, poster, videoUrl) {
            const box = document.getElementById('playerBox');
            document.getElementById('nowTitle').textContent = title;
            document.getElementById('nowGroup').textContent = group;
            document.getElementById('nowImg').src = poster || '';
            box.classList.add('active');
            box.scrollIntoView({ behavior: 'smooth' });

            stopHls();
            resetControls();

            vid.src = videoUrl;
            vid.load();
            vid.play().catch(e => console.error('Play error:', e));
        }

        async function goPage(d) {
            const tot = Math.ceil(F.length / PP) || 1;
            if (d > 0 && pg >= tot && tab === 'zmaal' && F.length % 100 === 0) {
                const nextPage = Math.floor(F.length / 100) + 1;
                await loadZmaalPosts(nextPage);
                pg++; render();
            } else {
                pg += d; render();
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function goToPage() {
            const input = document.getElementById('pageInput');
            const tot = Math.ceil(F.length / PP) || 1;
            let targetPage = parseInt(input.value) || 1;
            if (targetPage < 1) targetPage = 1;
            if (targetPage > tot) targetPage = tot;
            pg = targetPage;
            input.value = pg;
            render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function kpmUrl(t) {
            if (!t) return '';
            // Decode common WP entities
            t = t.replace(/&#8211;/g, '-').replace(/&amp;/g, '&').replace(/&quot;/g, '"').replace(/&#8217;/g, "'");
            // Isolate symbols and years with spaces as requested
            // Handle number+symbol (e.g., 200%) by adding space after
            t = t.replace(/([0-9]+[%])(?![ ])/g, '$1 ');
            // Handle (Year) by adding space before and after
            t = t.replace(/(?<! )(\([0-9]{4}\))/g, ' $1'); // space before
            t = t.replace(/(\([0-9]{4}\))(?![ ])/g, '$1 '); // space after

            // Replace all spaces with %20, collapse multiples, trim
            const res = t.trim().replace(/\s+/g, '%20');
            return `https://koreanporn.stream/${res}.mp4`;
        }

        function render() {
            const tot = Math.ceil(F.length / PP) || 1;
            if (pg > tot) pg = tot;
            const s = (pg - 1) * PP, sl = F.slice(s, s + PP);
            document.getElementById('pageInfo').textContent = `${pg}/${tot}`;
            document.getElementById('pageInfo2').textContent = `${pg}/${tot}`;
            document.getElementById('prevBtn').disabled = pg <= 1;
            document.getElementById('nextBtn').disabled = pg >= tot;
            document.getElementById('prevBtn2').disabled = pg <= 1;
            document.getElementById('nextBtn2').disabled = pg >= tot;
            if (!sl.length) { document.getElementById('grid').innerHTML = '<div class="empty">No results</div>'; return; }
            document.getElementById('grid').innerHTML = sl.map((c, i) => `
                <div class="card" data-i="${s + i}" data-videourl="${esc(c.u || '')}">
                    <div class="thumb" data-logo="${esc(c.l)}">
                        ${(c.n || '?').charAt(0).toUpperCase()}
                        <div class="play-overlay"><div class="play-btn"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div></div>
                    </div>
                    <div class="info"><h3>${esc(c.n || 'Unknown')}</h3><p>${esc(c.g || '')}</p></div>
                </div>
            `).join('');

            // Intelligent Load More Visibility
            let hasMore = false;
            if ((paginationState.source === 'desitales_videos' || paginationState.source === 'iss3_videos') && paginationState.total > 0) {
                hasMore = F.length < paginationState.total;
            } else if (paginationState.source) {
                hasMore = sl.length === PP; // Fallback: page was full
            }

            // Universal Load More button at the end of the grid
            if (pg === tot && hasMore) {
                const btn = document.createElement('button');
                btn.id = 'loadMoreBtn';
                btn.className = 'pg-btn';
                btn.style.cssText = 'grid-column: 1 / -1; margin: 20px auto; padding: 15px 40px; font-size: 14px; background: linear-gradient(135deg, #a855f7, #9333ea); border: none; color: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3); cursor: pointer; transition: transform 0.2s;';
                btn.innerHTML = 'üîÑ Load More Content';
                btn.onclick = loadMore;
                btn.onmousedown = () => btn.style.transform = 'scale(0.95)';
                btn.onmouseup = () => btn.style.transform = 'scale(1)';
                grid.appendChild(btn);
            }



            // AGGRESSIVE: Preload first 20 images with high priority
            if (pg === 1) {
                sl.slice(0, 20).forEach((c, i) => {
                    if (c.l) {
                        const preloadLink = document.createElement('link');
                        preloadLink.rel = 'preload';
                        preloadLink.as = 'image';
                        preloadLink.href = c.l;
                        preloadLink.fetchPriority = i < 12 ? 'high' : 'low';
                        document.head.appendChild(preloadLink);
                    }
                });
            }

            lazyLogos();
            document.querySelectorAll('.card').forEach(c => c.onclick = () => play(+c.dataset.i));
        }

        async function goPage(d) {
            const tot = Math.ceil(F.length / PP) || 1;
            if (d > 0 && pg >= tot && paginationState.source) {
                await loadMore();
                pg++; render();
            } else {
                pg += d; render();
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        function toLatin(input) {
            const s = String(input || "");
            if (!/[–ê-–Ø–∞-—è–Å—ë]/.test(s)) return s;
            const map = {
                "–ê":"A","–ë":"B","–í":"V","–ì":"G","–î":"D","–ï":"E","–Å":"E","–ñ":"Zh","–ó":"Z","–ò":"I","–ô":"Y","–ö":"K","–õ":"L","–ú":"M","–ù":"N","–û":"O","–ü":"P","–†":"R","–°":"S","–¢":"T","–£":"U","–§":"F","–•":"Kh","–¶":"Ts","–ß":"Ch","–®":"Sh","–©":"Shch","–™":"","–´":"Y","–¨":"","–≠":"E","–Æ":"Yu","–Ø":"Ya",
                "–∞":"a","–±":"b","–≤":"v","–≥":"g","–¥":"d","–µ":"e","—ë":"e","–∂":"zh","–∑":"z","–∏":"i","–π":"y","–∫":"k","–ª":"l","–º":"m","–Ω":"n","–æ":"o","–ø":"p","—Ä":"r","—Å":"s","—Ç":"t","—É":"u","—Ñ":"f","—Ö":"kh","—Ü":"ts","—á":"ch","—à":"sh","—â":"shch","—ä":"","—ã":"y","—å":"","—ç":"e","—é":"yu","—è":"ya"
            };
            return s.split("").map(ch => (map[ch] ?? ch)).join("");
        }

        function esc(s) {
            return toLatin(String(s || ""))
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }

        // Instant parallel image loading - with abort capability
        const imageCache = new Map();
        let playerLoading = false; // Flag to pause image loading when player is active
        let pendingImageLoads = []; // Track pending image requests to abort

        function lazyLogos() {
            // Skip loading if player is currently loading video
            if (playerLoading) return;

            // INSTANT parallel loading - NO lazy loading, NO video extraction
            document.querySelectorAll('.thumb[data-logo]').forEach(t => {
                const url = t.dataset.logo;
                if (url) {
                    if (imageCache.has(url)) {
                        const cachedImg = imageCache.get(url).cloneNode();
                        t.innerHTML = '';
                        t.appendChild(cachedImg);
                        t.classList.add('loaded');
                        return;
                    }
                    const img = new Image();
                    pendingImageLoads.push(img); // Track for potential abort
                    let retries = 0;
                    t.classList.add('loading');
                    const tryLoad = () => {
                        img.onload = () => {
                            imageCache.set(url, img);
                            t.innerHTML = '';
                            t.appendChild(img);
                            t.classList.remove('loading');
                            t.classList.add('loaded');
                            // Remove from pending
                            const idx = pendingImageLoads.indexOf(img);
                            if (idx > -1) pendingImageLoads.splice(idx, 1);
                        };
                        img.onerror = () => {
                            retries++;
                            if (retries < 2 && !playerLoading) tryLoad();
                            else {
                                t.classList.remove('loading');
                                showGradientFallback(t);
                            }
                        };
                        img.decoding = 'async';
                        img.fetchPriority = 'low'; // Low priority - video takes precedence
                        img.src = url;
                    };
                    tryLoad();
                } else {
                    showGradientFallback(t);
                }
            });
        }

        function filterCh() {
            const q = document.getElementById('search').value.toLowerCase();
            if (!D[tab]) return;
            F = D[tab].filter(c => c.n.toLowerCase().includes(q) || c.g.toLowerCase().includes(q));
            pg = 1;
            render();
        }



        function showGradientFallback(targetElement) {
            targetElement.innerHTML = targetElement.textContent.charAt(0).toUpperCase();
            targetElement.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        }

        // Player
        // Prevent rapid clicking crashes
        let isOperationInProgress = false;
        let lastOperationTime = 0;
        let currentVideoIndex = -1; // Track current playing video

        async function play(idx) {
            // Debounce to prevent crashes from rapid clicks
            const now = Date.now();
            if (isOperationInProgress || (now - lastOperationTime < 300)) {
                console.log('Operation in progress, please wait...');
                return;
            }

            isOperationInProgress = true;
            lastOperationTime = now;
            currentVideoIndex = idx; // Store current video index

            // PRIORITY: Stop all image loading to free bandwidth for video
            playerLoading = true;
            pendingImageLoads.forEach(img => {
                if (img && img.src) img.src = ''; // Abort pending image loads
            });
            pendingImageLoads = [];

            // Multi-buffering: warm up the next video in the background
            prefetchNextVideo(idx + 1);

            // Update prev/next button states
            updateNavigationButtons();

            try {
                const c = F[idx];
                if (!c) {
                    throw new Error('Invalid content selected');
                }

                // Handle ViralFap - load posts for category OR extract video for post
                if (tab === 'viralfap' && c.u && c.u.startsWith('viralfap:')) {
                    const catId = c.u.split(':')[1];
                    await loadViralFapPosts(catId, c.n);
                    return;
                }

                // Handle Wataa - All in One navigation
                if (c.u === 'wataa:menu') {
                    F = D.wataaCategories;
                    pg = 1;
                    render();
                    return;
                }
                if (c.u === 'wataa:tagmenu') {
                    F = D.wataaTags;
                    pg = 1;
                    render();
                    return;
                }
                if (c.u && c.u.startsWith('wataacat:')) {
                    const catId = c.cid;
                    await loadWataaPosts('categories', catId, c.n);
                    return;
                }
                if (c.u && c.u.startsWith('wataatag:')) {
                    const tagId = c.tid;
                    await loadWataaPosts('tags', tagId, c.n);
                    return;
                }
                if (c._isWataaPost) {
                    await playWataaVideo(c);
                    return;
                }

                // Handle Desi Tales - Menu Navigation
                if (c.u === 'desitales:catmenu') {
                    paginationState = { source: null };
                    F = D.desitalesCategories || [];
                    pg = 1;
                    render();
                    return;
                }
                if (c.u === 'desitales:tagmenu') {
                    paginationState = { source: null };
                    F = D.desitalesTags || [];
                    pg = 1;
                    render();
                    return;
                }
                // Handle Desi Tales - Categories and Tags content loading
                if (c.u === 'desitales:uncategorized') {
                    await loadDesitalesVideos('category', null, 'Uncategorized', 1, false);
                    return;
                }
                if (c.u && c.u.startsWith('desitalescat:')) {
                    const catId = parseInt(c.u.replace('desitalescat:', ''));
                    await loadDesitalesVideos('category', catId, c.n.replace('üìÅ ', ''), 1, false);
                    return;
                }
                if (c.u && c.u.startsWith('desitalestag:')) {
                    const tagId = parseInt(c.u.replace('desitalestag:', ''));
                    await loadDesitalesVideos('tag', tagId, c.n.replace('üè∑Ô∏è ', ''), 1, false);
                    return;
                }

                // Handle XnxxVideos - Categories
                if (c.u && c.u.startsWith('xnxxcat:')) {
                    const catId = parseInt(c.u.replace('xnxxcat:', ''));
                    await loadXnxxVideos('category', catId, c.n.replace('üìÅ ', ''), 1, false);
                    return;
                }

                // Handle MastiRaja - Categories
                if (c.u && c.u.startsWith('mastirajacat:')) {
                    const catId = parseInt(c.u.replace('mastirajacat:', ''));
                    await loadMastirajaVideos('category', catId, c.n.replace('üìÅ ', ''), 1, false);
                    return;
                }

                // Handle ISS3 - Menu Navigation
                if (c.u === 'iss3:catmenu') {
                    paginationState = { source: null };
                    F = D.iss3Categories || [];
                    pg = 1;
                    render();
                    return;
                }
                if (c.u === 'iss3:tagmenu') {
                    paginationState = { source: null };
                    F = D.iss3Tags || [];
                    pg = 1;
                    render();
                    return;
                }

                // Handle ISS3 - Categories and Tags content loading
                if (c.u === 'iss3:uncategorized') {
                    await loadISS3Videos('category', null, 'Uncategorized', 1, false);
                    return;
                }
                if (c.u && c.u.startsWith('iss3cat:')) {
                    const catId = parseInt(c.u.replace('iss3cat:', ''));
                    await loadISS3Videos('category', catId, c.n.replace('üìÅ ', ''), 1, false);
                    return;
                }
                if (c.u && c.u.startsWith('iss3tag:')) {
                    const tagId = parseInt(c.u.replace('iss3tag:', ''));
                    await loadISS3Videos('tag', tagId, c.n.replace('üè∑Ô∏è ', ''), 1, false);
                    return;
                }

                if (c.u && c.u.startsWith('kpmcat:')) {
                    currentCategory = { id: c.cid, name: c.n, source: 'kpm' };
                    await loadKPMPosts(c.cid, c.n);
                    return;
                }

                if (c._isKPMRemote) {
                    // Search result - URL is already handled by kpmUrl(r.title) in searchKPM
                }

                if (c._isViralfapPost) {
                    if (prefetchHls) { prefetchHls.destroy(); prefetchHls = null; }
                    await playFullCinema(c);
                    return;
                }

                // Handle FullCinema - extract video URL first
                if (tab === 'fullcinema' && c._raw) {
                    await playFullCinema(c);
                    return;
                }

                // Handle XNXX with Dual-Domain Fallback
                if (c._isXNXX) {
                    const box = document.getElementById('playerBox');
                    document.getElementById('nowTitle').textContent = c.n;
                    document.getElementById('nowGroup').textContent = c.g;
                    document.getElementById('nowImg').src = c.l || '';
                    box.classList.add('active', 'loading');
                    box.scrollIntoView({ behavior: 'smooth' });

                    stopHls();
                    resetControls();

                    const vid = document.getElementById('vid');
                    const iframe = document.getElementById('iframePlayer');
                    vid.style.display = 'block';
                    iframe.style.display = 'none';
                    document.getElementById('controls').style.display = 'block';

                    // Show Fix URL button for XNXX
                    const fixBtn = document.getElementById('fixUrlBtn');
                    if (fixBtn) {
                        fixBtn.style.display = 'block';
                        // Store current video details for the modal
                        fixBtn.dataset.vidId = c.id;
                        fixBtn.dataset.currentUrl = c.u;
                    }

                    let domainIdx = 0;

                    const relativeUrl = c.u;
                    if (!relativeUrl) {
                        box.classList.remove('loading');
                        showErrorMessage('Video URL missing.');
                        return;
                    }

                    const tryPlayXnxx = () => {
                        const fullUrl = relativeUrl;
                        console.log(`[XNXX] Attempting: ${fullUrl}`);

                        // Clear previous events
                        vid.onerror = null;
                        vid.onloadeddata = null;

                        vid.src = fullUrl;
                        vid.load();

                        const playPromise = vid.play();
                        if (playPromise !== undefined) {
                            playPromise.catch(e => {
                                console.warn(`[XNXX] Play promise rejection on ${fullUrl}:`, e);
                                // Don't rely solely on promise rejection for network errors, wait for onerror
                            });
                        }

                        vid.onerror = (e) => {
                            console.error(`[XNXX] Error on ${fullUrl}:`, vid.error);
                            if (domainIdx < domains.length - 1) {
                                domainIdx++;
                                console.log(`[XNXX] Switching to secondary domain...`);
                                tryPlayXnxx();
                            } else {
                                box.classList.remove('loading');
                                showErrorMessage('Video unavailable on both servers.');
                            }
                        };

                        vid.onloadeddata = () => {
                            console.log(`[XNXX] Success: ${fullUrl}`);
                            box.classList.remove('loading');
                        };
                    };

                    tryPlayXnxx();
                    return;
                }

                const box = document.getElementById('playerBox');
                const iframe = document.getElementById('iframePlayer');
                document.getElementById('nowTitle').textContent = c.n;
                document.getElementById('nowGroup').textContent = c.g;
                document.getElementById('nowImg').src = c.l || '';
                box.classList.add('active', 'loading');
                box.scrollIntoView({ behavior: 'smooth' });

                stopHls();
                resetControls();

                // Check if it's a webpage site - load in fullscreen browser overlay
                const isWebpage = !c.u.match(/\.(m3u8|mp4|ts|mkv|webm|mpd|m3u)($|\?)/i);

                if (isWebpage) {
                    const isBrowsingPage = (c.u.includes('xhamster') && !c.u.includes('/videos/')) ||
                        (c.u.includes('eroticmv.com') && (c.u.endsWith('.com/') || c.u.includes('/latest-updates/') || c.u.includes('/most-popular/') || c.u.includes('/top-rated/') || c.u.includes('/categories/')));

                    if (!isBrowsingPage && (c.u.includes('noodlemagazine.com') || c.u.includes('xhamster.desi') || c.u.includes('eroticmv.com'))) {
                        await extractAndPlay(c.u, c.n);
                        return;
                    }
                    box.classList.remove('active', 'loading');
                    await openWebpage(c.n, c.u);
                    return;
                }

                if (prefetchHls) { prefetchHls.destroy(); prefetchHls = null; }

                // Pause image loading - prioritize player
                playerLoading = true;

                // Determine if proxy is needed based on tab
                let url = c.u;
                const originalUrl = c.u;
                const proxyTabs = ['video', 'm3u8', 'adultiptv', 'tv', 'korean'];
                const fallbackProxyTabs = ['jiotv', 'sports'];
                const isBabesChannel = c.n && c.n.toLowerCase().includes('babes');

                // For regular proxyTabs we still proxy immediately. Also force proxy if channel provides EXTHTTP cookie.
                if (proxyTabs.includes(tab) && !isBabesChannel && url && !url.startsWith('/api/proxy')) {
                    // set global proxy UA/cookie so other helper calls pick it up
                    window.__proxyUA = c.ua || window.__proxyUA || '';
                    window.__proxyCookie = c.props?.exthttp?.cookie || window.__proxyCookie || '';
                    url = proxyUrl(c.u);
                }

                // If the channel includes an EXTHTTP cookie or a cookie query param, always start via proxy
                if ((c.props?.exthttp?.cookie || (c.u && c.u.includes('cookie='))) && url && !url.startsWith('/api/proxy')) {
                    window.__proxyUA = c.ua || window.__proxyUA || '';
                    window.__proxyCookie = c.props?.exthttp?.cookie || (c.u && (new URL(c.u).searchParams.get('cookie'))) || window.__proxyCookie || '';
                    if (fallbackProxyTabs.includes(tab)) {
                        try {
                            let target = c.u;
                            if (c.ua) target += (c.u.includes('?') ? '&' : '?') + 'ua=' + encodeURIComponent(c.ua);
                            if (c.props?.exthttp?.cookie) target += (c.u.includes('?') ? '&' : '?') + 'cookie=' + encodeURIComponent(c.props.exthttp.cookie);
                            url = buildExternalProxyUrl(target);
                        } catch (e) {
                            url = proxyUrl(c.u);
                        }
                    } else {
                        url = proxyUrl(c.u);
                    }
                    usedProxyForAttempt = true;
                }

                // For JioTV/Sports: try direct first; fallback to proxy on failure
                const allowFallbackProxy = fallbackProxyTabs.includes(tab) && !isBabesChannel && url;
                let usedProxyForAttempt = url.startsWith('/api/proxy');

                // Prefetch next video for instant playback
                if (idx + 1 < F.length && F[idx + 1].u) {
                    const nextUrl = F[idx + 1].u;
                    if (nextUrl.match(/\.(mp4|m3u8)($|\?)/i)) {
                        prefetchNextVideo(nextUrl);
                    }
                }

                // Normal video playback
                vid.style.display = 'block';
                iframe.style.display = 'none';
                iframe.src = '';
                document.getElementById('controls').style.display = 'block';

                // Detect if content is HLS manifest - check original URL to be safe through proxy
                const checkUrl = c.u.toLowerCase();
                const isHls = checkUrl.includes('.m3u') || checkUrl.includes('.m3u8');
                const isTsStream = checkUrl.includes('.ts') && !isHls;

                // Detect type
                const badge = document.getElementById('statusBadge');
                if (isHls || isTsStream) {
                    badge.textContent = 'LIVE';
                    badge.className = 'status-badge live';
                    isLive = true;
                } else {
                    badge.textContent = 'VOD';
                    badge.className = 'status-badge vod';
                    isLive = false;
                }

                if (isHls && Hls.isSupported()) {
                    const originalUrl = c.u;
                    // Use external CORS proxy for JioTV/Sports when configured, otherwise use internal proxyUrl helper
                    let proxiedOriginal;
                    if (fallbackProxyTabs.includes(tab)) {
                        try {
                            let target = originalUrl;
                            if (c.ua) target += (originalUrl.includes('?') ? '&' : '?') + 'ua=' + encodeURIComponent(c.ua);
                            if (c.props?.exthttp?.cookie) target += (originalUrl.includes('?') ? '&' : '?') + 'cookie=' + encodeURIComponent(c.props.exthttp.cookie);
                            proxiedOriginal = buildExternalProxyUrl(target);
                        } catch (e) {
                            proxiedOriginal = proxyUrl(originalUrl);
                        }
                    } else {
                        proxiedOriginal = proxyUrl(originalUrl);
                    }
                    let attempts = 0;
                    let usingProxy = usedProxyForAttempt;

                    const createHlsInstance = (sourceUrl) => {
                        if (hls) { try { hls.destroy(); } catch (e) { } hls = null; }
                        attempts = 0;
                        hls = new Hls({
                            xhrSetup: (xhr) => { xhr.withCredentials = false; },
                            enableWorker: true,
                            startPosition: 0,
                            startLevel: -1,
                            abrEwmaDefaultEstimate: 5000000,
                            maxBufferLength: isLive ? 10 : 60,
                            maxMaxBufferLength: isLive ? 30 : 300,
                            maxBufferSize: 100 * 1024 * 1024,
                            maxBufferHole: 0.1,
                            highBufferWatchdogPeriod: 0.5,
                            nudgeOffset: 0.1,
                            nudgeMaxRetry: 20,
                            lowLatencyMode: true,
                            liveSyncDurationCount: 2,
                            liveMaxLatencyDurationCount: 4,
                            enableLowLatencyLiveScan: true,
                            initialLiveManifestSize: 1,
                            maxLoadingDelay: 0,
                            minAutoBitrate: 0,
                            maxStarvationDelay: 0,
                            fragLoadingMaxRetry: 10,
                            manifestLoadingMaxRetry: 10,
                            startFragPrefetch: true,
                            testBandwidth: false,
                            progressive: true,
                            backBufferLength: isLive ? 60 : 600,
                            maxFragLookUpTolerance: 0.001,
                            appendErrorMaxRetry: 5
                        });

                        hls.on(Hls.Events.ERROR, (e, data) => {
                            console.error('HLS Error:', data);
                            if (data.fatal) {
                                attempts++;
                                // If we haven't tried proxy yet and this tab supports fallback, try proxied URL once
                                if (!usingProxy && allowFallbackProxy && data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                                    usingProxy = true;
                                    box.classList.add('loading');
                                    startHls(proxiedOriginal, true);
                                    return;
                                }

                                if (attempts < 3) {
                                    setTimeout(() => {
                                        if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
                                            try { hls.recoverMediaError(); } catch (e) { }
                                        } else if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                                            try { hls.startLoad(); } catch (e) { }
                                        }
                                    }, 1000);
                                } else {
                                    box.classList.remove('loading');
                                    showErrorMessage('Stream unavailable. Please try another video.');
                                    stopPlayer();
                                }
                            }
                        });

                        hls.loadSource(sourceUrl);
                        hls.attachMedia(vid);

                        hls.on(Hls.Events.MANIFEST_PARSED, (e, data) => {
                            box.classList.remove('loading');

                            // Resume from last position (use original URL key so resume stays consistent)
                            const lastPos = localStorage.getItem('pos_' + btoa(originalUrl));
                            if (lastPos) vid.currentTime = parseFloat(lastPos);

                            vid.play().catch((err) => {
                                console.error('Play error:', err);
                                showErrorMessage('Playback failed. Click to retry.');
                                // If playback failed and fallback is allowed, attempt proxy
                                if (!usingProxy && allowFallbackProxy) {
                                    usingProxy = true;
                                    startHls(proxiedOriginal, true);
                                }
                            });

                            // Check if VOD
                            if (hls.levels && hls.levels[0]) {
                                const dur = hls.levels[0].details?.totalduration;
                                if (dur && dur > 0 && dur < 86400) {
                                    isLive = false;
                                    badge.textContent = 'VOD';
                                    badge.className = 'status-badge vod';
                                }
                                if (hls.levels && hls.levels[hls.currentLevel]) {
                                    const h = hls.levels[hls.currentLevel].height || hls.levels[0].height;
                                    if (h) document.getElementById('qualityBadge').textContent = h + 'p';
                                }
                                setupQualitySelector();
                            }
                        });

                        hls.on(Hls.Events.LEVEL_SWITCHED, (v, data) => {
                            const level = hls.levels[data.level];
                            if (level && level.height) {
                                document.getElementById('qualityBadge').textContent = level.height + 'p';
                            }
                        });
                    };

                    const startHls = (sourceUrl, viaProxy = false) => {
                        usingProxy = viaProxy || usingProxy;
                        createHlsInstance(sourceUrl);
                    };

                    // Start with the pre-determined url (direct or proxied for other tabs)
                    startHls(url, usedProxyForAttempt);
                } else if (isTsStream && mpegts.isSupported()) {
                    tsPlayer = mpegts.createPlayer({
                        type: 'mse',
                        isLive: true,
                        url: url
                    });
                    tsPlayer.attachMediaElement(vid);
                    tsPlayer.load();
                    tsPlayer.play().catch(e => {
                        console.error('MPEG-TS Play error:', e);
                        box.classList.remove('loading');
                        showErrorMessage('TS stream failed to play');
                    });
                } else if (vid.canPlayType('application/vnd.apple.mpegurl') && isHls) {
                    vid.src = url;
                    vid.play().catch((err) => {
                        console.error('Play error:', err);
                        box.classList.remove('loading');
                        showErrorMessage('Playback failed');
                    });
                } else {
                    // For KPM videos: Use smart fallback retry on error with auto-fix
                    if (c._isKPM && c._fallbackUrls && c._fallbackUrls.length > 0) {
                        let currentFallbackIndex = -1;
                        const originalUrl = url; // Track original URL

                        // Helper to show KPM status toast
                        const showKpmStatus = (msg) => {
                            const toast = document.createElement('div');
                            toast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(168,85,247,0.9);color:#fff;padding:10px 20px;border-radius:20px;z-index:9999;font-size:12px;font-weight:600;box-shadow:0 4px 15px rgba(0,0,0,0.3);backdrop-filter:blur(5px);';
                            toast.textContent = msg;
                            document.body.appendChild(toast);
                            setTimeout(() => {
                                toast.style.transition = 'opacity 0.5s';
                                toast.style.opacity = '0';
                                setTimeout(() => toast.remove(), 500);
                            }, 2000);
                        };

                        const tryPlayKPM = async (videoUrl) => {
                            const manipulationNum = currentFallbackIndex + 2;
                            if (currentFallbackIndex >= 0) {
                                showKpmStatus(`Trying manipulation #${manipulationNum}...`);
                            }
                            console.log(`[KPM] Trying URL:`, videoUrl);

                            vid.src = videoUrl;
                            vid.load();

                            vid.onerror = async () => {
                                currentFallbackIndex++;
                                if (currentFallbackIndex < c._fallbackUrls.length) {
                                    tryPlayKPM(c._fallbackUrls[currentFallbackIndex]);
                                } else if (currentFallbackIndex === c._fallbackUrls.length) {
                                    // TIER 3: DISCOVERY SCRAPING
                                    showKpmStatus('Searching for working link... please wait');
                                    console.log('[KPM] Starting Discovery Tier...');
                                    try {
                                        const discRes = await fetch(`/api/proxy?extract=kpm&title=${encodeURIComponent(c.n)}`);
                                        if (discRes.ok) {
                                            const discData = await discRes.json();
                                            if (discData.video) {
                                                console.log('[KPM] Discovered new URL:', discData.video);
                                                showKpmStatus('New link discovered! Starting playback...');
                                                currentFallbackIndex++; // Move past the end
                                                tryPlayKPM(discData.video);
                                                return;
                                            }
                                        }
                                        throw new Error('Discovery failed');
                                    } catch (e) {
                                        console.error('[KPM] Discovery failed:', e);
                                        box.classList.remove('loading');
                                        showErrorMessage('Video unavailable - Discovery failed');
                                    }
                                } else {
                                    console.error('[KPM] All recovery paths exhausted');
                                    box.classList.remove('loading');
                                    showErrorMessage('Video unavailable - all attempts failed');
                                }
                            };

                            vid.onloadeddata = () => {
                                console.log('[KPM] Success with URL:', videoUrl);
                                vid.onerror = null; // Clear error handler

                                // AUTO-FIX: Update database ONLY if new working URL differs from DB
                                if (c.n) {
                                    // Extract the raw URL (strip proxy if present)
                                    let workingRawUrl = videoUrl;
                                    const proxyMatch = videoUrl.match(/url=([^&]+)/);
                                    if (proxyMatch) workingRawUrl = decodeURIComponent(proxyMatch[1]);

                                    // Compare raw with DB (c.u is original from Supabase)
                                    if (workingRawUrl !== c.u) {
                                        console.log('[KPM] Auto-fixing DB with verified new URL:', workingRawUrl);
                                        supabaseClient
                                            .from('koreanpornmovie')
                                            .update({ stream_url: workingRawUrl })
                                            .eq('title', c.n)
                                            .then(({ error }) => {
                                                if (!error) console.log('[KPM] ‚úÖ DB self-healed for:', c.n);
                                            });
                                    } else {
                                        console.log('[KPM] Working URL matches DB, no update needed.');
                                    }
                                }
                            };
                            vid.play().catch(() => { });
                        };
                        tryPlayKPM(url);
                    } else {
                        // Standard MP4 playback - OPTIMIZED for instant startup
                        vid.preload = 'auto';
                        vid.src = url;

                        // Error handler to fallback to proxy if allowed
                        vid.onerror = () => {
                            console.error('MP4 playback error for', url);
                            if (allowFallbackProxy && !usedProxyForAttempt) {
                                usedProxyForAttempt = true;
                                // ensure globals available
                                window.__proxyUA = c.ua || window.__proxyUA || '';
                                window.__proxyCookie = c.props?.exthttp?.cookie || window.__proxyCookie || '';
                                let proxied;
                                if (fallbackProxyTabs.includes(tab)) {
                                    let target = originalUrl;
                                    if (c.ua) target += (originalUrl.includes('?') ? '&' : '?') + 'ua=' + encodeURIComponent(c.ua);
                                    if (c.props?.exthttp?.cookie) target += (originalUrl.includes('?') ? '&' : '?') + 'cookie=' + encodeURIComponent(c.props.exthttp.cookie);
                                    proxied = buildExternalProxyUrl(target);
                                } else {
                                    proxied = proxyUrl(originalUrl);
                                }
                                vid.onerror = null;
                                vid.src = proxied;
                                vid.load();
                                vid.play().catch(() => { });
                                return;
                            }
                            box.classList.remove('loading');
                            showErrorMessage('Playback failed');
                        };

                        // Start playing as soon as we have enough data
                        vid.oncanplay = () => {
                            vid.play().catch((err) => {
                                console.error('Play error:', err);
                                // Try fallback proxy once
                                if (allowFallbackProxy && !usedProxyForAttempt) {
                                    usedProxyForAttempt = true;
                                    window.__proxyUA = c.ua || window.__proxyUA || '';
                                    window.__proxyCookie = c.props?.exthttp?.cookie || window.__proxyCookie || '';
                                    let proxied;
                                    if (fallbackProxyTabs.includes(tab)) {
                                        let target = originalUrl;
                                        if (c.ua) target += (originalUrl.includes('?') ? '&' : '?') + 'ua=' + encodeURIComponent(c.ua);
                                        if (c.props?.exthttp?.cookie) target += (originalUrl.includes('?') ? '&' : '?') + 'cookie=' + encodeURIComponent(c.props.exthttp.cookie);
                                        proxied = buildExternalProxyUrl(target);
                                    } else {
                                        proxied = proxyUrl(originalUrl);
                                    }
                                    vid.src = proxied;
                                    vid.load();
                                    vid.play().catch(() => { });
                                    return;
                                }
                                box.classList.remove('loading');
                                showErrorMessage('Playback failed');
                            });
                        };

                        // Fallback: play immediately without waiting
                        vid.load();
                        setTimeout(() => {
                            if (vid.paused && vid.readyState >= 2) {
                                vid.play().catch(() => { });
                            }
                        }, 100);
                    }
                }
            } catch (error) {
                console.error('Play error:', error);
                showErrorMessage('Failed to load content: ' + error.message);
                document.getElementById('playerBox').classList.remove('active', 'loading');
            } finally {
                setTimeout(() => {
                    isOperationInProgress = false;
                    playerLoading = false; // Resume image loading
                    lazyLogos(); // Load remaining images
                }, 500);
            }
        }


        // Load ViralFap posts for a category with retry
        async function loadViralFapPosts(catId, catName) {
            document.getElementById('grid').innerHTML = '<div class="empty"><div class="spin"></div>Loading ' + catName + '...</div>';

            let attempts = 0;
            const maxAttempts = 3;

            while (attempts < maxAttempts) {
                try {
                    const res = await fetch(`https://viralfap.com/wp-json/wp/v2/posts?categories=${catId}&per_page=100`);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);

                    const posts = await res.json();
                    F = posts.map(p => ({
                        n: p.title?.rendered || 'Untitled',
                        l: p.yoast_head_json?.og_image?.[0]?.url || p._embedded?.['wp:featuredmedia']?.[0]?.source_url || '',
                        g: catName,
                        u: p.link,
                        _raw: p,
                        _isViralfapPost: true
                    }));
                    if (tab === 'zmaal' && pg === tot && F.length >= 100) {
                        // Simple infinite-ish scroll/next page for Zmaal
                        const nextPage = Math.floor(D.zmaal.length / 100) + 1;
                        await loadZmaalPosts(nextPage);
                        return;
                    }
                    pg++; render();
                    return;
                } catch (e) {
                    attempts++;
                    console.error(`Attempt ${attempts} failed:`, e);
                    if (attempts < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, 1000 * attempts));
                    } else {
                        document.getElementById('grid').innerHTML = '<div class="empty">Failed to load posts. Please try again.</div>';
                    }
                }
            }
        }

        async function loadKPMPosts(catId, catName, page = 1, append = false) {
            if (!append) document.getElementById('grid').innerHTML = '<div class="empty"><div class="spin"></div>Loading ' + catName + '...</div>';
            try {
                const res = await fetch(`https://koreanpornmovie.com/wp-json/wp/v2/media?categories=${catId}&per_page=100&page=${page}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const mediaItems = await res.json();
                const mapped = mediaItems.map(m => {
                    const title = m.title?.rendered || 'Untitled';
                    const streamUrl = kpmUrl(title);
                    return {
                        n: title,
                        l: m.source_url || m.guid?.rendered || '',
                        g: catName,
                        u: streamUrl,
                        _kpmMedia: m
                    };
                });
                if (append) F = [...F, ...mapped];
                else {
                    F = mapped;
                    pg = 1;
                }

                paginationState = { source: 'kpm', id: catId, name: catName, page };
                render();
            } catch (e) {
                console.error('KPM media error:', e);
                if (!append) document.getElementById('grid').innerHTML = '<div class="empty">Failed to load media.</div>';
            }
        }

        // Extract and play FullCinema or ViralFap video with retry
        async function playFullCinema(c) {
            const box = document.getElementById('playerBox');
            const isViralfap = c._isViralfapPost;
            document.getElementById('nowTitle').textContent = c.n;
            document.getElementById('nowGroup').textContent = isViralfap ? 'ViralFap' : 'FullXCinema';
            document.getElementById('nowImg').src = c.l || '';
            box.classList.add('active', 'loading');
            box.scrollIntoView({ behavior: 'smooth' });
            stopHls();
            resetControls();

            let attempts = 0;
            const maxAttempts = 2;

            while (attempts < maxAttempts) {
                try {
                    // Try server-side extraction first for better reliability
                    const extractUrl = `/api/proxy?extract=true&url=${encodeURIComponent(c.u)}`;
                    const res = await fetch(extractUrl);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);

                    const data = await res.json();
                    let videoUrl = data.video;

                    if (videoUrl) {
                        vid.style.display = 'block';
                        document.getElementById('iframePlayer').style.display = 'none';
                        document.getElementById('controls').style.display = 'block';
                        document.getElementById('statusBadge').textContent = 'VOD';
                        document.getElementById('statusBadge').className = 'status-badge vod';

                        // EXTREME INITIAL SETUP: Synchronized Pre-warm
                        // Use proxy to bypass CORS restrictions from CDN
                        const finalUrl = proxyUrl(videoUrl);

                        // Step 1: establish connection and warm up CDN cache (first 512KB)
                        try {
                            const warmRes = await fetch(finalUrl, {
                                headers: { 'Range': 'bytes=0-524288' },
                                priority: 'high'
                            });
                            if (warmRes.ok) console.log('FullXCinema Pre-warm success');
                        } catch (e) { }

                        // Step 2: Handover to video element via proxy
                        vid.src = finalUrl;
                        vid.load();
                        box.classList.remove('loading');

                        vid.onerror = () => {
                            showErrorMessage('Video stream error. Retrying via proxy...');
                            vid.load();
                            vid.play().catch(() => { });
                        };

                        vid.play().catch((err) => {
                            console.error('Playback error:', err);
                            // Ensure we stay on proxy
                            vid.load();
                            vid.play().catch(() => { });
                        });
                        return;
                    } else {
                        throw new Error('No video URL found in proxy extraction');
                    }
                } catch (e) {
                    attempts++;
                    console.error(`Extraction attempt ${attempts} failed:`, e);
                    if (attempts < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, 1500));
                    } else {
                        box.classList.remove('active', 'loading');
                        showErrorMessage('Failed to extract video. Opening webpage instead...');
                        setTimeout(() => openWebpage(c.n, c.u), 1500);
                    }
                }
            }
        }

        // Error message display
        function showErrorMessage(msg) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(239,68,68,0.95);color:#fff;padding:16px 24px;border-radius:12px;z-index:9999;font-size:14px;font-weight:600;box-shadow:0 4px 20px rgba(0,0,0,0.3);max-width:90%;text-align:center;';
            errorDiv.textContent = msg;
            document.body.appendChild(errorDiv);
            setTimeout(() => {
                errorDiv.style.transition = 'opacity 0.3s';
                errorDiv.style.opacity = '0';
                setTimeout(() => errorDiv.remove(), 300);
            }, 4000);
        }

        // Setup quality selector for HLS
        function setupQualitySelector() {
            const qualSel = document.getElementById('qualitySelector');
            if (!hls || !hls.levels || hls.levels.length <= 1) {
                qualSel.style.display = 'none';
                return;
            }

            qualSel.style.display = 'block';
            qualSel.innerHTML = '<option value="-1">Auto</option>' +
                hls.levels.map((level, i) => {
                    const h = level.height || 'Unknown';
                    const b = level.bitrate ? Math.round(level.bitrate / 1000) : '';
                    return `<option value="${i}">${h}p${b ? ' (' + b + 'k)' : ''}</option>`;
                }).join('');

            qualSel.value = hls.currentLevel;
            qualSel.onchange = function () {
                hls.currentLevel = parseInt(this.value);
                if (parseInt(this.value) >= 0) {
                    const h = hls.levels[this.value].height;
                    document.getElementById('qualityBadge').textContent = h + 'p';
                } else {
                    document.getElementById('qualityBadge').textContent = 'Auto';
                }
            };
        }

        function showError(msg) {
            vid.poster = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"/>';
        }

        function stopHls() {
            try {
                if (hls) {
                    hls.detachMedia();
                    hls.destroy();
                    hls = null;
                }
                if (tsPlayer) {
                    tsPlayer.pause();
                    tsPlayer.unload();
                    tsPlayer.detachMedia();
                    tsPlayer.destroy();
                    tsPlayer = null;
                }
                if (vid) {
                    vid.pause();
                    vid.removeAttribute('src');
                    vid.load();
                }
            } catch (e) {
                console.error('Error stopping HLS/TS:', e);
                hls = null;
                tsPlayer = null;
            }
        }

        function stopPlayer() {
            try {
                stopHls();
                const iframe = document.getElementById('iframePlayer');
                if (iframe) {
                    iframe.src = '';
                    iframe.style.display = 'none';
                }
                if (vid) {
                    vid.style.display = 'block';
                }
                document.getElementById('controls').style.display = 'block';
                document.getElementById('playerBox').classList.remove('active', 'loading', 'buffering');
                document.getElementById('qualitySelector').style.display = 'none';
            } catch (e) {
                console.error('Error stopping player:', e);
            }
        }

        function resetControls() {
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('bufferBar').style.width = '0%';
            document.getElementById('progressHandle').style.left = '0%';
            document.getElementById('curTime').textContent = '0:00';
            document.getElementById('durTime').textContent = '0:00';
            document.getElementById('qualityBadge').textContent = '-';
        }

        // Video Events
        vid.onloadedmetadata = () => {
            document.getElementById('playerBox').classList.remove('loading');
            if (!isLive && vid.duration && isFinite(vid.duration)) {
                document.getElementById('durTime').textContent = fmt(vid.duration);
                document.getElementById('statusBadge').textContent = 'VOD';
                document.getElementById('statusBadge').className = 'status-badge vod';
            }
        };
        vid.onwaiting = () => document.getElementById('playerBox').classList.add('buffering');
        vid.onplaying = () => {
            document.getElementById('playerBox').classList.remove('loading', 'buffering');
            document.getElementById('playBtn').textContent = '‚è∏';
        };
        vid.onpause = () => document.getElementById('playBtn').textContent = '‚ñ∂';
        vid.ontimeupdate = () => {
            if (!vid.duration || !isFinite(vid.duration)) return;
            const pct = (vid.currentTime / vid.duration) * 100;
            document.getElementById('progressFill').style.width = pct + '%';
            document.getElementById('progressHandle').style.left = pct + '%';
            document.getElementById('curTime').textContent = fmt(vid.currentTime);

            // Background store position for "starting" resume
            if (vid.currentTime > 5) {
                localStorage.setItem('pos_' + btoa(vid.src), vid.currentTime);
            }
        };
        vid.onprogress = () => {
            if (vid.buffered.length > 0 && vid.duration) {
                const buf = (vid.buffered.end(vid.buffered.length - 1) / vid.duration) * 100;
                document.getElementById('bufferBar').style.width = buf + '%';
            }
        };
        vid.onvolumechange = () => {
            document.getElementById('muteBtn').textContent = vid.muted || vid.volume === 0 ? 'üîá' : 'üîä';
            document.getElementById('volSlider').value = vid.muted ? 0 : vid.volume;
        };

        // Controls
        function togglePlay() { vid.paused ? vid.play() : vid.pause(); }
        function skip(s) { if (vid.duration && isFinite(vid.duration)) vid.currentTime = Math.max(0, Math.min(vid.duration, vid.currentTime + s)); }
        function toggleMute() { vid.muted = !vid.muted; }
        document.getElementById('volSlider').oninput = function () { vid.volume = this.value; vid.muted = false; };
        document.getElementById('speedSelector').onchange = function () { vid.playbackRate = parseFloat(this.value); };
        function toggleFullscreen() {
            const wrap = document.getElementById('playerWrap');
            if (document.fullscreenElement) document.exitFullscreen();
            else wrap.requestFullscreen();
        }

        // Aspect Ratio
        const aspects = ['contain', 'cover', 'fill', 'none'];
        let aspectIdx = 0;
        function toggleAspect() {
            aspectIdx = (aspectIdx + 1) % aspects.length;
            vid.style.objectFit = aspects[aspectIdx];
            const labels = { 'contain': '‚¨ú', 'cover': 'üìê', 'fill': '‚¨õ', 'none': 'üî≤' };
            document.getElementById('aspectBtn').textContent = labels[aspects[aspectIdx]];
        }

        // Rotation with Smart Scaling to prevent cropping
        let rotation = 0;
        function toggleRotate() {
            rotation = (rotation + 90) % 360;
            const wrap = document.getElementById('playerWrap');
            const rect = wrap.getBoundingClientRect();
            const w = rect.width;
            const h = rect.height;

            if (rotation === 90 || rotation === 270) {
                // Calculate scale to fit rotated video into container
                const scale = Math.min(w / h, h / w);
                vid.style.transform = `rotate(${rotation}deg) scale(${scale})`;
                // Remove fixed width/height to let scale handle it properly
                vid.style.width = '100%';
                vid.style.height = '100%';
            } else {
                vid.style.transform = `rotate(${rotation}deg) scale(1)`;
                vid.style.width = '100%';
                vid.style.height = '100%';
            }
        }

        // Seekbar
        document.getElementById('progressWrap').onclick = function (e) {
            if (!vid.duration || !isFinite(vid.duration) || isLive) return;
            const rect = this.getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            vid.currentTime = pct * vid.duration;
        };

        function fmt(s) {
            if (!s || !isFinite(s)) return '0:00';
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = Math.floor(s % 60);
            if (h > 0) return h + ':' + (m < 10 ? '0' : '') + m + ':' + (sec < 10 ? '0' : '') + sec;
            return m + ':' + (sec < 10 ? '0' : '') + sec;
        }

        // Webpage Loading
        let currentWebpageUrl = '';
        const webpageHistory = [];

        function toggleWebpageDebug() {
            const el = document.getElementById('webpageConsole');
            const btn = document.getElementById('webpageDebugBtn');
            el.classList.toggle('active');
            btn.classList.toggle('active');
        }

        function webpageLog(msg, type = 'info') {
            const consoleEl = document.getElementById('webpageConsole');
            const div = document.createElement('div');
            div.className = 'log-entry' + (type !== 'info' ? ' log-' + type : '');
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            consoleEl.appendChild(div);
            consoleEl.scrollTop = consoleEl.scrollHeight;
            if (consoleEl.childNodes.length > 50) consoleEl.removeChild(consoleEl.firstChild);
        }

        async function openWebpage(title, url, pushState = true) {
            const box = document.getElementById('webpageBox');
            const content = document.getElementById('webpageContent');
            const consoleEl = document.getElementById('webpageConsole');
            consoleEl.innerHTML = ''; // Clear console for new page
            webpageLog(`Loading: ${url}`);

            if (pushState && currentWebpageUrl && currentWebpageUrl !== url) {
                webpageHistory.push(currentWebpageUrl);
            }
            currentWebpageUrl = url;

            const backBtn = document.getElementById('webpageBackBtn');
            if (backBtn) backBtn.style.display = webpageHistory.length > 0 ? 'block' : 'none';

            document.getElementById('webpageTitle').textContent = title;
            content.innerHTML = '<div style="text-align:center;padding:100px 0;"><div class="spin"></div><p style="color:var(--text2);margin-top:20px;font-size:16px;">Connecting via Extreme Tunnel...</p></div>';
            box.classList.add('active');

            try {
                const proxied = proxyUrl(url);
                const res = await fetch(proxied);
                if (res.ok) {
                    const status = res.headers.get('X-Status');
                    let html = await res.text();
                    content.innerHTML = html;

                    // Inject logging bridge
                    const bridge = document.createElement('script');
                    bridge.textContent = `
                        (function() {
                            const oL = console.log, oE = console.error, oW = console.warn;
                            console.log = (...a) => { oL(...a); window.parent.postMessage({type:'log', msg:a.join(' ')}, '*'); };
                            console.error = (...a) => { oE(...a); window.parent.postMessage({type:'error', msg:a.join(' ')}, '*'); };
                            console.warn = (...a) => { oW(...a); window.parent.postMessage({type:'warn', msg:a.join(' ')}, '*'); };
                            window.onerror = (m,s,l,c,e) => { window.parent.postMessage({type:'error', msg:m}, '*'); };
                        })();
                    `;
                    content.prepend(bridge);

                    executeScripts(content);
                    interceptClicks(content, url);
                    webpageLog(`Page segments loaded. Status: ${status || 'OK'}`);
                    if (status && status !== '200') webpageLog(`Warning: Target returned ${status}`, 'warn');
                } else {
                    webpageLog(`Failed to load: ${res.status}`, 'error');
                    content.innerHTML = `<div style="text-align:center;padding:60px;color:var(--text2);"><h3>Failed to connect</h3><p>HTTP ${res.status}</p></div>`;
                }
            } catch (e) {
                webpageLog(`Error: ${e.message}`, 'error');
                content.innerHTML = '<div style="text-align:center;padding:60px;color:var(--text2);"><h3>Connection Blocked</h3><p>The site may be preventing proxy access.</p></div>';
            }
        }

        // Handle messages from proxied content
        window.addEventListener('message', (e) => {
            if (e.data && (e.data.type === 'log' || e.data.type === 'error' || e.data.type === 'warn')) {
                webpageLog(e.data.msg, e.data.type === 'log' ? 'info' : e.data.type);
            }
        });

        function webpageBack() {
            if (webpageHistory.length > 0) {
                const url = webpageHistory.pop();
                openWebpage('Back', url, false);
            }
        }

        function webpageRefresh() {
            if (currentWebpageUrl) openWebpage(document.getElementById('webpageTitle').textContent, currentWebpageUrl, false);
        }

        function unproxy(u) {
            if (!u || typeof u !== 'string') return u;
            if (u.includes('/api/proxy?url=')) {
                let part = u.split('/api/proxy?url=')[1] || '';
                const ampIdx = part.indexOf('&ua=');
                if (ampIdx !== -1) part = part.substring(0, ampIdx);
                return decodeURIComponent(part);
            }
            return u;
        }

        async function executeScripts(container) {
            const scripts = Array.from(container.querySelectorAll('script'));
            for (const oldScript of scripts) {
                await new Promise((resolve) => {
                    const newScript = document.createElement('script');
                    Array.from(oldScript.attributes).forEach(attr => {
                        newScript.setAttribute(attr.name, attr.value);
                    });

                    if (oldScript.src) {
                        newScript.onload = () => {
                            webpageLog(`Loaded: ${newScript.src.split('url=')[1]?.substring(0, 30) || 'ext'}`);
                            resolve();
                        };
                        newScript.onerror = () => {
                            webpageLog(`Failed: ${newScript.src.substring(0, 50)}`, 'error');
                            resolve();
                        };
                        newScript.src = oldScript.src;
                    } else {
                        newScript.textContent = oldScript.textContent;
                        setTimeout(resolve, 5);
                    }

                    if (oldScript.parentNode) {
                        oldScript.parentNode.replaceChild(newScript, oldScript);
                    } else {
                        resolve();
                    }
                });
            }
        }

        function interceptClicks(container, baseUrl) {
            const base = new URL(baseUrl);
            container.addEventListener('click', function (e) {
                const link = e.target.closest('a');
                if (link) {
                    let rawHref = link.getAttribute('href');
                    if (!rawHref || rawHref.startsWith('#') || rawHref.startsWith('javascript:')) return;

                    e.preventDefault();
                    e.stopPropagation();

                    // Resolve against base
                    let href = unproxy(rawHref);
                    let fullUrl;
                    try {
                        fullUrl = new URL(href, baseUrl).href;
                    } catch (err) {
                        if (href.startsWith('//')) fullUrl = 'https:' + href;
                        else if (href.startsWith('/')) fullUrl = base.origin + href;
                        else fullUrl = href.includes('://') ? href : (baseUrl.substring(0, baseUrl.lastIndexOf('/') + 1) + href);
                    }

                    // Check if it's a video file
                    const isVideo = /\.(mp4|m3u8|ts|mkv|webm|mpd|m3u|mov|avi|flv)($|\?)/i.test(fullUrl);
                    const isExtractionsite = fullUrl.includes('noodlemagazine.com/watch/') || fullUrl.includes('xhamster.desi/videos/') || (fullUrl.includes('eroticmv.com/') && !fullUrl.match(/\.(com|com\/)$/) && !fullUrl.includes('/categories/'));

                    if (isVideo) {
                        closeWebpage();
                        playUrl(fullUrl, link.textContent.trim() || 'Video');
                    } else if (isExtractionsite) {
                        closeWebpage();
                        extractAndPlay(fullUrl, link.textContent.trim() || 'Video');
                    } else {
                        openWebpage(link.textContent.trim() || 'Page', fullUrl);
                    }
                }

                // Handle video elements
                const video = e.target.closest('video');
                if (video && video.src) {
                    e.preventDefault();
                    closeWebpage();
                    playUrl(video.src, 'Video');
                }
            }, true);

            // Also intercept form submissions
            container.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', e => e.preventDefault());
            });
        }

        function playUrl(url, name) {
            const box = document.getElementById('playerBox');
            document.getElementById('nowTitle').textContent = name;
            document.getElementById('nowGroup').textContent = 'External';
            document.getElementById('nowImg').src = '';
            box.classList.add('active', 'loading');
            box.scrollIntoView({ behavior: 'smooth' });
            stopHls();
            resetControls();

            vid.style.display = 'block';
            document.getElementById('iframePlayer').style.display = 'none';
            document.getElementById('controls').style.display = 'block';

            const proxiedUrl = proxyUrl(url);
            const isHls = url.toLowerCase().includes('.m3u8');

            if (isHls && Hls.isSupported()) {
                hls = new Hls({ enableWorker: true });
                hls.loadSource(proxiedUrl);
                hls.attachMedia(vid);
                hls.on(Hls.Events.MANIFEST_PARSED, () => { box.classList.remove('loading'); vid.play(); });
                hls.on(Hls.Events.ERROR, () => box.classList.remove('loading'));
            } else {
                vid.src = proxiedUrl;
                vid.load();
                vid.play().catch(() => { });
            }
            vid.onplaying = () => box.classList.remove('loading', 'buffering');
            vid.onwaiting = () => box.classList.add('buffering');
        }

        async function extractAndPlay(url, name) {
            const box = document.getElementById('playerBox');
            document.getElementById('nowTitle').textContent = name;
            document.getElementById('nowGroup').textContent = 'Extracting...';
            document.getElementById('nowImg').src = '';
            box.classList.add('active', 'loading');
            box.scrollIntoView({ behavior: 'smooth' });
            stopHls();
            resetControls();

            try {
                const extractUrl = '/api/proxy?extract=true&url=' + encodeURIComponent(url);
                const res = await fetch(extractUrl);
                const data = await res.json();
                if (data.video) {
                    document.getElementById('nowGroup').textContent = 'External';
                    const proxiedUrl = proxyUrl(data.video);
                    vid.style.display = 'block';
                    document.getElementById('iframePlayer').style.display = 'none';
                    document.getElementById('controls').style.display = 'block';
                    document.getElementById('statusBadge').textContent = 'VOD';
                    document.getElementById('statusBadge').className = 'status-badge vod';
                    vid.src = proxiedUrl;
                    vid.load();
                    vid.play().catch(() => { });
                    vid.onplaying = () => box.classList.remove('loading', 'buffering');
                    vid.onwaiting = () => box.classList.add('buffering');
                } else {
                    box.classList.remove('active', 'loading');
                    openWebpage(name, url);
                }
            } catch (e) {
                box.classList.remove('active', 'loading');
                openWebpage(name, url);
            }
        }

        function closeWebpage() {
            document.getElementById('webpageBox').classList.remove('active');
            document.getElementById('webpageContent').innerHTML = '';
            currentWebpageUrl = '';
        }

        // Keyboard
        document.onkeydown = e => {
            if (e.key === 'Backspace' || e.key === 'Escape') {
                if (document.getElementById('webpageBox').classList.contains('active')) {
                    e.preventDefault();
                    closeWebpage();
                    return;
                }
                if (document.getElementById('playerBox').classList.contains('active')) {
                    e.preventDefault();
                    stopPlayer();
                    return;
                }
            }
            if (!document.getElementById('playerBox').classList.contains('active')) return;
            if (e.key === ' ') { e.preventDefault(); togglePlay(); }
            if (e.key === 'ArrowLeft') { e.preventDefault(); skip(-10); }
            if (e.key === 'ArrowRight') { e.preventDefault(); skip(10); }
            if (e.key === 'ArrowUp') { e.preventDefault(); playPreviousVideo(); }
            if (e.key === 'ArrowDown') { e.preventDefault(); playNextVideo(); }
            if (e.key === 'f') toggleFullscreen();
            if (e.key === 'm') toggleMute();
            if (e.key === 'n' || e.key === 'N') playNextVideo();
            if (e.key === 'p' || e.key === 'P') playPreviousVideo();
        };

        // Video Navigation Functions
        // Multi-Background Buffering: Prefetch next video
        let prefetchHls = null;
        function prefetchNextVideo(index) {
            if (index < 0 || index >= F.length) return;
            const next = F[index];
            if (!next || !next.u) return;

            // Only prefetch HLS streams for now
            const isHls = next.u.toLowerCase().includes('.m3u') || next.u.toLowerCase().includes('.m3u8');
            if (!isHls) return;

            if (prefetchHls) {
                prefetchHls.destroy();
                prefetchHls = null;
            }

            console.log('Multi-buffering next item in background:', next.n);
            prefetchHls = new Hls({
                xhrSetup: (xhr) => { xhr.withCredentials = false; },
                enableWorker: true,
                maxBufferLength: 10, // Small buffer size for prefetch
                autoStartLoad: true,
                startFragPrefetch: true
            });
            const proxiedNext = proxyUrl(next.u);
            prefetchHls.loadSource(proxiedNext);
            // We don't attach to media yet, just warm up the manifest and first fragments
        }

        function playNextVideo() {
            if (currentVideoIndex >= 0 && currentVideoIndex < F.length - 1) {
                play(currentVideoIndex + 1);
                scrollToCurrentCard();
            }
        }

        function playPreviousVideo() {
            if (currentVideoIndex > 0) {
                play(currentVideoIndex - 1);
                scrollToCurrentCard();
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevVideoBtn');
            const nextBtn = document.getElementById('nextVideoBtn');

            if (prevBtn) prevBtn.disabled = currentVideoIndex <= 0;
            if (nextBtn) nextBtn.disabled = currentVideoIndex >= F.length - 1;
        }

        function scrollToCurrentCard() {
            setTimeout(() => {
                const currentCard = document.querySelector(`.card[data-i="${currentVideoIndex}"]`);
                if (currentCard) {
                    currentCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 300);
        }

        // Video buffering indicators
        vid.addEventListener('waiting', () => showBuffering());
        vid.addEventListener('playing', () => hideBuffering());
        vid.addEventListener('canplay', () => hideBuffering());
        vid.addEventListener('loadstart', () => showBuffering());

        // Auto-play next video when current ends
        vid.onended = () => {
            hideBuffering();
            if (currentVideoIndex >= 0 && currentVideoIndex < F.length - 1) {
                setTimeout(() => playNextVideo(), 1000);
            }
        };

        // ===== MANUAL URL FIX LOGIC =====
        function openFixUrlModal() {
            const modal = document.getElementById('fixUrlModal');
            const input = document.getElementById('fixUrlInput');
            const fixBtn = document.getElementById('fixUrlBtn');

            if (fixBtn && fixBtn.dataset.currentUrl) {
                // Use the currently playing URL (or what we attempted to play)
                // If we have a full URL in the player src (from fallback), show that? 
                // Or show the relative URL from DB?
                // The user probably wants to see the full URL they can edit.
                // Let's deduce: if currentUrl starts with http, use it. Else prepend base.
                let url = fixBtn.dataset.currentUrl;
                if (!url.startsWith('http')) {
                    url = 'https://cdn.xnxxvideos.in' + url;
                }
                input.value = url;
            }
            modal.classList.add('show');
        }

        function closeFixUrlModal() {
            document.getElementById('fixUrlModal').classList.remove('show');
        }

        async function testFixUrl() {
            const input = document.getElementById('fixUrlInput');
            const newUrl = input.value.trim();
            const fixBtn = document.getElementById('fixUrlBtn');
            const vidId = fixBtn.dataset.vidId;

            if (!newUrl) return;

            // Test play directly
            const vid = document.getElementById('vid');
            vid.src = newUrl;
            vid.load();

            // Temporary listener for this test
            const onPlaySuccess = () => {
                console.log('Fix URL success! Saving...');
                saveFixUrl(vidId, newUrl);
                vid.removeEventListener('loadeddata', onPlaySuccess);
                vid.removeEventListener('error', onPlayError);
                closeFixUrlModal();
                showErrorMessage('URL Fixed & Saved! Enjoy.');
            };

            const onPlayError = (e) => {
                console.error('Fix URL failed:', e);
                alert('Stream failed to play. Check the URL.');
                vid.removeEventListener('loadeddata', onPlaySuccess);
                vid.removeEventListener('error', onPlayError);
            };

            vid.addEventListener('loadeddata', onPlaySuccess);
            vid.addEventListener('error', onPlayError);

            vid.play().catch(e => console.log('Autoplay blocked or waiting', e));
        }

        async function saveFixUrl(id, url) {
            if (!id) return;

            // Deduce image path from URL (User requirement: fix img as well)
            // URL: https://cdn.xnxxvideos.in/2026/01/Name...mp4
            // Img: /2026/01/Name...jpg (we store relative or full? DB has relative usually, causing issues if not careful)
            // But let's just store what works. 
            // If the user submits a full URL, we can store the full URL or try to allow relative.
            // The user Request said: "fix the url in db for stream_url and the img"
            // "suppose 2026/01/Hot...mp4 -> 2026/01/Hot... (img)"

            let imgUrl = '';
            try {
                // Try to replace extension
                if (url.includes('.mp4')) {
                    imgUrl = url.replace('.mp4', '.jpg');
                } else if (url.includes('.m3u8')) {
                    imgUrl = url.replace('.m3u8', '.jpg');
                }

                // If it's a full URL, we might want to make it relative if we want to stick to the pattern, 
                // OR just save the full URL. The app handles full URLs (startsWith http check).
                // Let's save the FULL URL for safety as it's a manual fix.

            } catch (e) { console.error('Img deduction error', e); }

            // Call API
            try {
                await fetch('/api/update_xnxx', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, stream_url: url, img: imgUrl })
                });
                console.log('DB Updated');
            } catch (e) {
                console.error('Failed to update DB', e);
            }
        }
    </script>
    <script>
        // Ensure a global proxyUrl helper exists for legacy call sites.
        if (typeof window.proxyUrl === 'undefined') {
            window.proxyUrl = function (url, opts) {
                if (!url) return '';
                let out = '/api/proxy?url=' + encodeURIComponent(url);
                const ua = (opts && opts.ua) || window.__proxyUA || '';
                const cookie = (opts && opts.cookie) || window.__proxyCookie || '';
                if (ua) out += '&ua=' + encodeURIComponent(ua);
                if (cookie) out += '&cookie=' + encodeURIComponent(cookie);
                return out;
            };
        }
    </script>
    <script>
        function openPlayStreamModal() {
            document.getElementById('playStreamModal').style.display = 'flex';
            document.getElementById('streamUrlInput').focus();
        }
        function closePlayStreamModal() {
            document.getElementById('playStreamModal').style.display = 'none';
        }

        async function submitPlayStream() {
            const url = document.getElementById('streamUrlInput').value.trim();
            const name = document.getElementById('streamNameInput').value.trim() || 'User Stream';
            const ua = document.getElementById('streamUaInput').value.trim();
            const drmType = document.getElementById('streamDrmType').value;
            const drmLicense = document.getElementById('streamDrmLicense').value.trim();
            const drmKey = document.getElementById('streamDrmKey').value.trim();
            if (!url) return alert('Please paste a stream URL');
            closePlayStreamModal();
            // If MPD and DRM provided, use Shaka
            const lower = url.toLowerCase();
            if (lower.includes('.mpd') && drmType && (shaka && shaka.Player)) {
                try {
                    if (!shakaPlayer) await initShakaPlayer();
                    shakaCurrentChannel = { name, url, ua };
                    // configure DRM
                    const drmCfg = { drm: {} };
                    if (drmType === 'clearkey' && drmKey) {
                        const parts = drmKey.split(':');
                        const kid = parts[0];
                        const key = parts[1] || parts[0];
                        drmCfg.drm.clearKeys = { [kid]: key };
                    } else if ((drmType === 'com.widevine.alpha' || drmType === 'com.microsoft.playready') && drmLicense) {
                        drmCfg.drm.servers = { [drmType]: drmLicense };
                    }
                    shakaPlayer.configure(drmCfg);
                    // Use proxy for manifest if UA provided (shaka request filter will proxy when ua set)
                    shakaCurrentChannel.useProxy = !!ua;
                    shakaCurrentChannel.ua = ua;
                    // set globals for proxy helper
                    window.__proxyUA = ua || window.__proxyUA || '';
                    // if URL contains cookie param, extract it
                    try { window.__proxyCookie = (new URL(url)).searchParams.get('cookie') || window.__proxyCookie || ''; } catch (e) { }
                    // Load via shaka
                    await playJioTVChannel(shakaCurrentChannel);
                    return;
                } catch (e) {
                    console.error('Shaka play error:', e);
                    alert('Failed to play MPD via Shaka: ' + e.message);
                    return;
                }
            }

            // For HLS or MP4, call playUrl but include UA by using proxy when UA specified
            let finalUrl = url;
            if (ua || lower.includes('.m3u8')) {
                window.__proxyUA = ua || window.__proxyUA || '';
                finalUrl = proxyUrl(url);
            }
            playUrl(finalUrl, name);
        }








        if (!window.requestAnimationFrame) {
            window.requestAnimationFrame = function (cb) {
                return setTimeout(cb, 16);
            };
        }

        if (!Array.prototype.find) {
            Array.prototype.find = function (fn) {
                for (var i = 0; i < this.length; i++) {
                    if (fn(this[i], i, this)) return this[i];
                }
            };
        }

        if (typeof Object.assign !== 'function') {
            Object.assign = function (target) {
                if (target == null) throw new TypeError();
                target = Object(target);
                for (var i = 1; i < arguments.length; i++) {
                    var src = arguments[i];
                    if (src != null) {
                        for (var key in src) {
                            if (Object.prototype.hasOwnProperty.call(src, key)) {
                                target[key] = src[key];
                            }
                        }
                    }
                }
                return target;
            };
        }


    </script>

</body>

</html>
