<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Parental Controls (Local Only)</title>
  <style>
    :root {
      --bg: #f4f1e8;
      --panel: #ffffff;
      --ink: #1e1a14;
      --muted: #7a6f61;
      --accent: #d77a1f;
      --accent-dark: #b86416;
      --danger: #c0392b;
      --ok: #2e7d32;
      --shadow: 0 14px 40px rgba(30, 26, 20, 0.12);
      --radius: 16px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Georgia", "Times New Roman", serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 20% 20%, rgba(215, 122, 31, 0.15), transparent 50%),
        radial-gradient(circle at 80% 0%, rgba(46, 125, 50, 0.12), transparent 40%),
        var(--bg);
      min-height: 100vh;
    }

    header {
      padding: 28px 20px 10px;
      text-align: center;
    }

    header h1 {
      margin: 0 0 6px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    header p {
      margin: 0;
      color: var(--muted);
    }

    main {
      max-width: 980px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .card {
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      position: relative;
      overflow: hidden;
    }

    .card h2 {
      margin: 0 0 12px;
      font-size: 1.2rem;
    }

    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px dashed #e5dfd2;
    }

    .row:last-child {
      border-bottom: 0;
    }

    .label {
      font-weight: 600;
    }

    .muted {
      color: var(--muted);
      font-size: 0.92rem;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 52px;
      height: 28px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccbfae;
      transition: 0.2s;
      border-radius: 999px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      top: 3px;
      background-color: #fff;
      transition: 0.2s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--accent);
    }

    input:checked + .slider:before {
      transform: translateX(24px);
    }

    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: #f1e6d2;
      color: #6b4f2c;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
    }

    .btn:hover {
      background: var(--accent-dark);
    }

    .btn.secondary {
      background: #ddd2c2;
      color: #423526;
    }

    .btn.danger {
      background: var(--danger);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d8cbb8;
      font-family: inherit;
      font-size: 0.95rem;
    }

    .select {
      width: 160px;
    }

    .range {
      width: 160px;
    }

    .link-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.92rem;
    }

    .link-row a {
      color: #6a4c22;
      font-weight: 600;
      text-decoration: none;
      border-bottom: 1px solid rgba(106, 76, 34, 0.4);
    }

    .link-row a:hover {
      color: var(--accent-dark);
      border-bottom-color: var(--accent-dark);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .notice {
      background: #fff4de;
      border-left: 4px solid var(--accent);
      padding: 10px 12px;
      border-radius: 8px;
      color: #6a4c22;
      font-size: 0.9rem;
      margin-top: 10px;
    }

    .lock-overlay {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.88);
      backdrop-filter: blur(2px);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
      font-weight: 600;
    }

    .hidden {
      display: none;
    }

    .log {
      max-height: 220px;
      overflow: auto;
      padding: 8px 0 0;
      font-size: 0.92rem;
    }

    .log div {
      padding: 6px 0;
      border-bottom: 1px dashed #e5dfd2;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--ok);
    }

    .status.off {
      color: var(--danger);
    }

    .media-preview {
      width: 100%;
      border-radius: 12px;
      background: #f3ebdd;
      aspect-ratio: 16 / 9;
      object-fit: cover;
      border: 1px solid #e5dfd2;
    }

    .meter {
      height: 10px;
      border-radius: 999px;
      background: #efe7d8;
      overflow: hidden;
      border: 1px solid #e2d7c5;
    }

    .meter span {
      display: block;
      height: 100%;
      width: 0%;
      background: var(--ok);
      transition: width 0.1s linear;
    }

    .consent-banner {
      max-width: 980px;
      margin: 16px auto 0;
      background: #fff4de;
      border: 1px solid #ead8b8;
      border-left: 4px solid var(--accent);
      border-radius: 12px;
      padding: 12px 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow);
    }

    .consent-banner .text {
      color: #6a4c22;
      font-size: 0.92rem;
      max-width: 700px;
    }

    .live-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      font-size: 0.9rem;
      color: var(--danger);
    }

    .live-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--danger);
      box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.6);
      animation: pulse 1.6s infinite;
    }

    .live-indicator.off {
      color: var(--muted);
    }

    .live-indicator.off .live-dot {
      background: #bfb3a2;
      box-shadow: none;
      animation: none;
    }

    .copy-status {
      font-size: 0.85rem;
      color: var(--muted);
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.5); }
      70% { box-shadow: 0 0 0 10px rgba(192, 57, 43, 0); }
      100% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0); }
    }

    footer {
      text-align: center;
      padding: 16px 20px 28px;
      color: var(--muted);
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>Family Shield Console</h1>
    <p>Local-only parental controls interface (no server, no system access).</p>
  </header>

  <div class="consent-banner" id="alwaysBanner">
    <div class="text">
      Notice: This device is under parental supervision. If monitoring features are enabled, the child will be informed.
    </div>
  </div>

  <div class="consent-banner hidden" id="activeBanner">
    <div class="text">
      Monitoring is ON now. Your parent or guardian can see the camera and microphone preview on this device.
    </div>
  </div>

  <div class="consent-banner" id="consentBanner">
    <div class="text">
      Consent required: Camera and microphone can only be used with clear, informed consent from the device user.
      This page never streams or uploads media.
    </div>
    <button class="btn" id="consentAccept">I Agree</button>
  </div>

  <main>
    <section class="card" id="overview-card">
      <h2>Overview</h2>
      <div class="row">
        <div>
          <div class="label">Protection Mode</div>
          <div class="muted">Toggle to simulate safe browsing.</div>
        </div>
        <label class="switch">
          <input type="checkbox" id="protectionToggle" />
          <span class="slider"></span>
        </label>
      </div>
      <div class="row">
        <div>
          <div class="label">Today's Time Limit</div>
          <div class="muted">Local timer (not enforced by OS).</div>
        </div>
        <span class="pill" id="timeLimitPill">2h 00m</span>
      </div>
      <div class="row">
        <div>
          <div class="label">Status</div>
          <div class="muted">This page cannot access system permissions.</div>
        </div>
        <div class="status" id="statusBadge">Active (Local Only)</div>
      </div>
      <div class="notice">
        This HTML page runs only in the browser. It cannot grant itself system permissions or access files, apps, or device settings.
      </div>
    </section>

    <section class="card" id="share-card">
      <h2>Share Links</h2>
      <div class="muted">Generate links for this page and for specific sections.</div>
      <div class="row">
        <button class="btn" id="copyPageLink">Copy Page Link</button>
        <span class="copy-status" id="pageLinkStatus"></span>
      </div>
      <div class="row">
        <button class="btn secondary" id="copyCameraLink">Copy Camera Link</button>
        <span class="copy-status" id="cameraLinkStatus"></span>
      </div>
      <div class="row">
        <button class="btn secondary" id="copyPermissionsLink">Copy Permissions Link</button>
        <span class="copy-status" id="permLinkStatus"></span>
      </div>
      <div class="row">
        <button class="btn secondary" id="copyLocationLink">Copy Location Link</button>
        <span class="copy-status" id="locLinkStatus"></span>
      </div>
      <div class="notice">
        Links only open this page. Camera, microphone, location, and notifications still require explicit on-device consent.
      </div>
    </section>

    <section class="card" id="categories-card">
      <h2>Content Categories</h2>
      <div class="row">
        <div>
          <div class="label">Adult Content</div>
          <div class="muted">Recommended to block</div>
        </div>
        <label class="switch">
          <input type="checkbox" data-category="adult" />
          <span class="slider"></span>
        </label>
      </div>
      <div class="row">
        <div>
          <div class="label">Social Media</div>
          <div class="muted">Limit during study hours</div>
        </div>
        <label class="switch">
          <input type="checkbox" data-category="social" />
          <span class="slider"></span>
        </label>
      </div>
      <div class="row">
        <div>
          <div class="label">Gaming</div>
          <div class="muted">Set a daily cap</div>
        </div>
        <label class="switch">
          <input type="checkbox" data-category="gaming" />
          <span class="slider"></span>
        </label>
      </div>
      <div class="row">
        <div>
          <div class="label">Streaming</div>
          <div class="muted">Allow on weekends</div>
        </div>
        <label class="switch">
          <input type="checkbox" data-category="streaming" />
          <span class="slider"></span>
        </label>
      </div>
    </section>

    <section class="card" id="schedule-card">
      <h2>Schedule</h2>
      <div class="grid-2">
        <div>
          <label class="label" for="startTime">Start</label>
          <input class="input" type="time" id="startTime" value="08:00" />
        </div>
        <div>
          <label class="label" for="endTime">End</label>
          <input class="input" type="time" id="endTime" value="20:00" />
        </div>
      </div>
      <div class="row">
        <div>
          <div class="label">Daily Limit</div>
          <div class="muted">Local timer</div>
        </div>
        <input class="input" type="number" id="dailyLimit" min="0" max="24" value="2" />
      </div>
      <div class="row">
        <button class="btn" id="saveSchedule">Save Schedule</button>
        <button class="btn secondary" id="resetSchedule">Reset</button>
      </div>
    </section>

    <section class="card" id="lock-card">
      <h2>Parent Lock</h2>
      <div class="muted">Set a PIN to lock settings locally.</div>
      <div class="row">
        <input class="input" type="password" id="pinInput" placeholder="Set / Enter PIN" />
      </div>
      <div class="row">
        <button class="btn" id="setPin">Set PIN</button>
        <button class="btn danger" id="lockNow">Lock</button>
      </div>
      <div class="row">
        <button class="btn secondary" id="unlock">Unlock</button>
        <button class="btn secondary" id="clearPin">Clear PIN</button>
      </div>
    </section>

    <section class="card" id="activity-card">
      <h2>Local Activity Log</h2>
      <div class="muted">Logs only actions made on this page.</div>
      <div class="log" id="log"></div>
      <div class="row">
        <button class="btn secondary" id="clearLog">Clear Log</button>
      </div>
    </section>

    <section class="card" id="permissions-card">
      <h2>Browser Permissions</h2>
      <div class="muted">One button requests all browser permissions at once (camera, mic, location, notifications).</div>
      <div class="row link-row">
        <a href="#permissions-card">Permissions</a>
        <a href="#preview-card">Camera/Mic Preview</a>
        <a href="#overview-card">Overview</a>
      </div>
      <div class="row">
        <button class="btn" id="requestAll">Request All Permissions</button>
      </div>
      <div class="row">
        <button class="btn secondary" id="stopMedia">Stop Camera/Mic</button>
      </div>
      <div class="notice">
        Permission prompts are managed by your browser. You can revoke them in browser settings at any time.
      </div>
    </section>

    <section class="card" id="preview-card">
      <div class="row">
        <h2>Live Preview (Local Only)</h2>
        <div class="live-indicator off" id="liveIndicator">
          <span class="live-dot"></span>
          <span id="liveText">Off</span>
        </div>
      </div>
      <div class="muted">This shows the camera and microphone from the device running this page, with consent.</div>
      <video class="media-preview" id="previewVideo" autoplay playsinline muted></video>
      <div class="row">
        <div class="label">Camera</div>
        <select class="input select" id="cameraFacing">
          <option value="user">Front Camera</option>
          <option value="environment">Back Camera</option>
        </select>
        <button class="btn secondary" id="switchCamera">Switch Camera</button>
      </div>
      <div class="row">
        <div class="label">Mic Level</div>
        <div class="meter"><span id="micMeter"></span></div>
      </div>
      <div class="row">
        <div class="label">Audio Monitor</div>
        <label class="switch">
          <input type="checkbox" id="monitorToggle" />
          <span class="slider"></span>
        </label>
      </div>
      <div class="row">
        <div class="label">Monitor Volume</div>
        <input class="range" type="range" id="monitorVolume" min="0" max="1" step="0.01" value="0.35" />
      </div>
      <div class="notice">
        Audio monitor plays the microphone locally on this device only. Keep volume low to avoid feedback.
      </div>
      <div class="notice">
        This is a local preview only. It does not stream to other devices or record audio or video.
      </div>
    </section>
  </main>

  <footer>
    Built as a local-only UI. For real device-level controls, use your OS or a dedicated parental control app.
  </footer>

  <script>
    const storageKey = "familyShieldSettings";

    const state = {
      protection: false,
      categories: {
        adult: true,
        social: false,
        gaming: false,
        streaming: true,
      },
      schedule: {
        start: "08:00",
        end: "20:00",
        dailyLimitHours: 2,
      },
      pinHash: null,
      locked: false,
      log: [],
      consentGiven: false,
      facingMode: "user",
    };

    const el = {
      protectionToggle: document.getElementById("protectionToggle"),
      timeLimitPill: document.getElementById("timeLimitPill"),
      statusBadge: document.getElementById("statusBadge"),
      categoryToggles: Array.from(document.querySelectorAll("input[data-category]")),
      startTime: document.getElementById("startTime"),
      endTime: document.getElementById("endTime"),
      dailyLimit: document.getElementById("dailyLimit"),
      saveSchedule: document.getElementById("saveSchedule"),
      resetSchedule: document.getElementById("resetSchedule"),
      pinInput: document.getElementById("pinInput"),
      setPin: document.getElementById("setPin"),
      lockNow: document.getElementById("lockNow"),
      unlock: document.getElementById("unlock"),
      clearPin: document.getElementById("clearPin"),
      clearLog: document.getElementById("clearLog"),
      log: document.getElementById("log"),
      cards: Array.from(document.querySelectorAll("main .card")),
      requestAll: document.getElementById("requestAll"),
      stopMedia: document.getElementById("stopMedia"),
      previewVideo: document.getElementById("previewVideo"),
      micMeter: document.getElementById("micMeter"),
      monitorToggle: document.getElementById("monitorToggle"),
      monitorVolume: document.getElementById("monitorVolume"),
      cameraFacing: document.getElementById("cameraFacing"),
      switchCamera: document.getElementById("switchCamera"),
      consentBanner: document.getElementById("consentBanner"),
      consentAccept: document.getElementById("consentAccept"),
      alwaysBanner: document.getElementById("alwaysBanner"),
      activeBanner: document.getElementById("activeBanner"),
      liveIndicator: document.getElementById("liveIndicator"),
      liveText: document.getElementById("liveText"),
      copyPageLink: document.getElementById("copyPageLink"),
      copyCameraLink: document.getElementById("copyCameraLink"),
      copyPermissionsLink: document.getElementById("copyPermissionsLink"),
      copyLocationLink: document.getElementById("copyLocationLink"),
      pageLinkStatus: document.getElementById("pageLinkStatus"),
      cameraLinkStatus: document.getElementById("cameraLinkStatus"),
      permLinkStatus: document.getElementById("permLinkStatus"),
      locLinkStatus: document.getElementById("locLinkStatus"),
    };

    function saveState() {
      localStorage.setItem(storageKey, JSON.stringify(state));
    }

    function loadState() {
      const stored = localStorage.getItem(storageKey);
      if (!stored) return;
      try {
        const parsed = JSON.parse(stored);
        Object.assign(state, parsed);
      } catch {
        // ignore corrupt storage
      }
    }

    function addLog(message) {
      const entry = {
        message,
        time: new Date().toLocaleString(),
      };
      state.log.unshift(entry);
      if (state.log.length > 50) state.log.pop();
      renderLog();
      saveState();
    }

    function renderLog() {
      el.log.innerHTML = "";
      if (state.log.length === 0) {
        el.log.innerHTML = "<div class=\"muted\">No activity yet.</div>";
        return;
      }
      state.log.forEach((item) => {
        const row = document.createElement("div");
        row.textContent = `${item.time} — ${item.message}`;
        el.log.appendChild(row);
      });
    }

    function setLockOverlay(locked) {
      state.locked = locked;
      el.cards.forEach((card) => {
        if (card.id === "lock-card") return;
        const existing = card.querySelector(".lock-overlay");
        if (locked) {
          if (!existing) {
            const overlay = document.createElement("div");
            overlay.className = "lock-overlay";
            overlay.textContent = "Locked — enter PIN to change settings.";
            card.appendChild(overlay);
          }
        } else if (existing) {
          existing.remove();
        }
      });
      saveState();
    }

    function updateUI() {
      el.protectionToggle.checked = state.protection;
      el.timeLimitPill.textContent = `${state.schedule.dailyLimitHours}h 00m`;
      el.statusBadge.textContent = state.protection ? "Active (Local Only)" : "Paused";
      el.statusBadge.className = state.protection ? "status" : "status off";

      el.categoryToggles.forEach((toggle) => {
        const key = toggle.getAttribute("data-category");
        toggle.checked = Boolean(state.categories[key]);
      });

      el.startTime.value = state.schedule.start;
      el.endTime.value = state.schedule.end;
      el.dailyLimit.value = state.schedule.dailyLimitHours;
      if (el.cameraFacing) {
        el.cameraFacing.value = state.facingMode || "user";
      }

      setLockOverlay(state.locked);
      renderLog();
      updateConsentUI();
    }

    function updateConsentUI() {
      const enabled = Boolean(state.consentGiven);
      if (el.consentBanner) {
        el.consentBanner.style.display = enabled ? "none" : "flex";
      }
      if (el.alwaysBanner) {
        el.alwaysBanner.style.display = "flex";
      }
      [
        el.requestAll,
        el.stopMedia,
        el.monitorToggle,
        el.switchCamera,
        el.cameraFacing,
      ].forEach((btn) => {
        if (btn) btn.disabled = !enabled;
      });
    }

    function setLiveIndicator(active) {
      if (!el.liveIndicator || !el.liveText) return;
      el.liveIndicator.className = active ? "live-indicator" : "live-indicator off";
      el.liveText.textContent = active ? "Live" : "Off";
      if (el.activeBanner) {
        el.activeBanner.className = active ? "consent-banner" : "consent-banner hidden";
      }
    }

    function simpleHash(text) {
      let hash = 0;
      for (let i = 0; i < text.length; i++) {
        hash = (hash << 5) - hash + text.charCodeAt(i);
        hash |= 0;
      }
      return hash.toString();
    }

    function showCopyStatus(elStatus, message) {
      if (!elStatus) return;
      elStatus.textContent = message;
      setTimeout(() => {
        elStatus.textContent = "";
      }, 3000);
    }

    async function copyText(text, elStatus) {
      try {
        await navigator.clipboard.writeText(text);
        showCopyStatus(elStatus, "Copied!");
      } catch {
        showCopyStatus(elStatus, "Copy failed");
      }
    }

    let mediaStream = null;
    let audioContext = null;
    let analyser = null;
    let meterTimer = null;
    let micSource = null;
    let monitorGain = null;
    let monitorConnected = false;

    async function requestMedia(constraints, label) {
      if (!state.consentGiven) {
        addLog("Consent required before requesting media");
        return null;
      }
      try {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        addLog(`${label} permission granted`);
        attachPreview(stream);
        setLiveIndicator(true);
        return stream;
      } catch {
        addLog(`${label} permission denied`);
        return null;
      }
    }

    function attachPreview(stream) {
      mediaStream = stream;
      if (el.previewVideo) {
        el.previewVideo.srcObject = stream;
      }
      if (stream.getAudioTracks().length > 0) {
        setupAudioNodes(stream);
        startMicMeterLoop();
      }
    }

    function setupAudioNodes(stream) {
      if (!window.AudioContext) return;
      if (!audioContext) {
        audioContext = new AudioContext();
      }
      if (micSource) {
        micSource.disconnect();
        micSource = null;
      }
      micSource = audioContext.createMediaStreamSource(stream);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 256;
      micSource.connect(analyser);
      if (el.monitorToggle && el.monitorToggle.checked) {
        enableMonitor();
      }
    }

    function startMicMeterLoop() {
      if (!analyser) return;
      const data = new Uint8Array(analyser.frequencyBinCount);

      if (meterTimer) cancelAnimationFrame(meterTimer);
      const tick = () => {
        analyser.getByteFrequencyData(data);
        const avg = data.reduce((sum, v) => sum + v, 0) / data.length;
        const percent = Math.min(100, Math.round((avg / 255) * 100));
        if (el.micMeter) {
          el.micMeter.style.width = `${percent}%`;
        }
        meterTimer = requestAnimationFrame(tick);
      };
      tick();
    }

    function enableMonitor() {
      if (!audioContext || !micSource) return;
      if (!monitorGain) {
        monitorGain = audioContext.createGain();
      }
      monitorGain.gain.value = Number(el.monitorVolume.value || 0.35);
      if (!monitorConnected) {
        monitorGain.connect(audioContext.destination);
        micSource.connect(monitorGain);
        monitorConnected = true;
      }
    }

    function disableMonitor() {
      if (monitorGain) {
        monitorGain.disconnect();
      }
      monitorConnected = false;
    }

    function stopPreview() {
      if (meterTimer) {
        cancelAnimationFrame(meterTimer);
        meterTimer = null;
      }
      if (analyser) {
        analyser.disconnect();
        analyser = null;
      }
      if (micSource) {
        micSource.disconnect();
        micSource = null;
      }
      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }
      if (el.micMeter) {
        el.micMeter.style.width = "0%";
      }
      if (el.previewVideo) {
        el.previewVideo.srcObject = null;
      }
      disableMonitor();
      setLiveIndicator(false);
    }

    async function requestAllPermissions() {
      if (!state.consentGiven) {
        addLog("Consent required before requesting permissions");
        return;
      }

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        addLog("Camera/Microphone API not supported by this browser");
      } else {
        await requestMedia({
          video: { facingMode: state.facingMode || "user" },
          audio: true,
        }, "Camera/Microphone");
      }

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          () => addLog("Location permission granted"),
          () => addLog("Location permission denied")
        );
      } else {
        addLog("Geolocation API not supported by this browser");
      }

      if ("Notification" in window) {
        try {
          const result = await Notification.requestPermission();
          addLog(`Notifications permission ${result}`);
        } catch {
          addLog("Notifications permission denied");
        }
      } else {
        addLog("Notifications API not supported by this browser");
      }
    }

    async function switchCamera() {
      if (!mediaStream) {
        addLog("No active camera to switch");
        return;
      }
      mediaStream.getTracks().forEach((track) => track.stop());
      mediaStream = null;
      stopPreview();
      await requestMedia({
        video: { facingMode: state.facingMode || "user" },
        audio: true,
      }, "Camera/Microphone");
    }

    el.protectionToggle.addEventListener("change", () => {
      state.protection = el.protectionToggle.checked;
      addLog(`Protection mode ${state.protection ? "enabled" : "disabled"}`);
      updateUI();
      saveState();
    });

    el.categoryToggles.forEach((toggle) => {
      toggle.addEventListener("change", () => {
        const key = toggle.getAttribute("data-category");
        state.categories[key] = toggle.checked;
        addLog(`Category ${key} ${toggle.checked ? "allowed" : "blocked"}`);
        saveState();
      });
    });

    el.saveSchedule.addEventListener("click", () => {
      state.schedule.start = el.startTime.value;
      state.schedule.end = el.endTime.value;
      state.schedule.dailyLimitHours = Number(el.dailyLimit.value || 0);
      addLog("Schedule saved");
      updateUI();
      saveState();
    });

    el.resetSchedule.addEventListener("click", () => {
      state.schedule = { start: "08:00", end: "20:00", dailyLimitHours: 2 };
      addLog("Schedule reset");
      updateUI();
      saveState();
    });

    el.setPin.addEventListener("click", () => {
      const pin = el.pinInput.value.trim();
      if (pin.length < 4) {
        addLog("PIN must be at least 4 digits");
        return;
      }
      state.pinHash = simpleHash(pin);
      addLog("PIN set");
      el.pinInput.value = "";
      saveState();
    });

    el.lockNow.addEventListener("click", () => {
      if (!state.pinHash) {
        addLog("Set a PIN before locking");
        return;
      }
      setLockOverlay(true);
      addLog("Settings locked");
    });

    el.unlock.addEventListener("click", () => {
      if (!state.pinHash) {
        addLog("No PIN set");
        return;
      }
      const pin = el.pinInput.value.trim();
      if (simpleHash(pin) === state.pinHash) {
        setLockOverlay(false);
        addLog("Settings unlocked");
        el.pinInput.value = "";
      } else {
        addLog("Incorrect PIN");
      }
    });

    el.clearPin.addEventListener("click", () => {
      state.pinHash = null;
      setLockOverlay(false);
      addLog("PIN cleared");
      saveState();
    });

    el.clearLog.addEventListener("click", () => {
      state.log = [];
      renderLog();
      saveState();
    });

    el.requestAll.addEventListener("click", () => {
      requestAllPermissions();
    });

    el.stopMedia.addEventListener("click", () => {
      if (!mediaStream) {
        addLog("No active camera or microphone stream");
        return;
      }
      mediaStream.getTracks().forEach((track) => track.stop());
      mediaStream = null;
      stopPreview();
      addLog("Camera and Microphone stopped");
    });

    el.monitorToggle.addEventListener("change", () => {
      const enabled = el.monitorToggle.checked;
      if (!enabled) {
        disableMonitor();
        addLog("Audio monitor disabled");
        return;
      }
      if (!mediaStream || mediaStream.getAudioTracks().length === 0) {
        addLog("No microphone available for audio monitor");
        el.monitorToggle.checked = false;
        return;
      }
      enableMonitor();
      addLog("Audio monitor enabled");
    });

    el.monitorVolume.addEventListener("input", () => {
      if (monitorGain) {
        monitorGain.gain.value = Number(el.monitorVolume.value || 0.35);
      }
    });

    el.cameraFacing.addEventListener("change", () => {
      state.facingMode = el.cameraFacing.value || "user";
      saveState();
    });

    el.switchCamera.addEventListener("click", () => {
      switchCamera();
    });

    el.copyPageLink.addEventListener("click", () => {
      copyText(window.location.href.split("#")[0], el.pageLinkStatus);
    });

    el.copyCameraLink.addEventListener("click", () => {
      copyText(`${window.location.href.split("#")[0]}#preview-card`, el.cameraLinkStatus);
    });

    el.copyPermissionsLink.addEventListener("click", () => {
      copyText(`${window.location.href.split("#")[0]}#permissions-card`, el.permLinkStatus);
    });

    el.copyLocationLink.addEventListener("click", () => {
      copyText(`${window.location.href.split("#")[0]}#share-card`, el.locLinkStatus);
    });

    el.consentAccept.addEventListener("click", () => {
      state.consentGiven = true;
      addLog("Consent accepted for camera and microphone use");
      updateConsentUI();
      saveState();
    });

    loadState();
    updateUI();
  </script>
</body>
</html>
