<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Video Browser</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif}

body{
  background:#0e0e0e;
  color:#fff;
  padding:10px;
}

/* PLAYER */
#mainPlayer{
  width:100%;
  max-height:55vh;
  background:#000;
  margin-bottom:12px;
}

/* GRID */
.grid{
  display:grid;
  grid-template-columns:repeat(3,1fr); /* Android */
  gap:10px;
}
@media(min-width:1024px){
  .grid{grid-template-columns:repeat(6,1fr)} /* Laptop */
}

/* CARD */
.card{
  background:#1b1b1b;
  border-radius:6px;
  overflow:hidden;
  cursor:pointer;
  display:flex;
  flex-direction:column;
}
.card img{
  width:100%;
  height:150px;
  object-fit:cover;
}
.info{
  padding:6px;
}
.info h3{
  font-size:12px;
  line-height:1.2;
  height:32px;
  overflow:hidden;
}
.meta{
  font-size:11px;
  color:#aaa;
  margin-top:2px;
}

/* PAGINATION */
.pagination{
  display:flex;
  justify-content:center;
  gap:12px;
  margin:14px 0;
}
.pagination button{
  padding:6px 14px;
  border:none;
  border-radius:4px;
  background:#00c853;
  color:#000;
  cursor:pointer;
}

/* UI */
.loading,.error{
  text-align:center;
  padding:20px;
  color:#aaa;
}
</style>
</head>

<body>

<h3 style="text-align:center;margin-bottom:10px">Trending Videos</h3>

<video id="mainPlayer" controls playsinline preload="metadata"></video>


<div id="grid" class="grid"></div>

<div class="pagination">
  <button onclick="prevPage()">Prev</button>
  <span id="pageInfo"></span>
  <button onclick="nextPage()">Next</button>
</div>

<script>
/* ================= CONFIG ================= */

const PROXY =
  "https://czech.httpsfree-tvsdjjnworkersdev.workers.dev/?url=";

const BASE_AJAX =
  "https://www.gosexpod.com/v5/gosexpod/trending_iframe.lazy.2021.ajax.php";

let page = 1;
let videos = [];

/* ================= INIT ================= */

document.addEventListener("DOMContentLoaded", loadVideos);

/* ================= LOAD LIST ================= */

async function loadVideos(){
  showLoading();
  try{
    const ajaxUrl = BASE_AJAX + "?page=" + page;
    const res = await fetch(PROXY + encodeURIComponent(ajaxUrl));
    const html = await res.text();

    videos = parseAjax(html);
    renderVideos();
    updatePageInfo();
  }catch(e){
    console.error(e);
    showError("Failed to load videos");
  }
}

/* ================= PARSE AJAX HTML ================= */

function parseAjax(html){
  const doc = new DOMParser().parseFromString(html,"text/html");
  const items = doc.querySelectorAll(".thumbs__item");
  const list = [];

  items.forEach(item=>{
    const title = item.querySelector(".thumbs__info_text")?.textContent.trim() || "Untitled";
    const imgEl = item.querySelector("img");
    const dur = item.querySelector(".thumbs__bage_right span")?.textContent.trim() || "";
    const views = item.querySelector(".thumbs__bage_left span")?.textContent.trim() || "";

    let img = imgEl?.getAttribute("data-src") || imgEl?.getAttribute("src") || "";
    if(img.startsWith("/")){
      img = PROXY + "https://www.gosexpod.com" + img;
    }

    list.push({
      title,
      thumbnail: img,
      url: item.getAttribute("href"),
      duration: dur,
      views
    });
  });

  return list;
}

/* ================= RENDER ================= */

function renderVideos(){
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  if(!videos.length){
    showError("No videos found");
    return;
  }

  videos.forEach(v=>{
    const card = document.createElement("div");
    card.className = "card";
    card.onclick = ()=>playPostVideo(v.url);

    card.innerHTML = `
      <img src="${v.thumbnail}">
      <div class="info">
        <h3>${v.title}</h3>
        <div class="meta">${v.duration} â€¢ ${v.views}</div>
      </div>
    `;

    grid.appendChild(card);
  });
}

/* ================= PLAY VIDEO ================= */
async function playPostVideo(path, retries = 3) {
  try {
    const pageUrl = path.startsWith("http")
      ? path
      : "https://www.gosexpod.com" + path;

    // Extract the raw MP4 URL from the page
    const mp4 = await extractMp4(pageUrl);

    // Use your proxy
    const proxiedUrl = PROXY + encodeURIComponent(mp4);

    const player = document.getElementById("mainPlayer");

    player.src = proxiedUrl;
    player.load();

    // Retry logic
    player.onloadedmetadata = () => player.play();

    player.onerror = async () => {
      if (retries > 0) {
        console.warn(`Video load failed. Retrying... (${retries})`);
        await new Promise((r) => setTimeout(r, 500));
        playPostVideo(path, retries - 1);
      } else {
        alert("Failed to play video after multiple attempts.");
      }
    };
  } catch (e) {
    console.error(e);
    alert("Failed to load video URL.");
  }
}



/* ================= EXTRACT MP4 ================= */

async function extractMp4(pageUrl){
  const res = await fetch(PROXY + encodeURIComponent(pageUrl));
  const html = await res.text();

  const doc = new DOMParser().parseFromString(html,"text/html");
  const src = doc.querySelector("video source")?.src;

  if(!src) throw new Error("MP4 not found");
  return src;
}

/* ================= PAGINATION ================= */

function nextPage(){
  page++;
  loadVideos();
}
function prevPage(){
  if(page>1){
    page--;
    loadVideos();
  }
}
function updatePageInfo(){
  document.getElementById("pageInfo").innerText = "Page " + page;
}

/* ================= UI ================= */

function showLoading(){
  document.getElementById("grid").innerHTML =
    "<div class='loading'>Loading...</div>";
}
function showError(msg){
  document.getElementById("grid").innerHTML =
    "<div class='error'>"+msg+"</div>";
}
</script>

</body>
</html>
