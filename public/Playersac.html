<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Playersac</title>
  <meta name="theme-color" content="#121212">
  <link rel="manifest" href="Playersac.manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.js"></script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&family=DM+Serif+Display&display=swap");

    :root {
      --bg: #0f0f0f;
      --panel: #161616;
      --panel-2: #1c1c1c;
      --text: #f3f3f3;
      --muted: #a8a8a8;
      --accent: #1db954;
      --accent-2: #1ed760;
      --danger: #ff6b6b;
      --ring: rgba(29, 185, 84, 0.35);
      --shadow: 0 18px 45px rgba(0, 0, 0, 0.45);
      --radius: 18px;
      --safe-bottom: env(safe-area-inset-bottom);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Manrope", system-ui, -apple-system, sans-serif;
      background: radial-gradient(1200px 600px at 10% -20%, #19321f 0%, rgba(12,12,12,0) 60%),
                  radial-gradient(800px 500px at 100% 0%, #1c1c1c 0%, rgba(12,12,12,0) 70%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: calc(140px + var(--safe-bottom));
    }

    button, input {
      font-family: inherit;
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 16px 24px;
    }

    /* Top Bar */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 100;
      padding: 16px 0 10px;
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(12,12,12,0.96) 0%, rgba(12,12,12,0.86) 70%, rgba(12,12,12,0) 100%);
    }

    .topbar-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: nowrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background: conic-gradient(from 140deg, var(--accent), var(--accent-2), #b8ffcc, var(--accent));
      box-shadow: 0 8px 18px rgba(29, 185, 84, 0.35);
    }

    .brand h1 {
      font-family: "DM Serif Display", serif;
      font-size: 26px;
      letter-spacing: 0.5px;
    }

    .nav-row {
      display: grid;
      gap: 10px;
      margin-top: 16px;
      grid-template-columns: 1fr;
    }

    @media (min-width: 720px) {
      .nav-row {
        grid-template-columns: 1fr auto;
        align-items: center;
      }
    }

    .search {
      display: flex;
      gap: 10px;
      background: var(--panel);
      border-radius: 999px;
      padding: 10px 14px;
      border: 1px solid transparent;
      box-shadow: var(--shadow);
      margin-left: auto;
      width: min(420px, 42vw);
      min-width: 200px;
    }

    .search input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 15px;
      outline: none;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      border-radius: 999px;
      padding: 8px 14px;
      background: var(--panel);
      border: 1px solid #1f2a36;
      color: var(--text);
      cursor: pointer;
      transition: transform 0.15s ease, border-color 0.2s ease;
      touch-action: manipulation;
    }

    .chip.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--ring);
    }

    .chip:hover {
      transform: translateY(-1px);
    }

    /* Stats */
    .stats {
      margin-top: 18px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }

    .stat {
      background: linear-gradient(135deg, rgba(22,22,22,0.9), rgba(15,15,15,0.9));
      border-radius: var(--radius);
      padding: 8px 10px;
      border: 1px solid #1a2734;
      min-height: 56px;
    }

    .stat .label {
      color: var(--muted);
      font-size: 12px;
    }

    .stat .value {
      font-size: 18px;
      font-weight: 700;
      margin-top: 4px;
    }

    /* Grid */
    .grid {
      margin-top: 24px;
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
    }

    .card {
      background: var(--panel);
      border-radius: var(--radius);
      overflow: visible;
      border: 1px solid #1b2632;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
    }

    .cover {
      position: relative;
      width: 100%;
      aspect-ratio: 1;
      background: #0e0e0e;
    }

    .cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .cover button {
      position: absolute;
      top: 10px;
      right: 10px;
      border: none;
      background: rgba(0,0,0,0.6);
      color: #fff;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
    }

    .card-body {
      padding: 12px 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .card h4 {
      font-size: 14px;
      margin-bottom: 4px;
      line-height: 1.3;
      min-height: 36px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .card p {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      min-height: 30px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .actions {
      display: flex;
      gap: 8px;
      margin-top: auto;
      flex-wrap: wrap;
    }

    .actions button {
      flex: 1;
      border-radius: 10px;
      border: 1px solid #203040;
      background: var(--panel-2);
      color: var(--text);
      padding: 8px 10px;
      font-size: 12px;
      cursor: pointer;
      min-width: 92px;
    }

    .actions button.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border: none;
      color: #06140a;
      font-weight: 600;
    }

    .menu {
      position: fixed;
      background: #0f1720;
      border: 1px solid #1d2a39;
      border-radius: 12px;
      min-width: 160px;
      display: none;
      z-index: 20;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .menu button {
      display: block;
      width: 100%;
      padding: 10px 12px;
      background: transparent;
      border: none;
      color: var(--text);
      text-align: left;
      cursor: pointer;
    }

    .menu button:hover {
      background: #141f2a;
    }

    /* Pagination */
    .pagination {
      margin: 28px auto 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pagination button,
    .pagination input {
      background: var(--panel);
      border: 1px solid #1f2a36;
      color: var(--text);
      border-radius: 10px;
      padding: 8px 12px;
    }

    .pagination input {
      width: 70px;
      text-align: center;
    }

    /* Player */
    .mini-player {
      position: fixed;
      left: 16px;
      right: 16px;
      bottom: calc(12px + var(--safe-bottom));
      background: linear-gradient(135deg, #2c0f4f, #311b5f 45%, #1d1b2f);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 20px;
      padding: 12px 14px;
      display: none;
      z-index: 120;
      box-shadow: 0 16px 40px rgba(0,0,0,0.45);
    }

    .mini-row {
      display: grid;
      grid-template-columns: 40px 1fr;
      gap: 10px;
      align-items: center;
    }

    .mini-row img {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      object-fit: cover;
    }

    .mini-title {
      font-size: 13px;
      font-weight: 700;
    }

    .mini-artist {
      font-size: 11px;
      color: rgba(255,255,255,0.7);
    }

    .mini-actions {
      display: grid;
      grid-template-columns: repeat(3, 36px);
      justify-content: end;
      gap: 8px;
    }

    .mini-actions button {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,0.25);
      color: #fff;
      cursor: pointer;
      font-size: 12px;
    }

    .progress {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
      font-size: 11px;
      color: rgba(255,255,255,0.7);
    }

    .mini-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    .mini-controls .center {
      display: grid;
      place-items: center;
      margin: 0 auto;
      flex: 0 0 auto;
    }

    .mini-play {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      border: none;
      background: #fff;
      color: #2b0f4a;
      font-weight: 700;
      cursor: pointer;
      display: grid;
      place-items: center;
    }

    .mini-skip {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,0.25);
      color: #fff;
      cursor: pointer;
    }

    .icon-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,0.25);
      color: #fff;
      cursor: pointer;
      display: grid;
      place-items: center;
    }

    .icon-btn.active {
      background: rgba(29,185,84,0.35);
      box-shadow: 0 0 0 2px rgba(29,185,84,0.25);
    }

    .icon-btn svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    .mini-player .icon-btn svg {
      width: 18px;
      height: 18px;
    }

    .mini-play svg,
    .full-controls .play svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    .mini-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 4px;
    }

    .mini-meta span {
      font-size: 10px;
      opacity: 0.75;
    }

    .progress input {
      width: 100%;
    }

    /* Full Player */
    .full-player {
      position: fixed;
      inset: 0;
      background: radial-gradient(900px 600px at 20% -20%, rgba(29,185,84,0.25), transparent 60%),
                  radial-gradient(700px 400px at 100% 0%, rgba(30,215,96,0.2), transparent 60%),
                  #0a0a0a;
      display: none;
      z-index: 200;
      padding: 24px 16px 24px;
      overflow-y: auto;
    }

    .full-player.now-playing .full-cover {
      animation: pulse 2.4s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); box-shadow: 0 18px 50px rgba(0,0,0,0.55); }
      50% { transform: scale(1.02); box-shadow: 0 24px 60px rgba(0,0,0,0.65); }
    }

    .full-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .settings-btn {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: 1px solid #1f2a36;
      background: var(--panel-2);
      color: var(--text);
      display: grid;
      place-items: center;
      cursor: pointer;
    }

    .settings-menu {
      position: fixed;
      top: 16px;
      right: 16px;
      background: #0f1720;
      border: 1px solid #1d2a39;
      border-radius: 12px;
      min-width: 180px;
      display: none;
      z-index: 260;
      overflow: hidden;
      box-shadow: var(--shadow);
      padding: 10px;
    }

    .settings-menu button {
      display: block;
      width: 100%;
      padding: 10px 12px;
      background: transparent;
      border: none;
      color: var(--text);
      text-align: left;
      cursor: pointer;
    }

    .settings-menu button:hover {
      background: #141f2a;
    }

    .settings-group {
      display: grid;
      gap: 6px;
      margin-bottom: 10px;
    }

    .settings-group span {
      font-size: 11px;
      color: var(--muted);
    }

    .settings-group select {
      background: #121a24;
      color: var(--text);
      border: 1px solid #1d2a39;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
      outline: none;
    }

    .settings-divider {
      height: 1px;
      background: #1d2a39;
      margin: 8px 0 10px;
    }

    .full-cover {
      width: min(320px, 80vw);
      height: min(320px, 80vw);
      border-radius: 26px;
      object-fit: cover;
      box-shadow: 0 18px 50px rgba(0,0,0,0.55);
      margin: 24px auto 18px;
      display: block;
    }

    .full-meta {
      text-align: center;
      margin-bottom: 12px;
    }

    .full-meta h2 {
      font-size: 22px;
    }

    .full-meta p {
      color: var(--muted);
      margin-top: 6px;
    }

    .full-controls {
      display: grid;
      grid-template-columns: repeat(5, 52px);
      justify-content: center;
      gap: 20px;
      margin-top: 10px;
    }

    .full-controls button {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: none;
      background: #15212d;
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
    }

    .full-controls .play {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #041307;
      font-size: 20px;
      font-weight: 700;
    }

    .waveform {
      width: 100%;
      height: 90px;
      display: block;
      border-radius: 14px;
      background: #0e0e0e;
      border: 1px solid #1f2a36;
      margin: 16px auto 8px;
      cursor: pointer;
    }

    .eq-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      justify-content: center;
    }

    .eq-chip {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #1f2a36;
      background: var(--panel-2);
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
    }

    .eq-chip.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--ring);
    }

    .sliders {
      display: none;
    }

    .slider-row {
      display: grid;
      grid-template-columns: 90px 1fr auto;
      gap: 10px;
      align-items: center;
      font-size: 12px;
      color: var(--muted);
    }

    .queue {
      max-width: 520px;
      margin: 20px auto 0;
      background: rgba(12,12,12,0.6);
      border-radius: 16px;
      border: 1px solid #1f2c3b;
      overflow: hidden;
    }

    .queue-item {
      padding: 12px 14px;
      border-bottom: 1px solid #1c2836;
      cursor: pointer;
    }

    .queue-item:last-child {
      border-bottom: none;
    }

    .queue-item.active {
      background: rgba(50,216,198,0.1);
      color: var(--accent);
      font-weight: 600;
    }

    /* Toast */
    .toast {
      position: fixed;
      left: 50%;
      bottom: calc(90px + var(--safe-bottom));
      transform: translateX(-50%);
      background: #111;
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid #1f2a36;
      display: none;
      z-index: 300;
    }
    .row-title {
      margin-top: 24px;
      font-size: 16px;
      font-weight: 700;
    }

    .row-scroll {
      margin-top: 12px;
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: minmax(160px, 1fr);
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 6px;
      scroll-snap-type: x mandatory;
    }

    .row-scroll .card {
      scroll-snap-align: start;
    }

    /* Hide scrollbars but keep scrolling */
    * {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    *::-webkit-scrollbar {
      width: 0;
      height: 0;
    }

    .skeleton {
      background: linear-gradient(90deg, #1a1a1a 25%, #232323 50%, #1a1a1a 75%);
      background-size: 200% 100%;
      animation: shimmer 1.6s infinite;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    #visualizer {
      width: 100%;
      height: 140px;
      display: block;
      border-radius: 16px;
      background: #0e0e0e;
      border: 1px solid #1f2a36;
      margin: 18px auto 6px;
    }

    .mini-preview {
      margin-top: 18px;
      display: grid;
      place-items: center;
    }

    .mini-preview-card {
      width: min(320px, 90vw);
      background: linear-gradient(135deg, #2c0f4f, #311b5f 45%, #1d1b2f);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.08);
      padding: 12px 14px;
      color: #fff;
      box-shadow: 0 16px 40px rgba(0,0,0,0.45);
    }

    .mini-preview-top {
      display: grid;
      grid-template-columns: 36px 1fr auto;
      gap: 10px;
      align-items: center;
    }

    .mini-preview-top img {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      object-fit: cover;
    }

    .artist-modal {
      position: fixed;
      inset: 0;
      display: none;
      background: rgba(0,0,0,0.7);
      z-index: 500;
      padding: 24px 16px;
    }

    .artist-card {
      max-width: 620px;
      margin: 40px auto 0;
      background: var(--panel);
      border-radius: 18px;
      border: 1px solid #1f2a36;
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .artist-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .artist-list {
      margin-top: 12px;
      display: grid;
      gap: 8px;
    }

    .artist-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: #121212;
      border-radius: 12px;
      padding: 10px 12px;
    }

    @media (max-width: 760px) {
      .app { padding: 0 12px 20px; }
      .brand h1 { font-size: 22px; }
      .logo { width: 38px; height: 38px; border-radius: 12px; }
      .topbar-head { flex-wrap: nowrap; }
      .search { padding: 8px 12px; width: 52vw; min-width: 160px; }
      .search input { font-size: 13px; }
      .chip-row { overflow-x: auto; flex-wrap: nowrap; padding-bottom: 4px; }
      .chip { padding: 6px 10px; font-size: 12px; white-space: nowrap; flex: 0 0 auto; }
      .chip-row::-webkit-scrollbar { display: none; }
      .stats { grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 8px; }
      .stat { padding: 6px 8px; min-height: 48px; }
      .stat .label { font-size: 10px; }
      .stat .value { font-size: 16px; margin-top: 2px; }
      .grid { gap: 12px; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
      .card-body { padding: 10px 10px 12px; }
      .card h4 { font-size: 13px; }
      .card p { font-size: 11px; }
      .actions button { padding: 6px 8px; font-size: 11px; }
      .mini-player { left: 10px; right: 10px; padding: 10px 12px; border-radius: 18px; }
      .mini-row img { width: 34px; height: 34px; }
      .mini-title { font-size: 12px; }
      .mini-artist { font-size: 10px; }
      .mini-controls { gap: 6px; }
      .mini-aux { display: none; }
      .icon-btn, .mini-skip { width: 28px; height: 28px; }
      .mini-play { width: 40px; height: 40px; }
      .full-cover { width: min(260px, 78vw); height: min(260px, 78vw); }
      .full-controls { gap: 14px; grid-template-columns: repeat(5, 44px); }
      .full-controls button { width: 44px; height: 44px; }
      .waveform { height: 70px; }
      #visualizer { height: 110px; }
      .mini-preview-card { width: min(280px, 92vw); }
    }

    @media (max-width: 520px) {
      .stats { grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 6px; }
      .full-controls { grid-template-columns: repeat(5, 40px); gap: 10px; }
      .full-controls button { width: 40px; height: 40px; font-size: 16px; }
      .search { width: 58vw; min-width: 150px; }
    }

    @media (max-width: 360px) {
      .brand h1 { font-size: 19px; }
      .search { padding: 6px 10px; width: 60vw; min-width: 140px; }
      .search input { font-size: 12px; }
      .chip { padding: 5px 8px; font-size: 11px; }
      .stats { gap: 6px; }
      .stat { padding: 6px 6px; min-height: 44px; }
      .stat .label { font-size: 9px; }
      .stat .value { font-size: 14px; }
      .grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
      .mini-player { padding: 8px 10px; border-radius: 16px; }
      .mini-row img { width: 30px; height: 30px; }
      .mini-title { font-size: 11px; }
      .mini-artist { font-size: 9px; }
      .mini-controls { gap: 5px; }
      .icon-btn, .mini-skip { width: 24px; height: 24px; }
      .mini-play { width: 36px; height: 36px; font-size: 12px; }
      .full-cover { width: min(220px, 76vw); height: min(220px, 76vw); }
      .full-controls { grid-template-columns: repeat(5, 34px); gap: 8px; }
      .full-controls button { width: 34px; height: 34px; font-size: 14px; }
      .waveform { height: 60px; }
      #visualizer { height: 90px; }
      .mini-preview-card { width: min(250px, 94vw); }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="topbar-head">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <h1>Playersac</h1>
          </div>
        </div>
        <label class="search">
          <input id="searchBox" placeholder="Search songs, singers, or albums" oninput="debouncedSearch()">
        </label>
      </div>

      <div class="nav-row">
        <div class="chip-row">
          <button class="chip active" onclick="navAll()">All</button>
          <button class="chip" onclick="showAlbums()">Albums</button>
          <button class="chip" onclick="showPlaylists()">Playlists</button>
          <button class="chip" onclick="showLiked()">Liked</button>
          <button class="chip" onclick="showRecent()">Recent</button>
        </div>
      </div>

      <div class="chip-row" id="categoryNav"></div>

      <div class="stats" id="stats"></div>
    </div>

    <main id="content">Loading...</main>
    <div class="pagination" id="pagination"></div>
  </div>

  <div class="mini-player" id="player" style="display: none;" onclick="openFullPlayer(event)">
    <div class="mini-row">
      <img id="pCover" alt="cover">
      <div>
        <div class="mini-title" id="pTitle"></div>
        <div class="mini-artist" id="pArtist"></div>
      </div>
    </div>
    <div class="mini-controls">
      <button class="icon-btn mini-aux" onclick="toggleShuffle()" id="miniShuffle" title="Shuffle">
        <svg viewBox="0 0 24 24"><path d="M16 3h5v5h-2V6.41l-3.3 3.3-1.4-1.42L17.59 5H16V3zM3 7h4.59l7.7 7.7-1.41 1.41L6.17 9H3V7zm0 10h4.59l2.71-2.71 1.41 1.41L8.17 19H3v-2zm13 0h1.59L14.3 13.7l1.4-1.4L19 15.59V14h2v5h-5v-2z"/></svg>
      </button>
      <button class="icon-btn mini-aux" onclick="toggleRepeat()" id="miniRepeat" title="Repeat">
        <svg viewBox="0 0 24 24"><path d="M7 7h9l-2-2 1.4-1.4L20.8 7l-5.4 3.4L14 9l2-2H7v3H5V7a2 2 0 0 1 2-2zm10 10H8l2 2-1.4 1.4L3.2 17l5.4-3.4L10 15l-2 2h9v-3h2v3a2 2 0 0 1-2 2z"/></svg>
      </button>
      <button class="icon-btn mini-aux" onclick="downloadCurrent(320)" title="Download 320">
        <svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM11 4h2v8l3-3 1.4 1.4-5.4 5.4-5.4-5.4L8 9l3 3V4z"/></svg>
      </button>
      <button class="mini-skip icon-btn" onclick="prev()" title="Previous">
        <svg viewBox="0 0 24 24"><path d="M6 5h2v14H6V5zm3.5 7 9.5 7V5l-9.5 7z"/></svg>
      </button>
      <div class="center">
        <button class="mini-play" onclick="togglePlay()" id="miniPlay" title="Play">
          <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        </button>
      </div>
      <button class="mini-skip icon-btn" onclick="next()" title="Next">
        <svg viewBox="0 0 24 24"><path d="M16 5h2v14h-2V5zM5 19l9.5-7L5 5v14z"/></svg>
      </button>
      <button class="icon-btn mini-aux" onclick="cycleSpeed()" id="miniSpeed" title="Speed">
        <svg viewBox="0 0 24 24"><path d="M11 2h2v2h-2V2zm6.36 3.64 1.42 1.42-1.42 1.42-1.42-1.42 1.42-1.42zM20 11v2h-2v-2h2zM6.64 5.64 8.06 7.06 6.64 8.48 5.22 7.06l1.42-1.42zM4 11v2H2v-2h2zm2.22 7.78 1.42-1.42 1.42 1.42-1.42 1.42-1.42-1.42zM11 20h2v2h-2v-2zm7.78-2.22-1.42-1.42 1.42-1.42 1.42 1.42-1.42 1.42zM12 6a6 6 0 1 0 6 6h-2a4 4 0 1 1-4-4V6z"/></svg>
      </button>
    </div>
    <div class="mini-meta">
      <span id="cur">0:00</span>
      <span id="dur">0:00</span>
    </div>
    <input type="range" id="seek" min="0" max="100" value="0">
  </div>

  <div class="full-player" id="fullPlayer">
    <div class="full-header">
      <button class="chip" onclick="closeFull()">Back</button>
      <button class="settings-btn" onclick="toggleSettingsMenu()" title="Settings">
        <svg viewBox="0 0 24 24"><path d="M12 7a2 2 0 1 0 .001-3.999A2 2 0 0 0 12 7zm0 7a2 2 0 1 0 .001-3.999A2 2 0 0 0 12 14zm0 7a2 2 0 1 0 .001-3.999A2 2 0 0 0 12 21z"/></svg>
      </button>
    </div>

    <img class="full-cover" id="fCover" alt="cover">
    <div class="full-meta">
      <h2 id="fTitle"></h2>
      <p><button class="chip" onclick="openArtistFromNowPlaying()" id="fArtist"></button></p>
    </div>
    <canvas id="visualizer"></canvas>
    <div class="progress" style="max-width: 500px; margin: 0 auto;">
      <span id="fcur">0:00</span>
      <input type="range" id="fseek" min="0" max="100" value="0">
      <span id="fdur">0:00</span>
    </div>

    <div class="full-controls">
      <button class="icon-btn" onclick="toggleShuffle()" id="fullShuffle" title="Shuffle">
        <svg viewBox="0 0 24 24"><path d="M16 3h5v5h-2V6.41l-3.3 3.3-1.4-1.42L17.59 5H16V3zM3 7h4.59l7.7 7.7-1.41 1.41L6.17 9H3V7zm0 10h4.59l2.71-2.71 1.41 1.41L8.17 19H3v-2zm13 0h1.59L14.3 13.7l1.4-1.4L19 15.59V14h2v5h-5v-2z"/></svg>
      </button>
      <button class="icon-btn" onclick="prev()" title="Previous">
        <svg viewBox="0 0 24 24"><path d="M6 5h2v14H6V5zm3.5 7 9.5 7V5l-9.5 7z"/></svg>
      </button>
      <button class="play icon-btn" onclick="togglePlay()" id="fullPlay" title="Play">
        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      </button>
      <button class="icon-btn" onclick="next()" title="Next">
        <svg viewBox="0 0 24 24"><path d="M16 5h2v14h-2V5zM5 19l9.5-7L5 5v14z"/></svg>
      </button>
      <button class="icon-btn" onclick="toggleRepeat()" id="fullRepeat" title="Repeat">
        <svg viewBox="0 0 24 24"><path d="M7 7h9l-2-2 1.4-1.4L20.8 7l-5.4 3.4L14 9l2-2H7v3H5V7a2 2 0 0 1 2-2zm10 10H8l2 2-1.4 1.4L3.2 17l5.4-3.4L10 15l-2 2h9v-3h2v3a2 2 0 0 1-2 2z"/></svg>
      </button>
    </div>

    <div class="mini-preview">
      <div class="mini-preview-card">
        <div class="mini-preview-top">
          <img id="previewCover" alt="cover">
          <div>
            <div class="mini-title" id="previewTitle"></div>
            <div class="mini-artist" id="previewArtist"></div>
          </div>
          <button class="icon-btn" onclick="downloadCurrent(320)" title="Download 320">
            <svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM11 4h2v8l3-3 1.4 1.4-5.4 5.4-5.4-5.4L8 9l3 3V4z"/></svg>
          </button>
        </div>
      </div>
    </div>

    <div class="eq-row" id="eqRow"></div>

    <div class="queue" id="queue"></div>
  </div>

  <div class="settings-menu" id="settingsMenu">
    <div class="settings-group">
      <span>Sound Preference</span>
      <select id="presetSelect" onchange="changePreset(this.value)">
        <option value="Flat">Flat</option>
        <option value="Bass">Bass</option>
        <option value="Vocal">Vocal</option>
        <option value="Treble">Treble</option>
        <option value="Boost">Boost</option>
      </select>
    </div>
    <div class="settings-group">
      <span>Volume Boost</span>
      <select id="boostSelect" onchange="setVolumeBoost(this.value)">
        <option value="1">Off</option>
        <option value="1.25">Low</option>
        <option value="1.5">High</option>
      </select>
    </div>
    <div class="settings-group">
      <span>Visualizer</span>
      <select id="vizSelect" onchange="setVisualizer(this.value)">
        <option value="on">On</option>
        <option value="off">Off</option>
      </select>
    </div>
    <div class="settings-divider"></div>
    <button onclick="openSleepTimer()">Sleep Timer</button>
    <button onclick="saveOfflineCurrent()">Save Offline</button>
  </div>

  <div class="artist-modal" id="artistModal">
    <div class="artist-card">
      <div class="artist-header">
        <div>
          <div class="mini-title" id="artistName">Artist</div>
          <div class="mini-artist">Top songs</div>
        </div>
        <button class="chip" onclick="closeArtist()">Close</button>
      </div>
      <div class="artist-list" id="artistList"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <audio id="audio" preload="metadata"></audio>

  <script>
    const PROXY = "https://tv-4vo.pages.dev/api/proxy?extract=true&url=";
    const SUPABASE_URL = "https://ojcqoqegblymhmmimvqe.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qY3FvcWVnYmx5bWhtbWltdnFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNDQ0MjMsImV4cCI6MjA4NDkyMDQyM30.oXAZvL9-oed20RnWqOPRHUcm63Qc1EgiQ2SMerlZlNU";
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const PER_PAGE = 24;
    const state = { page: 1, total: 0, mode: "all", category: null, search: "", album: null };
    let songs = [];
    let playlist = [];
    let index = -1;
    let shuffle = false;
    let repeat = false;
    let audioCtx;
    let analyser;
    let sourceNode;
    let eqFilters = [];
    let boostNode;
    let vizRunning = false;
    let sleepTimerId;
    let sleepEndsAt = 0;
    let currentArtist = "";
    let currentSources = [];
    let currentSourceIndex = 0;

    let liked = JSON.parse(localStorage.getItem("liked") || "[]");
    let recent = JSON.parse(localStorage.getItem("recent") || "[]");
    let playlists = JSON.parse(localStorage.getItem("playlists") || "{}");
    let playCounts = JSON.parse(localStorage.getItem("play_counts") || "{}");
    let cachedSongs = JSON.parse(localStorage.getItem("cache_songs") || "[]");
    let cachedAt = Number(localStorage.getItem("cache_songs_at") || "0");
    let cachedQueue = JSON.parse(localStorage.getItem("queue_cache") || "[]");
    let cachedIndex = Number(localStorage.getItem("queue_index") || "-1");

    const audio = document.getElementById("audio");
    const player = document.getElementById("player");
   
    const waveform = document.getElementById("waveform");
    const eqRow = document.getElementById("eqRow");
    const artistModal = document.getElementById("artistModal");
    const settingsMenu = document.getElementById("settingsMenu");
    const presetSelect = document.getElementById("presetSelect");
    const boostSelect = document.getElementById("boostSelect");
    const vizSelect = document.getElementById("vizSelect");

    const PLACEHOLDER_COVER = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='600' height='600' viewBox='0 0 600 600'><rect width='600' height='600' fill='%23121212'/><circle cx='300' cy='300' r='200' fill='%231db954'/><polygon points='260,210 410,300 260,390' fill='%23070b08'/></svg>";
    const EQ_PRESETS = [
      { name: "Flat", gains: [0, 0, 0, 0, 0] },
      { name: "Bass", gains: [6, 4, 2, 0, -2] },
      { name: "Vocal", gains: [-2, 0, 4, 4, 2] },
      { name: "Treble", gains: [-2, 0, 2, 4, 6] },
      { name: "Boost", gains: [4, 2, 0, 2, 4] }
    ];
    let activePreset = "Flat";

    function esc(text) {
      return String(text || "").replace(/[&<>"']/g, s => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;"
      }[s]));
    }

    function imgUrl(url) {
      return esc(proxify(url || ""));
    }

    function applyThemeFromCover(url) {
      if (!url) return;
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.referrerPolicy = "no-referrer";
      img.onload = () => {
        try {
          const c = document.createElement("canvas");
          c.width = 48;
          c.height = 48;
          const ctx = c.getContext("2d");
          ctx.drawImage(img, 0, 0, 48, 48);
          const data = ctx.getImageData(0, 0, 48, 48).data;
          let r = 0, g = 0, b = 0, count = 0;
          for (let i = 0; i < data.length; i += 4) {
            const alpha = data[i + 3];
            if (alpha < 200) continue;
            r += data[i];
            g += data[i + 1];
            b += data[i + 2];
            count++;
          }
          if (!count) return;
          r = Math.round(r / count);
          g = Math.round(g / count);
          b = Math.round(b / count);
          document.documentElement.style.setProperty("--accent", `rgb(${r}, ${g}, ${b})`);
          document.documentElement.style.setProperty("--accent-2", `rgb(${Math.min(r + 30, 255)}, ${Math.min(g + 30, 255)}, ${Math.min(b + 30, 255)})`);
        } catch {
        }
      };
      img.onerror = () => {};
      img.src = url;
    }

    function buildEqUI() {
      eqRow.innerHTML = EQ_PRESETS.map(p => `
        <button class="eq-chip ${p.name === activePreset ? "active" : ""}" onclick="setPreset('${p.name}')">${p.name}</button>
      `).join("");
    }

    function changePreset(name) {
      setPreset(name);
      if (presetSelect) presetSelect.value = name;
    }

    function setPreset(name) {
      const preset = EQ_PRESETS.find(p => p.name === name);
      if (!preset) return;
      activePreset = preset.name;
      try { ensureAudioGraph(); } catch {}
      const gains = preset.gains;
      for (let i = 0; i < eqFilters.length; i++) {
        eqFilters[i].gain.value = gains[i] || 0;
      }
      buildEqUI();
      toast("EQ: " + preset.name);
    }

    function getDurationSeconds(s) {
      const candidates = [s.duration, s.duration_seconds, s.length, s.length_seconds];
      for (let i = 0; i < candidates.length; i++) {
        if (typeof candidates[i] === "string" && candidates[i].includes(":")) {
          const parts = candidates[i].split(":").map(n => Number(n));
          if (parts.length === 2 && parts.every(n => !Number.isNaN(n))) return parts[0] * 60 + parts[1];
          if (parts.length === 3 && parts.every(n => !Number.isNaN(n))) return parts[0] * 3600 + parts[1] * 60 + parts[2];
        }
        const val = Number(candidates[i]);
        if (!Number.isNaN(val) && val > 0) return val;
      }
      return 0;
    }

    function estimateSizeMB(seconds, kbps) {
      if (!seconds || !kbps) return 0;
      const bytes = (seconds * kbps * 1000) / 8;
      return bytes / (1024 * 1024);
    }

    function sizeBadge(s, rate) {
      const seconds = getDurationSeconds(s);
      if (!seconds) return "";
      const mb = estimateSizeMB(seconds, rate);
      return ` (${mb.toFixed(1)} MB)`;
    }

    function withTimeout(promise, ms) {
      let timer;
      return Promise.race([
        promise,
        new Promise((_, reject) => {
          timer = setTimeout(() => reject(new Error("timeout")), ms);
        })
      ]).finally(() => clearTimeout(timer));
    }

    async function retry(fn, tries) {
      let lastErr;
      for (let i = 0; i < tries; i++) {
        try {
          return await fn();
        } catch (err) {
          lastErr = err;
          await new Promise(r => setTimeout(r, 400 + i * 300));
        }
      }
      throw lastErr;
    }

    async function dbBouncer(queryFn) {
      return retry(() => withTimeout(queryFn(), 6000), 3);
    }

    function setActiveChip(label) {
      document.querySelectorAll(".chip-row .chip").forEach(btn => {
        if (btn.textContent === label) btn.classList.add("active");
        else btn.classList.remove("active");
      });
    }

    function toast(msg) {
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.style.display = "block";
      setTimeout(() => el.style.display = "none", 2400);
    }

    function escapeSearch(value) {
      return String(value || "").replace(/[%_(),]/g, "\\$&");
    }

    async function loadSongs() {
      const from = (state.page - 1) * PER_PAGE;
      const to = from + PER_PAGE - 1;
      let q = db.from("songs").select("*", { count: "exact" });
      if (state.mode === "category") q = q.eq("category_id", state.category);
      if (state.mode === "search") {
        const safe = escapeSearch(state.search);
        q = q.or(`song_name.ilike.*${safe}*,singers.ilike.*${safe}*,movie_name.ilike.*${safe}*`);
      }
      if (state.mode === "album") q = q.eq("movie_name", state.album);
      try {
        const { data, count, error } = await dbBouncer(() => q.order("song_name").range(from, to));
        if (error) throw error;
        songs = data || [];
        playlist = songs;
        state.total = count || 0;
        cacheSongs(songs);
        renderSongs();
        renderPagination();
        renderStats();
      } catch (err) {
        if (cachedSongs.length) {
          songs = cachedSongs;
          playlist = songs;
          state.total = cachedSongs.length;
          renderSongs(true);
          renderPagination();
          renderStats();
          toast("Offline mode: cached songs");
        } else {
          content.textContent = "Failed to load songs.";
          toast("Error loading songs");
        }
      }
    }

    function navAll() {
      state.mode = "all";
      state.page = 1;
      loadSongs();
      setActiveChip("All");
    }

    function navCategory(id, name) {
      state.mode = "category";
      state.category = id;
      state.page = 1;
      loadSongs();
      setActiveChip(name);
    }

    let timer;
    function debouncedSearch() {
      clearTimeout(timer);
      timer = setTimeout(() => {
        const q = searchBox.value.trim();
        if (!q) return navAll();
        state.mode = "search";
        state.search = q;
        state.page = 1;
        loadSongs();
        setActiveChip("All");
      }, 300);
    }

    async function loadCategories() {
      try {
      const { data } = await dbBouncer(() => db.from("categories").select("id,name").order("name"));
        categoryNav.innerHTML = "";
        (data || []).forEach(c => {
          const b = document.createElement("button");
          b.className = "chip";
          b.textContent = c.name;
          b.onclick = () => navCategory(c.id, c.name);
          categoryNav.appendChild(b);
        });
      } catch (err) {
        categoryNav.innerHTML = "";
      }
    }

    function renderSongs(isCached = false) {
      if (!songs.length) {
        content.innerHTML = "<p>No songs found.</p>";
        return;
      }

      const forYou = renderForYou();

      content.innerHTML = `
        ${forYou}
        ${isCached ? "<p class=\"subline\">Showing cached songs.</p>" : ""}
        <div class="grid">
          ${songs.map((s, i) => `
            <div class="card">
              <div class="cover">
                <img src="${imgUrl(s.cover_image || PLACEHOLDER_COVER)}" alt="cover" loading="lazy" decoding="async" referrerpolicy="no-referrer" crossorigin="anonymous" onerror="this.src='${PLACEHOLDER_COVER}'" onclick="playSong(${i})">
                <button onclick="toggleMenu(event,${i})">...</button>
                <div class="menu" id="menu${i}">
                  <button onclick="downloadSong(${i},320)">Download 320${sizeBadge(s, 320)}</button>
                  <button onclick="downloadSong(${i},128)">Download 128${sizeBadge(s, 128)}</button>
                  <button onclick="saveOfflineSong(${i})">Save offline</button>
                  <button onclick="likeSong(${i})">${liked.some(x => x.id === s.id) ? "Unlike" : "Like"}</button>
                  <button onclick="addToPlaylist(${i})">Add to playlist</button>
                </div>
              </div>
              <div class="card-body">
                <h4>${esc(s.song_name)}</h4>
                <p>${esc(s.singers || "Unknown artist")}</p>
                <div class="actions">
                  <button class="primary" onclick="playSong(${i})">Play</button>
                  <button onclick="queueNext(${i})">Play next</button>
                </div>
              </div>
            </div>
          `).join("")}
        </div>
      `;
    }

    function renderPagination() {
      const pages = Math.ceil(state.total / PER_PAGE);
      if (pages <= 1) {
        pagination.innerHTML = "";
        return;
      }
      pagination.innerHTML = `
        <button onclick="changePage(${state.page - 1})">Prev</button>
        <span>${state.page} / ${pages}</span>
        <input id="pg" placeholder="Page">
        <button onclick="goPage()">Go</button>
        <button onclick="changePage(${state.page + 1})">Next</button>
      `;
    }

    function renderStats() {
      stats.innerHTML = `
        <div class="stat">
          <div class="label">Total Songs</div>
          <div class="value">${state.total}</div>
        </div>
        <div class="stat">
          <div class="label">Liked</div>
          <div class="value">${liked.length}</div>
        </div>
        <div class="stat">
          <div class="label">Recent</div>
          <div class="value">${recent.length}</div>
        </div>
      `;
    }

    function renderForYou() {
      if (state.mode !== "all") return "";
      const recs = getRecommendations();
      if (!recs.length) return "";
      return `
        <div class="row-title">For You</div>
        <div class="row-scroll">
          ${recs.map((s, i) => `
            <div class="card" onclick="playById('${s.id}')">
              <div class="cover">
                <img src="${imgUrl(s.cover_image || PLACEHOLDER_COVER)}" alt="cover" loading="lazy" decoding="async" referrerpolicy="no-referrer" crossorigin="anonymous" onerror="this.src='${PLACEHOLDER_COVER}'">
              </div>
              <div class="card-body">
                <h4>${esc(s.song_name)}</h4>
                <p>${esc(s.singers || "Unknown artist")}</p>
              </div>
            </div>
          `).join("")}
        </div>
      `;
    }

    function getRecommendations() {
      const unique = new Map();
      const add = (s) => {
        if (!s || !s.id || unique.has(s.id)) return;
        unique.set(s.id, s);
      };
      const mostPlayed = Object.entries(playCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([id]) => songs.find(x => String(x.id) === String(id)) || cachedSongs.find(x => String(x.id) === String(id)))
        .filter(Boolean);
      mostPlayed.forEach(add);
      recent.slice(0, 10).forEach(add);
      liked.slice(0, 10).forEach(add);
      return Array.from(unique.values()).slice(0, 12);
    }

    function playById(id) {
      const idx = playlist.findIndex(s => String(s.id) === String(id));
      if (idx >= 0) return playSong(idx);
      const cachedIdx = cachedSongs.findIndex(s => String(s.id) === String(id));
      if (cachedIdx >= 0) {
        playlist = cachedSongs;
        return playSong(cachedIdx);
      }
    }

    function changePage(p) {
      if (p < 1) return;
      state.page = p;
      loadSongs();
    }

    function goPage() {
      const p = Number(pg.value);
      if (p > 0) changePage(p);
    }

    function playSong(i) {
      if (!playlist[i]) return;
      index = i;
      const s = playlist[i];
      const sources = resolveSources(s);
      if (!sources.length) {
        toast("Stream URL missing");
        return;
      }
      tryPlaySources(sources);
      updateUI(s);
      recent = [s, ...recent.filter(x => x.id !== s.id)].slice(0, 30);
      localStorage.setItem("recent", JSON.stringify(recent));
      playCounts[s.id] = (playCounts[s.id] || 0) + 1;
      localStorage.setItem("play_counts", JSON.stringify(playCounts));
      renderQueue();
      updateMediaSession(s);
      cacheQueue();
    }

    function updateUI(s, showPlayer = true) {
      const cover = s.cover_image || PLACEHOLDER_COVER;
      pCover.src = fCover.src = proxify(cover);
      previewCover.src = proxify(cover);
      pTitle.textContent = fTitle.textContent = s.song_name || "Untitled";
      previewTitle.textContent = s.song_name || "Untitled";
      currentArtist = s.singers || "Unknown artist";
      pArtist.textContent = currentArtist;
      fArtist.textContent = currentArtist;
      previewArtist.textContent = s.singers || "Unknown artist";
      if (showPlayer) player.style.display = "block";
      setPlayButtons(audio.paused ? "Play" : "Pause");
      applyThemeFromCover(s.cover_image || "");
    }

    const PLAY_SVG = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
    const PAUSE_SVG = '<svg viewBox="0 0 24 24"><path d="M6 5h4v14H6V5zm8 0h4v14h-4V5z"/></svg>';

    function setPlayButtons(label) {
      const isPlay = label === "Play";
      miniPlay.innerHTML = isPlay ? PLAY_SVG : PAUSE_SVG;
      fullPlay.innerHTML = isPlay ? PLAY_SVG : PAUSE_SVG;
    }

    function togglePlay() {
      if (!audio.src) return toast("Select a song first");
      if (audio.paused) audio.play();
      else audio.pause();
      if (audioCtx && audioCtx.state === "suspended") audioCtx.resume();
      setPlayButtons(audio.paused ? "Play" : "Pause");
    }

    function next() {
      if (!playlist.length) return;
      if (shuffle) {
        const nextIndex = Math.floor(Math.random() * playlist.length);
        return playSong(nextIndex);
      }
      playSong((index + 1) % playlist.length);
    }

    function prev() {
      if (!playlist.length) return;
      playSong((index - 1 + playlist.length) % playlist.length);
    }

    function queueNext(i) {
      if (!playlist[i]) return;
      const s = playlist.splice(i, 1)[0];
      playlist.splice(index + 1, 0, s);
      renderQueue();
      toast("Queued next");
    }

    audio.ontimeupdate = () => {
      if (!audio.duration) return;
      const p = audio.currentTime / audio.duration * 100;
      seek.value = fseek.value = p;
      cur.textContent = fcur.textContent = format(audio.currentTime);
      dur.textContent = fdur.textContent = format(audio.duration);
    };

    audio.onended = () => {
      if (repeat) return playSong(index);
      next();
    };

    audio.onerror = () => {
      if (currentSources.length && currentSourceIndex + 1 < currentSources.length) {
        currentSourceIndex += 1;
        tryPlaySources(currentSources.slice(currentSourceIndex));
      } else {
        toast("Audio error");
      }
    };

    audio.onplay = () => {
      fullPlayer.classList.add("now-playing");
      player.style.display = "block";
    };

    audio.onpause = () => {
      fullPlayer.classList.remove("now-playing");
    };

    seek.oninput = () => {
      if (!audio.duration) return;
      audio.currentTime = seek.value / 100 * audio.duration;
    };

    fseek.oninput = () => {
      if (!audio.duration) return;
      audio.currentTime = fseek.value / 100 * audio.duration;
    };

    if (waveform) {
      const seekAt = (clientX) => {
        const rect = waveform.getBoundingClientRect();
        const x = Math.min(Math.max(clientX - rect.left, 0), rect.width);
        const pct = x / rect.width;
        if (audio.duration) audio.currentTime = pct * audio.duration;
      };
      waveform.addEventListener("click", (e) => seekAt(e.clientX));
      waveform.addEventListener("touchstart", (e) => {
        if (e.touches[0]) seekAt(e.touches[0].clientX);
      }, { passive: true });
    }

    // Volume now controlled by system; no slider UI

    // Speed control moved to mini player only (cycleSpeed)

    function openFullPlayer(e) {
      if (e.target.tagName === "INPUT" || e.target.tagName === "BUTTON") return;
      fullPlayer.style.display = "block";
    }

    function closeFull() {
      fullPlayer.style.display = "none";
    }

    function renderQueue() {
      queue.innerHTML = playlist.map((s, i) => `
        <div class="queue-item ${i === index ? "active" : ""}" onclick="playSong(${i})">
          ${esc(s.song_name)}
        </div>
      `).join("");
    }

    function likeSong(i) {
      const s = songs[i];
      if (!s) return;
      liked = liked.some(x => x.id === s.id)
        ? liked.filter(x => x.id !== s.id)
        : [s, ...liked];
      localStorage.setItem("liked", JSON.stringify(liked));
      renderSongs();
      renderStats();
    }

    function showLiked() {
      songs = [...liked];
      playlist = songs;
      renderSongs();
      pagination.innerHTML = "";
      setActiveChip("Liked");
    }

    function showRecent() {
      songs = [...recent];
      playlist = songs;
      renderSongs();
      pagination.innerHTML = "";
      setActiveChip("Recent");
    }

    function addToPlaylist(i) {
      const name = prompt("Playlist name");
      if (!name) return;
      playlists[name] = playlists[name] || [];
      playlists[name].push(songs[i]);
      localStorage.setItem("playlists", JSON.stringify(playlists));
      toast("Added to playlist");
    }

    function showPlaylists() {
      const keys = Object.keys(playlists);
      if (!keys.length) {
        content.innerHTML = "<p>No playlists yet.</p>";
        pagination.innerHTML = "";
        return;
      }
      content.innerHTML = `
        <div class="grid">
          ${keys.map(n => `
            <div class="card" onclick="openPlaylist('${n.replace(/'/g, "\\'")}')">
              <div class="cover">
                <img src="${imgUrl("https://via.placeholder.com/400x400?text=Playlist")}" alt="playlist">
              </div>
              <div class="card-body">
                <h4>${esc(n)}</h4>
                <p>${playlists[n].length} songs</p>
              </div>
            </div>
          `).join("")}
        </div>
      `;
      pagination.innerHTML = "";
      setActiveChip("Playlists");
    }

    function openPlaylist(name) {
      songs = [...(playlists[name] || [])];
      playlist = songs;
      renderSongs();
    }

    async function showAlbums() {
      const { data, error } = await dbBouncer(() => db.from("songs").select("id,cover_image,movie_name,stream_url,download_128,download_320"));
      if (error) return toast("Error loading albums");
      const albums = {};
      (data || []).forEach(s => {
        if (s.movie_name) {
          albums[s.movie_name] = albums[s.movie_name] || [];
          albums[s.movie_name].push(s);
        }
      });
      content.innerHTML = `
        <div class="row-title">Albums</div>
        <div class="grid">
          ${Object.entries(albums).map(([n, t]) => `
            <div class="card">
              <div class="cover">
                <img src="${imgUrl((t[0] && t[0].cover_image) || PLACEHOLDER_COVER)}" alt="album" loading="lazy" decoding="async" referrerpolicy="no-referrer" crossorigin="anonymous" onerror="this.src='${PLACEHOLDER_COVER}'">
                <button onclick="playAlbum('${n.replace(/'/g, "\\'")}')"></button>
              </div>
              <div class="card-body">
                <h4>${esc(n)}</h4>
                <p>${t.length} songs</p>
                <div class="actions">
                  <button class="primary" onclick="openAlbum('${n.replace(/'/g, "\\'")}')">Open</button>
                  <button onclick="playAlbum('${n.replace(/'/g, "\\'")}')">Play</button>
                </div>
              </div>
            </div>
          `).join("")}
        </div>
      `;
      pagination.innerHTML = "";
      setActiveChip("Albums");
    }

    function openAlbum(name) {
      state.mode = "album";
      state.album = name;
      state.page = 1;
      loadSongs();
    }

    function playAlbum(name) {
      state.mode = "album";
      state.album = name;
      state.page = 1;
      loadSongs().then(() => {
        if (playlist.length) playSong(0);
      });
    }

    function downloadSong(i, rate) {
      const s = songs[i];
      const url = rate === 320 ? s.download_320 : s.download_128 || s.stream_url;
      if (!url) return toast("No download available");
      const a = document.createElement("a");
      a.href = url;
      a.download = (s.song_name || "track") + ".mp3";
      a.click();
    }

    function toggleMenu(e, i) {
      e.stopPropagation();
      document.querySelectorAll(".menu").forEach(m => m.style.display = "none");
      const menu = document.getElementById("menu" + i);
      if (!menu) return;
      const rect = e.currentTarget.getBoundingClientRect();
      menu.style.left = Math.min(rect.left, window.innerWidth - 190) + "px";
      menu.style.top = rect.bottom + 8 + "px";
      menu.style.display = "block";
    }

    document.addEventListener("click", () => {
      document.querySelectorAll(".menu").forEach(m => m.style.display = "none");
    });

    window.addEventListener("scroll", () => {
      document.querySelectorAll(".menu").forEach(m => m.style.display = "none");
    });

    function format(t) {
      const m = Math.floor(t / 60);
      const s = Math.floor(t % 60).toString().padStart(2, "0");
      return m + ":" + s;
    }

    function toggleShuffle() {
      shuffle = !shuffle;
      updateIconToggles();
    }

    function toggleRepeat() {
      repeat = !repeat;
      updateIconToggles();
    }

    function resolveSources(s) {
      const sources = [s.stream_url, s.download_320, s.download_128]
        .filter(Boolean)
        .map(normalizeUrl)
        .map(proxify);
      return sources.filter(Boolean);
    }

    function normalizeUrl(url) {
      if (!url) return "";
      try {
        if (url.includes(" ")) return encodeURI(url);
        return url;
      } catch {
        return url;
      }
    }

    function proxify(url) {
      if (!url) return "";
      if (url.startsWith(PROXY)) return url;
      if (url.startsWith("http")) return PROXY + encodeURIComponent(url);
      return url;
    }

    function tryPlaySources(list) {
      let idx = 0;
      currentSources = list.slice();
      currentSourceIndex = 0;
      const attempt = () => {
        if (idx >= list.length) return toast("No playable source");
        audio.src = list[idx];
        audio.load();
        audio.play().then(() => {
          if (audioCtx && audioCtx.state === "suspended") audioCtx.resume();
          startVisualizer();
          startWaveform();
          setPlayButtons("Pause");
          fullPlayer.classList.add("now-playing");
        }).catch(() => {
          idx += 1;
          currentSourceIndex = idx;
          attempt();
        });
      };
      attempt();
    }

    function ensureAudioGraph() {
      audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
      if (!sourceNode) {
        sourceNode = audioCtx.createMediaElementSource(audio);
      }
      if (!eqFilters.length) {
        const freqs = [60, 170, 350, 1000, 3500];
        eqFilters = freqs.map(freq => {
          const f = audioCtx.createBiquadFilter();
          f.type = "peaking";
          f.frequency.value = freq;
          f.Q.value = 1;
          f.gain.value = 0;
          return f;
        });
      }
      boostNode = boostNode || audioCtx.createGain();
      boostNode.gain.value = Number(audio.dataset.boost || "1");
      analyser = analyser || audioCtx.createAnalyser();
      analyser.fftSize = 128;

      sourceNode.disconnect();
      eqFilters.forEach(f => f.disconnect());
      boostNode.disconnect();
      analyser.disconnect();

      sourceNode.connect(eqFilters[0]);
      for (let i = 0; i < eqFilters.length - 1; i++) {
        eqFilters[i].connect(eqFilters[i + 1]);
      }
      eqFilters[eqFilters.length - 1].connect(boostNode);
      boostNode.connect(analyser);
      analyser.connect(audioCtx.destination);
    }

    function startWaveform() {
      if (!waveform) return;
      ensureAudioGraph();
      const ctx = waveform.getContext("2d");
      const buffer = new Uint8Array(analyser.frequencyBinCount);
      const draw = () => {
        if (!waveform) return;
        requestAnimationFrame(draw);
        analyser.getByteFrequencyData(buffer);
        const w = waveform.clientWidth;
        const h = waveform.clientHeight;
        waveform.width = w;
        waveform.height = h;
        ctx.clearRect(0, 0, w, h);
        const barWidth = w / buffer.length;
        for (let i = 0; i < buffer.length; i++) {
          const val = buffer[i] / 255;
          const barHeight = val * h;
          ctx.fillStyle = "rgba(255,255,255,0.35)";
          ctx.fillRect(i * barWidth, h - barHeight, barWidth - 1, barHeight);
        }
        if (audio.duration) {
          const prog = (audio.currentTime / audio.duration) * w;
          ctx.fillStyle = "rgba(29,185,84,0.6)";
          ctx.fillRect(0, 0, prog, h);
        }
      };
      draw();
    }

    function cacheSongs(data) {
      cachedSongs = (data || []).slice(0, 100);
      localStorage.setItem("cache_songs", JSON.stringify(cachedSongs));
      cachedAt = Date.now();
      localStorage.setItem("cache_songs_at", String(cachedAt));
    }

    function cacheQueue() {
      localStorage.setItem("queue_cache", JSON.stringify(playlist.slice(0, 100)));
      localStorage.setItem("queue_index", String(index));
    }

    function restoreQueue() {
      if (!cachedQueue.length) return;
      playlist = cachedQueue;
      index = cachedIndex >= 0 ? cachedIndex : -1;
      if (playlist[index]) updateUI(playlist[index], false);
      renderQueue();
    }

    function startVisualizer() {
      if (vizRunning) return;
      const canvas = document.getElementById("visualizer");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      ensureAudioGraph();
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      vizRunning = true;

      const draw = () => {
        if (!vizRunning) return;
        requestAnimationFrame(draw);
        analyser.getByteFrequencyData(dataArray);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const width = canvas.clientWidth;
        const height = canvas.clientHeight;
        canvas.width = width;
        canvas.height = height;
        const barWidth = width / bufferLength;
        for (let i = 0; i < bufferLength; i++) {
          const value = dataArray[i] / 255;
          const barHeight = value * height;
          ctx.fillStyle = i % 2 === 0 ? "#1db954" : "#1ed760";
          ctx.fillRect(i * barWidth, height - barHeight, barWidth - 2, barHeight);
        }
      };
      draw();
    }

    function updateMediaSession(s) {
      if (!("mediaSession" in navigator)) return;
      navigator.mediaSession.metadata = new MediaMetadata({
        title: s.song_name || "Song",
        artist: s.singers || "Artist",
        album: s.movie_name || "Album",
        artwork: [{ src: proxify(s.cover_image || ""), sizes: "512x512", type: "image/jpeg" }]
      });
      navigator.mediaSession.setActionHandler("previoustrack", prev);
      navigator.mediaSession.setActionHandler("nexttrack", next);
      navigator.mediaSession.setActionHandler("play", () => audio.play());
      navigator.mediaSession.setActionHandler("pause", () => audio.pause());
    }

    function updateIconToggles() {
      const sh = shuffle;
      const rp = repeat;
      [miniShuffle, fullShuffle].forEach(el => el && el.classList.toggle("active", sh));
      [miniRepeat, fullRepeat].forEach(el => el && el.classList.toggle("active", rp));
    }

    function cycleSpeed() {
      const speeds = [0.75, 1, 1.25, 1.5];
      const cur = audio.playbackRate || 1;
      const idx = speeds.indexOf(cur);
      const nextSpeed = speeds[(idx + 1) % speeds.length];
      audio.playbackRate = nextSpeed;
      toast("Speed " + nextSpeed + "x");
    }

    function downloadCurrent(rate) {
      if (index < 0 || !playlist[index]) return toast("Select a song first");
      const s = playlist[index];
      const url = rate === 320 ? s.download_320 : s.download_128 || s.stream_url;
      if (!url) return toast("No download available");
      const a = document.createElement("a");
      a.href = url;
      a.download = (s.song_name || "track") + ".mp3";
      a.click();
    }

    function initGestures() {
      let startX = 0;
      let startY = 0;
      let active = false;
      player.addEventListener("pointerdown", (e) => {
        active = true;
        startX = e.clientX;
        startY = e.clientY;
      });
      player.addEventListener("pointerup", (e) => {
        if (!active) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        active = false;
        if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 40) {
          if (dx > 0) next();
          else prev();
          return;
        }
        if (dy < -40) {
          fullPlayer.style.display = "block";
        }
      });
    }

    function toggleSettingsMenu() {
      settingsMenu.style.display = settingsMenu.style.display === "block" ? "none" : "block";
    }

    function setVolumeBoost(value) {
      const gain = Number(value);
      if (Number.isNaN(gain)) return;
      audio.dataset.boost = String(gain);
      try { ensureAudioGraph(); } catch {}
      if (boostNode) boostNode.gain.value = gain;
      toast(gain > 1 ? "Volume Boost On" : "Volume Boost Off");
      settingsMenu.style.display = "none";
    }

    function setVisualizer(value) {
      const on = value === "on";
      const canvas = document.getElementById("visualizer");
      if (!canvas) return;
      canvas.style.display = on ? "block" : "none";
      if (on) startVisualizer();
      else vizRunning = false;
      settingsMenu.style.display = "none";
    }

    function openArtistFromNowPlaying() {
      if (!currentArtist) return;
      openArtist(currentArtist);
    }

    async function openArtist(name) {
      artistName.textContent = name;
      artistModal.style.display = "block";
      const local = songs.filter(s => (s.singers || "").toLowerCase().includes(name.toLowerCase()));
      let list = local;
      if (list.length < 5) {
        try {
          const { data } = await dbBouncer(() => db.from("songs").select("id,song_name,singers,cover_image,stream_url,download_128,download_320").ilike("singers", `%${name}%`).limit(20));
          list = data || local;
        } catch {
          list = local;
        }
      }
      const sorted = list.sort((a, b) => (playCounts[b.id] || 0) - (playCounts[a.id] || 0));
      artistList.innerHTML = sorted.slice(0, 12).map(s => `
        <div class="artist-item">
          <div>
            <div class="mini-title">${esc(s.song_name)}</div>
            <div class="mini-artist">${esc(s.singers || "")}</div>
          </div>
          <button class="chip" onclick="playById('${s.id}')">Play</button>
        </div>
      `).join("");
    }

    function closeArtist() {
      artistModal.style.display = "none";
    }

    function openSleepTimer() {
      const mins = Number(prompt("Sleep timer (minutes). Enter 0 to cancel.", "15"));
      if (Number.isNaN(mins)) return;
      if (mins <= 0) {
        if (sleepTimerId) clearTimeout(sleepTimerId);
        sleepTimerId = null;
        sleepEndsAt = 0;
        toast("Sleep timer canceled");
        return;
      }
      if (sleepTimerId) clearTimeout(sleepTimerId);
      sleepEndsAt = Date.now() + mins * 60000;
      sleepTimerId = setTimeout(() => {
        audio.pause();
        toast("Sleep timer ended");
      }, mins * 60000);
      toast("Sleep timer: " + mins + " min");
    }

    async function saveOfflineCurrent() {
      if (index < 0 || !playlist[index]) return toast("Select a song first");
      const s = playlist[index];
      const url = s.download_320 || s.download_128 || s.stream_url;
      if (!url) return toast("No URL to save");
      try {
        const cache = await caches.open("playersac-audio");
        const proxied = proxify(url);
        const resp = await fetch(proxied, { mode: "no-cors" });
        await cache.put(proxied, resp.clone());
        toast("Saved offline");
      } catch {
        toast("Offline save failed");
      }
    }

    function saveOfflineSong(i) {
      if (!songs[i]) return;
      const s = songs[i];
      playlist = songs;
      index = i;
      saveOfflineCurrent();
    }

    player.style.display = "none";
    loadCategories();
    navAll();
    restoreQueue();
    buildEqUI();
    updateIconToggles();
    initGestures();
    eqRow.style.display = "none";
    if (presetSelect) presetSelect.value = activePreset;
    if (boostSelect) boostSelect.value = "1";
    if (vizSelect) vizSelect.value = "on";

    artistModal.addEventListener("click", (e) => {
      if (e.target === artistModal) closeArtist();
    });

    document.addEventListener("click", (e) => {
      if (settingsMenu.style.display === "block") {
        const isButton = e.target.closest(".settings-btn");
        const isMenu = e.target.closest("#settingsMenu");
        if (!isButton && !isMenu) settingsMenu.style.display = "none";
      }
    });

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("Playersac.sw.js").catch(() => {});
      });
    }
  </script>
</body>
</html>
